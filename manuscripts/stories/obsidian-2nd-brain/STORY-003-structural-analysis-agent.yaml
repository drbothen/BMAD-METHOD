---
story_id: STORY-003
title: Implement Structural Analysis Agent
epic_id: EPIC-001
phase: 1
priority: critical
estimated_effort: 20 hours
status: todo
created: 2025-11-04

user_story: |
  As a knowledge worker
  I want an AI agent to analyze my notes for atomicity and fragment them when needed
  So that each note contains exactly one complete knowledge building block

acceptance_criteria:
  - "AC1: Create structural-analysis-agent.md with complete agent definition at expansion-packs/bmad-obsidian-2nd-brain/agents/"
  - "AC2: Agent analyzes notes for atomicity (single concept, argument, model, question, claim, or phenomenon)"
  - "AC3: Agent identifies building block type for each note (6 types)"
  - "AC4: Agent detects when notes violate atomicity (multiple tangled ideas)"
  - "AC5: Agent suggests fragmentation strategy (split into N atomic notes)"
  - "AC6: Agent performs fragmentation and creates new atomic notes using atomic-note-tmpl.yaml"
  - "AC7: Agent follows atomicity-checklist.md before finalizing fragmentation"
  - "AC8: All fragments maintain source attribution and metadata"
  - "AC9: Atomicity detection accuracy >= 90% on test set"
  - "AC10: Commands implemented: *help, *analyze-atomicity, *fragment-note, *validate-note, *yolo, *exit"

tasks_subtasks: |
  - [ ] Task 1: Create agent file skeleton with YAML metadata (AC1)
    - [ ] Navigate to expansion-packs/bmad-obsidian-2nd-brain/agents/
    - [ ] Create file: structural-analysis-agent.md
    - [ ] Add BMAD header: <!-- Powered by BMADâ„¢ Core -->
    - [ ] Add activation notice section
    - [ ] Add YAML metadata block structure with agent definition
    - [ ] Add agent.name: Structure
    - [ ] Add agent.id: structural-analysis-agent
    - [ ] Add agent.title: Structural Analysis Agent
    - [ ] Add agent.icon: ðŸ§¬
    - [ ] Add agent.whenToUse description
    - [ ] Add persona section (role, style, identity, focus)
    - [ ] Add core_principles list
    - [ ] Add commands section with all 6 commands
    - [ ] Add dependencies section placeholder (populate in Task 8)
    - [ ] Add startup context section after YAML block
    - [ ] Verify YAML syntax is valid

  - [ ] Task 2: Create atomic note template (AC6)
    - [ ] Create file: expansion-packs/bmad-obsidian-2nd-brain/templates/atomic-note-tmpl.yaml
    - [ ] Define template metadata:
      - [ ] template.id: atomic-note-template-v1
      - [ ] template.name: Atomic Note
      - [ ] template.version: 1.0
      - [ ] template.output.format: markdown
    - [ ] Define template sections:
      - [ ] Frontmatter (YAML): title, type, building_block, source_note, created, tags, atomic_score
      - [ ] Content section: Main note content
      - [ ] Related Concepts section: Links to related atomic notes
      - [ ] Source Attribution section: Original source info
      - [ ] Metadata section: Fragmentation metadata
    - [ ] Add template variables list and descriptions
    - [ ] Add 3 complete examples (concept, argument, model)
    - [ ] Reference bmad-core templates for structure guidance

  - [ ] Task 3: Create atomicity checklist (AC7)
    - [ ] Create file: expansion-packs/bmad-obsidian-2nd-brain/checklists/atomicity-checklist.md
    - [ ] Define atomicity quality criteria:
      - [ ] Single claim test: Note expresses exactly one claim/concept
      - [ ] Evidence test: Evidence supports core claim without introducing new claims
      - [ ] Self-contained test: Note understandable without extensive external context
      - [ ] Title test: Title is descriptive and unique
      - [ ] Related concepts test: Related concepts linked but not explained in detail
      - [ ] Building block test: Clear identification of building block type
      - [ ] Completeness test: Note contains complete thought (not fragment)
      - [ ] Independence test: Note can be moved/reorganized without breaking system
      - [ ] Link quality test: Links are bidirectional and meaningful
      - [ ] Metadata test: All required metadata present
    - [ ] Add remediation steps for each failed check
    - [ ] Add scoring algorithm (0.0-1.0 scale)
    - [ ] Add pass threshold: >= 0.7 for atomic classification

  - [ ] Task 4: Create building block taxonomy (AC3)
    - [ ] Create file: expansion-packs/bmad-obsidian-2nd-brain/data/building-block-types.md
    - [ ] Define each of 6 building block types with:
      - [ ] **Concept** - Definition or explanation of an idea, term, or principle
        - [ ] Characteristics and signals
        - [ ] 5 example snippets
        - [ ] Common structures
      - [ ] **Argument** - Claim supported by evidence and reasoning
        - [ ] Characteristics: thesis + evidence + logic
        - [ ] 5 example snippets
        - [ ] Common structures
      - [ ] **Model** - Framework, system, or mental model for understanding
        - [ ] Characteristics: components + relationships + boundaries
        - [ ] 5 example snippets
        - [ ] Common structures
      - [ ] **Question** - Open question, area of inquiry, or research direction
        - [ ] Characteristics: interrogative + context + significance
        - [ ] 5 example snippets
        - [ ] Common structures
      - [ ] **Claim** - Statement of belief, assertion, or hypothesis
        - [ ] Characteristics: declarative + falsifiable + scoped
        - [ ] 5 example snippets
        - [ ] Common structures
      - [ ] **Phenomenon** - Observed pattern, occurrence, or empirical finding
        - [ ] Characteristics: empirical + repeatable + documented
        - [ ] 5 example snippets
        - [ ] Common structures
    - [ ] Add decision tree for disambiguation
    - [ ] Add edge cases and handling strategies

  - [ ] Task 5: Implement atomicity analysis algorithm (AC2, AC4, AC9)
    - [ ] Create file: expansion-packs/bmad-obsidian-2nd-brain/tasks/analyze-atomicity.md
    - [ ] Add task header with purpose and inputs/outputs
    - [ ] Implement 5 atomicity tests:
      - [ ] **Single Claim Test**:
        - [ ] Extract all claims/assertions from note
        - [ ] Count distinct claims (1 = pass, 2+ = fail)
        - [ ] Check if additional claims are supporting evidence vs new ideas
        - [ ] Score: 1.0 if single claim, -0.3 per additional independent claim
      - [ ] **Evidence Test**:
        - [ ] Identify core claim/concept
        - [ ] Extract supporting statements
        - [ ] Check if support introduces new claims requiring explanation
        - [ ] Score: 1.0 if all support relates to core, -0.3 per divergent idea
      - [ ] **Self-Contained Test**:
        - [ ] Check for undefined terms requiring other notes to understand
        - [ ] Check for assumed context not present in note
        - [ ] Score: 1.0 if self-contained, -0.2 per missing context element
      - [ ] **Title Test**:
        - [ ] Verify title describes core claim/concept
        - [ ] Check title uniqueness (no duplicate titles in vault)
        - [ ] Score: 1.0 if descriptive+unique, -0.4 if fails either
      - [ ] **Related Concepts Test**:
        - [ ] Identify related concepts mentioned in note
        - [ ] Check if concepts are linked vs explained
        - [ ] Score: 1.0 if linked only, -0.3 per in-depth explanation
    - [ ] Implement composite atomicity score:
      - [ ] Start at 1.0 (perfect atomicity)
      - [ ] Apply deductions from each test
      - [ ] Clamp to 0.0-1.0 range
      - [ ] is_atomic = (score >= 0.7)
    - [ ] Add violation detection: return list of failed tests
    - [ ] Add output format: {is_atomic: bool, score: float, violations: [string], suggestions: [string]}
    - [ ] Reference data/building-block-types.md for type patterns

  - [ ] Task 6: Implement fragmentation strategy algorithm (AC5)
    - [ ] Create file: expansion-packs/bmad-obsidian-2nd-brain/tasks/fragment-note.md
    - [ ] Add task header with purpose and inputs/outputs
    - [ ] Implement fragmentation planning algorithm:
      - [ ] **Boundary Detection**:
        - [ ] Identify natural boundaries (paragraph breaks, section headings)
        - [ ] Identify semantic boundaries (topic shifts, new claims)
        - [ ] Score each boundary for "splitability" (0.0-1.0)
      - [ ] **Claim Clustering**:
        - [ ] Extract all distinct claims from note
        - [ ] Cluster related claims (supporting evidence groups with core claim)
        - [ ] Assign cluster IDs (C1, C2, C3...)
      - [ ] **Split Point Selection**:
        - [ ] Propose split points between clusters
        - [ ] Validate each fragment would be atomic (run analyze-atomicity)
        - [ ] Adjust boundaries if fragments still non-atomic
      - [ ] **Fragment Count Determination**:
        - [ ] N = number of clusters
        - [ ] Validate N is reasonable (2-10 fragments, warn if >10)
    - [ ] Implement fragmentation execution:
      - [ ] Create N new notes using atomic-note-tmpl.yaml
      - [ ] Populate each fragment with cluster content
      - [ ] Preserve source attribution in all fragments
      - [ ] Generate descriptive titles for each fragment
    - [ ] Implement cross-linking strategy:
      - [ ] Create bidirectional links between all fragments
      - [ ] Add "Fragmented from: [[original-note]]" in each fragment
      - [ ] Add "Fragmented into: [[frag-1]], [[frag-2]], [[frag-3]]" in original
      - [ ] Create semantic links for conceptual relationships
    - [ ] Add output format: {fragments_created: int, paths: [string], links_added: int}

  - [ ] Task 7: Create Obsidian MCP integration task (AC6)
    - [ ] Create file: expansion-packs/bmad-obsidian-2nd-brain/tasks/create-atomic-note.md
    - [ ] Define steps for Obsidian MCP Tools integration:
      - [ ] Load atomic-note-tmpl.yaml template
      - [ ] Substitute variables: {{title}}, {{type}}, {{building_block}}, {{content}}, {{source_note}}, {{tags}}
      - [ ] Generate filename: YYYY-MM-DD-{sanitized-title}.md
      - [ ] Determine target directory based on note type:
        - [ ] Concepts â†’ /atomic/concepts/
        - [ ] Arguments â†’ /atomic/arguments/
        - [ ] Models â†’ /atomic/models/
        - [ ] Questions â†’ /atomic/questions/
        - [ ] Claims â†’ /atomic/claims/
        - [ ] Phenomena â†’ /atomic/phenomena/
      - [ ] Call Obsidian MCP Tools: create_note(path={dir}/{filename}, content={filled_template})
      - [ ] Handle errors: vault not found, permission denied, file exists
      - [ ] Return: {success: boolean, note_path: string, error: string|null}
    - [ ] Add retry logic: 3 attempts with exponential backoff
    - [ ] Add collision handling: append -2, -3 until unique filename
    - [ ] Add validation: verify note created successfully before returning

  - [ ] Task 8: Implement agent commands and populate dependencies (AC10)
    - [ ] In structural-analysis-agent.md, add command implementations in Startup Context:
      - [ ] *help: List all commands with descriptions
      - [ ] *analyze-atomicity {note_path}: Analyze note for atomicity, return score and violations
      - [ ] *fragment-note {note_path}: Fragment non-atomic note into atomic pieces
      - [ ] *validate-note {note_path}: Run full atomicity checklist, return pass/fail
      - [ ] *yolo: Toggle yolo mode (auto-fragment without confirmation, default: false)
      - [ ] *exit: Exit agent mode with confirmation
    - [ ] Define command parameters and return values
    - [ ] Add error handling for invalid inputs
    - [ ] Populate agent file dependencies section with created files:
      - [ ] tasks: analyze-atomicity.md, fragment-note.md, create-atomic-note.md
      - [ ] templates: atomic-note-tmpl.yaml
      - [ ] checklists: atomicity-checklist.md
      - [ ] data: building-block-types.md

  - [ ] Task 9: Add security hardening
    - [ ] In fragment-note.md task, add security section:
      - [ ] Input validation: sanitize all note paths and content
      - [ ] Path safety: validate paths are within vault, block directory traversal (../)
      - [ ] Fragment limit: max 20 fragments per note to prevent DoS
      - [ ] Content validation: verify content is valid markdown
      - [ ] Filename sanitization: remove special characters, limit length to 100 chars
      - [ ] Link injection prevention: validate all generated links are safe
    - [ ] Add security checklist item to atomicity-checklist.md

  - [ ] Task 10: Testing and validation (AC9, definition_of_done)
    - [ ] Create test data set:
      - [ ] 10 atomic notes (various building block types) - Should pass validation
      - [ ] 10 non-atomic notes (multiple tangled ideas) - Should detect violations
      - [ ] 5 edge cases: very short notes, very long notes, notes with complex linking
    - [ ] Run atomicity analysis on test set:
      - [ ] Verify accuracy >= 90% (23/25 correct atomic/non-atomic classifications)
      - [ ] Verify atomicity scores align with human judgment
      - [ ] Verify violation detection identifies actual problems
    - [ ] Test fragmentation:
      - [ ] Fragment 5 non-atomic notes
      - [ ] Verify all fragments pass atomicity validation (score >= 0.7)
      - [ ] Verify source attribution preserved in all fragments
      - [ ] Verify cross-links created between all fragments
      - [ ] Verify original note marked as fragmented
    - [ ] Test Obsidian integration:
      - [ ] Create 10 atomic notes via MCP Tools in appropriate directories
      - [ ] Verify notes appear in correct vault locations
      - [ ] Verify frontmatter populated correctly
      - [ ] Verify filenames follow convention
    - [ ] Test building block type identification:
      - [ ] Classify 30 notes (5 per building block type)
      - [ ] Verify type identification accuracy >= 85%
    - [ ] Test error scenarios:
      - [ ] Obsidian vault not found - expect graceful error
      - [ ] Invalid note path - expect validation error
      - [ ] Note already atomic - expect skip with message
      - [ ] Fragment limit exceeded (>20) - expect warning
    - [ ] Run atomicity-checklist.md on 10 random results
    - [ ] Document all test results in Dev Agent Record

  - [ ] Task 11: Integration verification (definition_of_done)
    - [ ] Verify agent activates via: /bmad-2b:structural-analysis-agent
    - [ ] Test in Claude Desktop or Cursor with MCP Tools configured
    - [ ] Run *help command, verify all commands listed
    - [ ] Analyze sample note end-to-end
    - [ ] Fragment sample non-atomic note end-to-end
    - [ ] Verify all acceptance criteria met
    - [ ] Add usage documentation to expansion pack README.md
    - [ ] Update CHANGELOG.md with agent addition

dev_notes: |
  ## Project Context

  This is a **GREENFIELD** story creating the SECOND agent for the bmad-obsidian-2nd-brain expansion pack. The expansion pack infrastructure (STORY-001) and Inbox Triage Agent (STORY-002) must be completed before this story can begin.

  **Expansion Pack Location:** `/Users/jmagady/Dev/BMAD-METHOD/expansion-packs/bmad-obsidian-2nd-brain/`

  **Agent File Location:** `expansion-packs/bmad-obsidian-2nd-brain/agents/structural-analysis-agent.md`

  ## Agent Definition Structure (CRITICAL)

  **Reference Example Agent:** `/Users/jmagady/Dev/BMAD-METHOD/expansion-packs/bmad-obsidian-2nd-brain/agents/inbox-triage-agent.md`

  **Agent File Structure:**

  ```markdown
  <!-- Powered by BMADâ„¢ Core -->

  # structural-analysis-agent

  ACTIVATION-NOTICE: This file contains your full agent operating guidelines...

  CRITICAL: Read the full YAML BLOCK that FOLLOWS IN THIS FILE...

  ## COMPLETE AGENT DEFINITION FOLLOWS - NO EXTERNAL FILES NEEDED

  ```yaml
  IDE-FILE-RESOLUTION:
    - FOR LATER USE ONLY - NOT FOR ACTIVATION...
    - Dependencies map to {root}/{type}/{name}
    - type=folder (tasks|templates|checklists|data)
    - Example: analyze-atomicity.md â†’ {root}/tasks/analyze-atomicity.md

  REQUEST-RESOLUTION: Match user requests to your commands/dependencies flexibly...

  activation-instructions:
    - STEP 1: Read THIS ENTIRE FILE
    - STEP 2: Adopt the persona defined below
    - STEP 3: Greet user with name/role and mention `*help` command
    - DO NOT: Load any other agent files during activation
    - ONLY load dependency files when user selects them for execution
    - STAY IN CHARACTER!
    - CRITICAL: On activation, ONLY greet user and then HALT

  agent:
    name: Structure
    id: structural-analysis-agent
    title: Structural Analysis Agent
    icon: ðŸ§¬
    whenToUse: Use for analyzing note atomicity, detecting fragmentation needs, and breaking complex notes into atomic building blocks
    customization: null

  persona:
    role: Knowledge Structure Analyst & Atomicity Enforcer
    style: Analytical, precise, systematic, quality-focused
    identity: Guardian of atomic note principles and knowledge building blocks
    focus: Single-concept notes, clean fragmentation, bidirectional linking

  core_principles:
    - One concept per note - enforce atomicity rigorously
    - Building blocks over monoliths - break down complex into simple
    - Preserve provenance - source attribution is sacred
    - Bidirectional linking - fragments must reference each other
    - Quality gates - validate atomicity before accepting notes
    - Semantic coherence - fragments must make sense independently
    - Graceful fragmentation - split at natural boundaries

  commands:
    - '*help - Show available commands'
    - '*analyze-atomicity {note_path} - Analyze note for atomicity violations'
    - '*fragment-note {note_path} - Fragment non-atomic note into atomic pieces'
    - '*validate-note {note_path} - Run full atomicity checklist'
    - '*yolo - Toggle Yolo Mode (auto-fragment without confirmation)'
    - '*exit - Exit agent mode'

  dependencies:
    tasks:
      - analyze-atomicity.md
      - fragment-note.md
      - create-atomic-note.md
    templates:
      - atomic-note-tmpl.yaml
    checklists:
      - atomicity-checklist.md
    data:
      - building-block-types.md
  ```

  ## Startup Context

  You are **Structure**, the guardian of atomic note principles.

  Your mission: Ensure every note contains exactly one complete knowledge building block
  that can stand alone and be recombined in unlimited ways.

  Focus on:
  - **Atomicity analysis** - detect when notes violate single-concept principle
  - **Building block identification** - classify notes by type (concept, argument, model, question, claim, phenomenon)
  - **Fragmentation planning** - identify natural split points in complex notes
  - **Clean separation** - create atomic fragments that are self-contained
  - **Bidirectional linking** - connect fragments meaningfully

  Remember: Atomic notes are the foundation of a powerful second brain. Garbage in, garbage out.
  ```

  ## Atomicity Analysis Algorithm (CRITICAL)

  **Purpose:** Determine if a note contains exactly one atomic knowledge building block.

  **Five Atomicity Tests:**

  ### 1. Single Claim Test

  **Algorithm:**
  ```
  1. Extract all claims/assertions from note
     - Use NLP to identify declarative statements
     - Identify claims that could stand as thesis statements
  2. Count distinct independent claims
     - Claim is independent if it requires separate explanation
     - Supporting evidence does NOT count as separate claim
  3. Scoring:
     - 1.0 if exactly 1 core claim
     - -0.3 per additional independent claim
     - Min score: 0.0

  Example PASS:
  "Zettelkasten uses atomic notes. Atomic notes contain one idea. This enables flexible recombination."
  â†’ 1 core claim (Zettelkasten uses atomic notes) + supporting details âœ“

  Example FAIL:
  "Zettelkasten uses atomic notes. GTD uses context lists. Both are productivity systems."
  â†’ 3 independent claims âœ—
  ```

  ### 2. Evidence Test

  **Algorithm:**
  ```
  1. Identify core claim/concept in note
  2. Extract all supporting statements
  3. For each supporting statement:
     - Check: Does it directly support the core claim?
     - Check: Does it introduce NEW claims requiring explanation?
  4. Scoring:
     - 1.0 if all support relates to core claim
     - -0.3 per divergent idea requiring separate explanation
     - Min score: 0.0

  Example PASS:
  Core: "Spaced repetition improves retention"
  Support: "Ebbinghaus curve shows memory decay" âœ“
  Support: "Multiple exposures strengthen neural pathways" âœ“
  â†’ All support directly relates to core claim

  Example FAIL:
  Core: "Spaced repetition improves retention"
  Support: "Ebbinghaus discovered forgetting curve in 1885"
  Support: "Anki is better than SuperMemo for this"
  â†’ Second support introduces tool comparison (separate topic) âœ—
  ```

  ### 3. Self-Contained Test

  **Algorithm:**
  ```
  1. Identify all terms/concepts mentioned in note
  2. For each term:
     - Check: Is term defined or self-explanatory?
     - Check: Does understanding require reading other notes?
  3. Check for assumed context:
     - Background knowledge not stated in note
     - References to prior discussions without summary
  4. Scoring:
     - 1.0 if note is fully self-contained
     - -0.2 per undefined critical term
     - -0.2 per assumed context element
     - Min score: 0.0

  Example PASS:
  "The PARA method organizes information into Projects, Areas, Resources, Archives.
   Projects are active work with deadlines. Areas are ongoing responsibilities."
  â†’ Defines all terms used âœ“

  Example FAIL:
  "Using the P.A.R.A. categories, my project list is getting cleaner."
  â†’ Assumes knowledge of PARA, doesn't define âœ—
  ```

  ### 4. Title Test

  **Algorithm:**
  ```
  1. Descriptiveness check:
     - Does title indicate core claim/concept?
     - Is title specific (not generic)?
  2. Uniqueness check:
     - Search vault for duplicate titles
     - Check for similar titles causing confusion
  3. Scoring:
     - 1.0 if descriptive AND unique
     - -0.4 if not descriptive
     - -0.4 if not unique
     - Min score: 0.0

  Example PASS:
  Title: "Zettelkasten Principle: Atomicity"
  Content: Explains atomic notes concept
  â†’ Descriptive + Unique âœ“

  Example FAIL:
  Title: "Notes on Productivity"
  Content: Discusses 5 different productivity concepts
  â†’ Too generic, not descriptive âœ—
  ```

  ### 5. Related Concepts Test

  **Algorithm:**
  ```
  1. Identify related concepts mentioned in note
  2. For each related concept:
     - Check: Is it just linked [[concept]] or explained in-depth?
     - Check: Does explanation exceed 2 sentences?
  3. Scoring:
     - 1.0 if all related concepts are linked only
     - -0.3 per in-depth explanation (>2 sentences)
     - Min score: 0.0

  Example PASS:
  "Atomic notes enable flexible linking. See also [[Bidirectional Links]] and [[Evergreen Notes]]."
  â†’ Related concepts are linked but not explained âœ“

  Example FAIL:
  "Atomic notes enable flexible linking. Bidirectional links connect notes in both directions,
   creating a web of knowledge. Each link represents a semantic relationship..."
  â†’ Explains bidirectional links in depth (separate topic) âœ—
  ```

  ### Composite Atomicity Score

  **Algorithm:**
  ```python
  score = 1.0  # Start with perfect atomicity

  score += single_claim_deduction    # -0.3 per extra claim
  score += evidence_deduction        # -0.3 per divergent idea
  score += self_contained_deduction  # -0.2 per undefined term
  score += title_deduction           # -0.4 if not descriptive/unique
  score += related_concepts_deduction # -0.3 per in-depth explanation

  score = max(0.0, min(1.0, score))  # Clamp to [0.0, 1.0]

  is_atomic = (score >= 0.7)
  ```

  **Violation Detection:**
  - Return list of failed tests (score < 1.0 for that test)
  - Include specific suggestions for remediation
  - Flag for manual review if borderline (0.6 <= score < 0.7)

  **Output Format:**
  ```yaml
  is_atomic: boolean
  score: float (0.0-1.0)
  violations: [string]  # List of failed test names
  suggestions: [string]  # Specific remediation suggestions
  building_block_type: string  # concept|argument|model|question|claim|phenomenon
  ```

  ## Building Block Type Definitions (6 Types)

  **Purpose:** Classify atomic notes by their knowledge structure.

  ### 1. Concept
  **Definition:** Explanation of an idea, term, or principle
  **Structure:** Definition + Characteristics + Examples
  **Signals:** "is defined as", "refers to", "means that"
  **Example:** "Zettelkasten Principle: Atomicity"

  ### 2. Argument
  **Definition:** Claim supported by evidence and reasoning
  **Structure:** Thesis + Evidence + Logic
  **Signals:** "therefore", "because", "this shows that"
  **Example:** "Spaced repetition is superior to massed practice"

  ### 3. Model
  **Definition:** Framework, system, or mental model
  **Structure:** Components + Relationships + Boundaries
  **Signals:** "consists of", "framework", "system"
  **Example:** "PARA Method for Information Organization"

  ### 4. Question
  **Definition:** Open question or area of inquiry
  **Structure:** Question + Context + Significance
  **Signals:** "?", "how", "why", "what if"
  **Example:** "How does bi-temporal versioning differ from event sourcing?"

  ### 5. Claim
  **Definition:** Statement of belief, assertion, or hypothesis
  **Structure:** Declarative statement + Scope + Falsifiability
  **Signals:** "I believe", "hypothesis", "assertion"
  **Example:** "Human memory is reconstructive, not reproductive"

  ### 6. Phenomenon
  **Definition:** Observed pattern or empirical finding
  **Structure:** Observation + Context + Data
  **Signals:** "observed", "data shows", "pattern"
  **Example:** "Ebbinghaus Forgetting Curve shows exponential memory decay"

  ## Fragmentation Strategy Algorithm

  **Purpose:** Split non-atomic notes into N atomic fragments.

  ### Phase 1: Boundary Detection

  ```
  1. Identify natural boundaries:
     - Markdown headers (##, ###)
     - Paragraph breaks (double newline)
     - Bullet list transitions
     - Thematic shifts (change of subject)

  2. Identify semantic boundaries:
     - New claim introductions
     - Topic changes (NLP topic modeling)
     - Shift in building block type

  3. Score each boundary for "splitability":
     - 1.0 = Clear separation, no dependencies
     - 0.5 = Moderate separation, some overlap
     - 0.0 = Cannot split here, tightly coupled
  ```

  ### Phase 2: Claim Clustering

  ```
  1. Extract all distinct claims/concepts:
     - Parse note for declarative statements
     - Identify thesis-level claims

  2. Cluster related content:
     - Group core claim with supporting evidence
     - Separate independent claims into clusters
     - Assign cluster IDs: C1, C2, C3...

  3. Validate cluster independence:
     - Each cluster should pass atomicity test if extracted
     - Clusters should have minimal cross-dependencies
  ```

  ### Phase 3: Split Point Selection

  ```
  1. Propose split points between clusters:
     - Use high-splitability boundaries
     - Prefer natural boundaries (headers, paragraphs)

  2. Validate proposed fragments:
     - Run analyze-atomicity on each proposed fragment
     - Adjust boundaries if fragments still non-atomic
     - Iterate until all fragments score >= 0.7

  3. Determine fragment count N:
     - N = number of independent clusters
     - Warn if N > 10 (may need different organization)
     - Recommend user review if N > 20
  ```

  ### Phase 4: Fragment Creation

  ```
  1. For each fragment (1..N):
     - Extract cluster content
     - Generate descriptive title
     - Identify building block type
     - Create new note using atomic-note-tmpl.yaml

  2. Preserve source attribution:
     - Add "Fragmented from: [[original-note]]" to metadata
     - Copy original tags to all fragments
     - Preserve creation timestamp from original

  3. Create cross-links:
     - Add bidirectional links between all fragments
     - Add semantic relationship labels
     - Example: "[[Fragment-1]] supports [[Fragment-2]]"
  ```

  ### Phase 5: Original Note Update

  ```
  1. Mark original note as fragmented:
     - Add status: fragmented to frontmatter
     - Add "Fragmented into: [[f1]], [[f2]], [[f3]]" section

  2. Optionally archive or delete original:
     - Move to /archive/fragmented/ directory
     - Preserve for audit trail
  ```

  **Output Format:**
  ```yaml
  fragments_created: int
  fragment_paths: [string]
  links_added: int
  original_status: "fragmented" | "archived"
  ```

  ## MCP Server Integration

  **Obsidian MCP Tools** (Required)

  - **Purpose:** Create atomic notes in Obsidian vault
  - **Server:** obsidian-mcp (must be configured in Claude Desktop MCP settings)
  - **Key Operations:**
    - `read_note(path)` - Read note for atomicity analysis
    - `create_note(path, content)` - Create atomic fragment note
    - `update_note(path, content)` - Add cross-links and metadata
    - `search_notes(query)` - Find related notes for linking
    - `list_notes(directory)` - List notes in a directory

  **Example: Analyze Note for Atomicity**

  ```yaml
  # Read note to analyze
  read_note:
    path: "/inbox/complex-note-about-productivity.md"

  # Returns note content, run analyze-atomicity.md task
  # If score < 0.7, proceed to fragmentation
  ```

  **Example: Fragment Note**

  ```yaml
  # Original note path
  original: "/inbox/complex-note-about-productivity.md"

  # Create Fragment 1
  create_note:
    path: "/atomic/concepts/2025-11-05-zettelkasten-atomicity.md"
    content: |
      ---
      title: Zettelkasten Principle: Atomicity
      type: concept
      building_block: concept
      source_note: "[[complex-note-about-productivity]]"
      created: 2025-11-05T14:30:00Z
      tags: [zettelkasten, atomicity, note-taking]
      atomic_score: 0.95
      ---

      # Zettelkasten Principle: Atomicity

      Each note should contain exactly one complete idea...

      ## Related Concepts
      - [[GTD Inbox Zero]] - related principle
      - [[PARA Method]] - complementary system

      ## Source Attribution
      Fragmented from: [[complex-note-about-productivity]]
      Fragment 1 of 3

  # Create Fragment 2
  create_note:
    path: "/atomic/concepts/2025-11-05-gtd-inbox-zero.md"
    content: |
      [Similar structure for GTD concept]

  # Create Fragment 3
  create_note:
    path: "/atomic/models/2025-11-05-para-method.md"
    content: |
      [Similar structure for PARA model]

  # Update original note
  update_note:
    path: "/inbox/complex-note-about-productivity.md"
    content: |
      ---
      status: fragmented
      fragmented_date: 2025-11-05T14:30:00Z
      ---

      # Complex Note About Productivity (FRAGMENTED)

      This note has been fragmented into atomic notes:
      - [[2025-11-05-zettelkasten-atomicity]]
      - [[2025-11-05-gtd-inbox-zero]]
      - [[2025-11-05-para-method]]
  ```

  ## Security Considerations (CRITICAL)

  **Input Validation:**
  - Sanitize all note paths to prevent directory traversal
  - Block paths containing: `../`, absolute paths outside vault
  - Validate note content is valid markdown (no script injection)
  - Limit fragment count to 20 per note (prevent DoS)

  **Path Safety:**
  ```
  Allowed paths:
  - /inbox/*.md
  - /atomic/**/*.md
  - /mocs/*.md

  Blocked paths:
  - /../../../etc/passwd (directory traversal)
  - /absolute/path/outside/vault
  - file:///etc/passwd (file protocol)
  ```

  **Content Validation:**
  - Verify markdown syntax before creating notes
  - Escape special characters in generated titles
  - Validate frontmatter YAML syntax
  - Strip potentially dangerous content (eval, script tags)

  **Fragment Limits:**
  - Max 20 fragments per note
  - Warn user if >10 fragments (may need restructuring)
  - Reject fragmentation if fragments would still be non-atomic

  **Filename Sanitization:**
  - Remove special characters: / \ : * ? " < > |
  - Limit filename length to 100 characters
  - Convert spaces to hyphens
  - Ensure uniqueness with collision detection

  ## File Locations Summary

  **Agent File:**
  - `expansion-packs/bmad-obsidian-2nd-brain/agents/structural-analysis-agent.md`

  **Tasks:**
  - `expansion-packs/bmad-obsidian-2nd-brain/tasks/analyze-atomicity.md`
  - `expansion-packs/bmad-obsidian-2nd-brain/tasks/fragment-note.md`
  - `expansion-packs/bmad-obsidian-2nd-brain/tasks/create-atomic-note.md`

  **Templates:**
  - `expansion-packs/bmad-obsidian-2nd-brain/templates/atomic-note-tmpl.yaml`

  **Checklists:**
  - `expansion-packs/bmad-obsidian-2nd-brain/checklists/atomicity-checklist.md`

  **Knowledge Base:**
  - `expansion-packs/bmad-obsidian-2nd-brain/data/building-block-types.md`

  ## Command Specifications

  **\*analyze-atomicity {note_path}**
  - Parameters:
    - note_path (required): Path to note to analyze (e.g., "/inbox/my-note.md")
  - Behavior: Read note, run 5 atomicity tests, return score and violations
  - Returns: {is_atomic: bool, score: float, violations: [string], suggestions: [string]}
  - Example: `*analyze-atomicity /inbox/complex-note.md`

  **\*fragment-note {note_path}**
  - Parameters:
    - note_path (required): Path to non-atomic note to fragment
  - Behavior: Run fragmentation algorithm, create N atomic notes, add cross-links
  - Returns: {fragments_created: int, paths: [string], links_added: int}
  - Yolo mode: Auto-confirms all fragment creations
  - Example: `*fragment-note /inbox/tangled-concepts.md`

  **\*validate-note {note_path}**
  - Parameters:
    - note_path (required): Path to note to validate
  - Behavior: Run full atomicity-checklist.md, return detailed pass/fail report
  - Returns: {passed: bool, score: float, checklist_results: {test: bool}}
  - Example: `*validate-note /atomic/concepts/zettelkasten-atomicity.md`

  **\*yolo**
  - Parameters: None
  - Behavior: Toggle yolo mode flag (default: false)
  - Returns: Current yolo mode state
  - Note: In yolo mode, all confirmations auto-accepted for fragmentation

  ## Dependencies on Other Stories

  - **STORY-001** (COMPLETE): Expansion pack infrastructure
  - **STORY-002** (COMPLETE): Inbox Triage Agent (reference for agent structure)
  - All dependency files (tasks, templates, checklists, data) created AS PART OF this story

  ## Anti-Hallucination Safeguards

  - All atomicity test specifications explicitly defined (no ambiguity)
  - Algorithm scoring formulas provided (exact deduction amounts)
  - Building block types defined with examples
  - Fragmentation algorithm broken into 5 phases with clear steps
  - MCP integration examples provided (not assumed)
  - All file paths explicitly specified (no guessing)
  - Security considerations enumerated (not assumed)
  - Accuracy threshold aligned with EPIC success criteria (90%)

dependencies:
  story_dependencies:
    - STORY-001: Expansion pack infrastructure (BLOCKING - must be complete)
    - STORY-002: Inbox Triage Agent (reference for agent structure and patterns)

  files_to_create:
    - atomic-note-tmpl.yaml (NEW - template for atomic notes)
    - atomicity-checklist.md (NEW - quality checklist for atomicity validation)
    - analyze-atomicity.md (NEW - task for atomicity analysis algorithm)
    - fragment-note.md (NEW - task for fragmentation strategy)
    - create-atomic-note.md (NEW - task for MCP integration)
    - building-block-types.md (NEW - knowledge base for 6 building block types)
    - structural-analysis-agent.md (NEW - agent definition file)

  external_dependencies:
    - Obsidian MCP Tools (must be configured in Claude Desktop/Cursor MCP settings)
    - Obsidian vault with notes to analyze
    - BMAD-METHOD core framework v4.x+

testing:
  framework: Manual testing via Claude Desktop or Cursor with Obsidian MCP configured

  test_data_location: expansion-packs/bmad-obsidian-2nd-brain/tests/test-atomicity-notes/ (to be created)

  atomicity_analysis_tests: |
    - Create 10 atomic notes (various building block types)
      Expected: All score >= 0.7, is_atomic = true
      Expected: No violations detected
    - Create 10 non-atomic notes (multiple tangled concepts)
      Expected: All score < 0.7, is_atomic = false
      Expected: Violations list identifies specific problems
    - Create 5 edge cases (very short, very long, complex linking)
      Expected: Consistent scoring behavior
      Expected: Appropriate handling of edge cases
    - Verify accuracy >= 90% (23/25 correct classifications)
    - Verify atomicity scores align with human judgment

  fragmentation_tests: |
    - Fragment 5 non-atomic notes with 2-5 tangled concepts each
      Expected: All fragments score >= 0.7 (atomic)
      Expected: N fragments = number of distinct concepts
      Expected: Source attribution preserved in all fragments
      Expected: Bidirectional cross-links between all fragments
      Expected: Original note marked as "fragmented"
    - Test fragmentation planning algorithm
      Expected: Identifies correct split points
      Expected: Generates appropriate fragment count (2-10)
      Expected: Warns if N > 10 fragments

  building_block_identification_tests: |
    - Classify 30 notes (5 per building block type)
      Expected: Type identification accuracy >= 85%
      Expected: Correct type for concepts, arguments, models, questions, claims, phenomena

  obsidian_integration_tests: |
    - Create 10 atomic notes via MCP Tools
      Expected: Notes appear in correct vault directories (/atomic/concepts/, /atomic/arguments/, etc.)
      Expected: Frontmatter populated correctly
      Expected: Filenames follow convention (YYYY-MM-DD-{title}.md)
    - Test collision handling
      Expected: Duplicate filenames get -2, -3 suffix
    - Test error scenarios
      Vault not found â†’ Expected: Graceful error message
      Invalid note path â†’ Expected: Validation error
      Note already atomic (score >= 0.7) â†’ Expected: Skip with message
      Fragment limit exceeded (>20) â†’ Expected: Warning, user review required

  checklist_validation_tests: |
    - Run atomicity-checklist.md on 10 random atomic notes
      Expected: >= 90% pass all checklist items
    - Run checklist on 10 random fragmentation results
      Expected: All fragments pass checklist

  command_tests: |
    - Test *analyze-atomicity command with various notes
      Expected: Returns score, violations, suggestions
    - Test *fragment-note command on complex note
      Expected: Creates N fragments, adds cross-links
    - Test *validate-note command
      Expected: Runs full checklist, returns detailed report
    - Test *yolo mode toggle
      Expected: Auto-confirms fragmentation actions

  acceptance_validation:
    - AC1-AC10 validated through test scenarios above
    - Run complete end-to-end workflow: analyze â†’ fragment â†’ validate
    - Verify agent activates via /bmad-2b:structural-analysis-agent
    - Document all test results in Dev Agent Record

change_log:
  - date: 2025-11-05
    version: 1.0
    description: Initial story creation for Structural Analysis Agent
    author: Product Owner
  - date: 2025-11-05
    version: 2.0
    description: |
      Comprehensive remediation of all validation issues identified by PO:
      - Added comprehensive tasks_subtasks section (11 tasks, 100+ subtasks)
      - Expanded dev_notes to 590+ lines with complete algorithm specifications
      - Added atomicity analysis algorithm (5 tests with exact scoring formulas)
      - Added building block type definitions (6 types)
      - Added fragmentation strategy algorithm (5 phases)
      - Added MCP integration examples with code samples
      - Added security considerations (input validation, path safety, fragment limits)
      - Added file location specifications
      - Added command parameter specifications
      - Reorganized dependencies section (story deps vs file deps vs external deps)
      - Expanded testing section with detailed test scenarios and expected results
      - Added change_log section
      - Added dev_agent_record section (empty for dev agent to populate)
      - Added qa_results section (empty for QA agent to populate)
      - Renamed AC to match template numbering (AC1-AC10)
      - Aligned accuracy threshold with EPIC-001 success criteria (90%)
      - Added anti-hallucination safeguards with explicit algorithm specifications
    author: Sarah (Product Owner)

dev_agent_record: |
  # Dev Agent Record

  ## Agent Model Used
  _To be populated by dev agent during implementation_

  ## Debug Log References
  _To be populated by dev agent during implementation_

  ## Completion Notes
  _To be populated by dev agent during implementation_

  ## File List
  _To be populated by dev agent during implementation_

qa_results: |
  # QA Results

  _To be populated by QA agent after implementation_
