# Test Cases: vulnerability-lifecycle-workflow.yaml

## Test Overview

This document defines integration test cases for the complete Vulnerability Lifecycle Workflow, covering all 7 stages from Detection through Closure. Tests validate stage transitions, JIRA status changes, metrics capture, and audit trail completeness.

## Test Environment Setup

### Prerequisites

- Atlassian MCP server configured and authenticated
- JIRA test instance with all 7 required statuses configured
- All required status transitions configured in JIRA
- Security Analyst agent available (for Enrichment stage)
- Security Reviewer agent available (for Review stage)
- DevOps team access (for Remediation Planning and Execution stages)
- Vulnerability scanner access (for Detection and Verification stages)
- Write access to all required directories:
  - `enrichments/` - Enrichment document archive
  - `reviews/` - Review report archive
  - `metrics/` - Metrics CSV files
  - `workflows/` - Workflow state tracking
- `config.yaml` properly configured with JIRA custom fields

### Required JIRA Statuses

Before running tests, verify all statuses exist in JIRA project:

1. ✓ Open
2. ✓ In Progress
3. ✓ In Review
4. ✓ Remediation Planning
5. ✓ Remediation In Progress
6. ✓ Verification
7. ✓ Closed

### Required JIRA Status Transitions

Verify all transitions are configured in JIRA workflow:

- ✓ Open → In Progress
- ✓ In Progress → In Review
- ✓ In Progress → Remediation Planning
- ✓ In Review → In Progress
- ✓ In Review → Remediation Planning
- ✓ Remediation Planning → Remediation In Progress
- ✓ Remediation In Progress → Verification
- ✓ Verification → Remediation In Progress
- ✓ Verification → Closed

### Test Data Requirements

**Required Test Tickets (to be created by QA/PO):**

**TC-LIFECYCLE-001: P1 Ticket - Full Mandatory Review Path**

```yaml
Summary: 'Critical Apache Struts RCE (CVE-2024-5001)'
Description: 'Critical vulnerability affecting production web servers'
Issue Type: 'Security Alert'
Priority: 'Critical'
Custom Fields:
  CVE ID: 'CVE-2024-5001'
  Affected Systems: ['web-prod-01', 'web-prod-02']
  Asset Criticality Rating: 'High'
  System Exposure: 'Internet-facing'
Status: 'Open'
```

**TC-LIFECYCLE-002: P4 Ticket - Review Skipped Path**

```yaml
Summary: 'Low Priority MySQL Vulnerability (CVE-2024-5002)'
Description: 'Low severity vulnerability in internal database'
Issue Type: 'Security Alert'
Priority: 'Low'
Custom Fields:
  CVE ID: 'CVE-2024-5002'
  Affected Systems: ['db-dev-01']
  Asset Criticality Rating: 'Low'
  System Exposure: 'Internal'
Status: 'Open'
```

**TC-LIFECYCLE-003: Failed Review Loop Ticket**

```yaml
Summary: 'OpenSSL Vulnerability - Review Test (CVE-2024-5003)'
Description: 'Test ticket for review revision loop'
Issue Type: 'Security Alert'
Priority: 'High'
Custom Fields:
  CVE ID: 'CVE-2024-5003'
  Affected Systems: ['app-prod-01']
  Asset Criticality Rating: 'Medium'
  System Exposure: 'Internal'
Status: 'Open'
```

**TC-LIFECYCLE-004: Failed Verification Loop Ticket**

```yaml
Summary: 'PostgreSQL Vulnerability - Verification Test (CVE-2024-5004)'
Description: 'Test ticket for verification retry loop'
Issue Type: 'Security Alert'
Priority: 'High'
Custom Fields:
  CVE ID: 'CVE-2024-5004'
  Affected Systems: ['db-prod-02']
  Asset Criticality Rating: 'Medium'
  System Exposure: 'Internal'
Status: 'Open'
```

**After Creating Tickets:**

1. Document actual ticket IDs here:
   - TC-LIFECYCLE-001: `{YOUR-PROJECT-KEY}-____`
   - TC-LIFECYCLE-002: `{YOUR-PROJECT-KEY}-____`
   - TC-LIFECYCLE-003: `{YOUR-PROJECT-KEY}-____`
   - TC-LIFECYCLE-004: `{YOUR-PROJECT-KEY}-____`

2. Update test case references throughout this file to use actual ticket IDs

3. Verify all custom fields exist in your JIRA project (see `docs/architecture/jira-workflow-standards.md`)

---

## Test Cases

### TC-001: P1 Ticket - Complete Lifecycle with Mandatory Review

**Test ID:** TC-LIFECYCLE-001
**Priority:** Critical
**Story Reference:** Story 3.3, AC #1, #2, #3, #4
**Description:** Validate complete lifecycle for P1 ticket through all 7 stages with mandatory review

**Test Workflow Path:**

```
Detection → Enrichment → Mandatory Review → Remediation Planning →
Remediation Execution → Verification → Closure
```

**Prerequisites:**

- TC-LIFECYCLE-001 ticket created in JIRA with status "Open"
- All 7 JIRA statuses configured
- All required transitions configured

**Test Steps:**

1. **Stage 1: Detection**
   - Verify ticket exists in JIRA with status "Open"
   - Verify CVE ID extracted: CVE-2024-5001
   - Verify affected systems documented
   - Record detection timestamp
   - **Expected:** Ticket ready for enrichment

2. **Stage 2: Enrichment**
   - Transition ticket to "In Progress"
   - Analyst activates Security Analyst agent
   - Execute enrichment workflow (Story 3.1)
   - Post enrichment comment to JIRA
   - Update custom fields (CVSS, EPSS, KEV, Priority)
   - Save enrichment document to `enrichments/{ticket-id}-enrichment.md`
   - Record enrichment start/completion timestamps
   - Calculate enrichment duration
   - **Expected:** Priority set to P1, ticket ready for mandatory review

3. **Stage 3: Quality Assurance Review** (Mandatory for P1)
   - Transition ticket to "In Review"
   - Reviewer activates Security Reviewer agent
   - Execute review workflow (Story 3.2)
   - Post review report to JIRA
   - Save review report to `reviews/{ticket-id}-review.md`
   - Record review start/completion timestamps
   - Record quality score and gaps found
   - **Expected:** Review approved, ready for remediation planning

4. **Stage 4: Remediation Planning**
   - Transition ticket to "Remediation Planning"
   - DevOps team reviews enrichment guidance
   - Create remediation plan
   - Schedule deployment window
   - Record planning start/completion timestamps
   - **Expected:** Remediation plan documented, ready for execution

5. **Stage 5: Remediation Execution**
   - Transition ticket to "Remediation In Progress"
   - Execute patch deployment
   - Document execution steps in JIRA comments
   - Record execution start/completion timestamps
   - Calculate MTTR
   - **Expected:** Patches deployed, ready for verification

6. **Stage 6: Verification**
   - Transition ticket to "Verification"
   - Re-scan affected systems
   - Verify vulnerability no longer present
   - Record verification timestamp and status (Pass)
   - **Expected:** Verification passed, ready for closure

7. **Stage 7: Closure**
   - Transition ticket to "Closed"
   - Verify enrichment artifact exists in `enrichments/`
   - Verify review report exists in `reviews/`
   - Verify all metrics logged to `metrics/enrichment-metrics.csv`
   - Verify complete audit trail in JIRA comments
   - Record closure timestamp
   - Calculate total lifecycle duration
   - **Expected:** Ticket closed, all artifacts archived, complete audit trail

**Validation Checks:**

- ✓ All 7 stage transitions completed successfully
- ✓ All JIRA status changes recorded
- ✓ Enrichment document saved to `enrichments/{ticket-id}-enrichment.md`
- ✓ Review report saved to `reviews/{ticket-id}-review.md`
- ✓ All metrics logged to `metrics/enrichment-metrics.csv`:
  - detection_timestamp
  - enrichment_start_timestamp, enrichment_completion_timestamp, enrichment_duration_minutes
  - review_start_timestamp, review_completion_timestamp, review_duration_minutes
  - remediation_planning_start, remediation_planning_completion
  - remediation_execution_start, remediation_execution_completion
  - verification_timestamp
  - closure_timestamp
  - total_lifecycle_duration_hours
  - mttr_hours
- ✓ Complete JIRA comment history with all stage notes
- ✓ Analyst and reviewer attribution in JIRA

**Expected Result:** ✅ PASS - Complete lifecycle from Detection to Closure with all artifacts and metrics captured

---

### TC-002: P4 Ticket - Review Skipped Path

**Test ID:** TC-LIFECYCLE-002
**Priority:** Medium
**Story Reference:** Story 3.3, AC #1, #2
**Description:** Validate lifecycle for P4 ticket where review stage is optional (skipped)

**Test Workflow Path:**

```
Detection → Enrichment → [Review Skipped] → Remediation Planning →
Remediation Execution → Verification → Closure
```

**Prerequisites:**

- TC-LIFECYCLE-002 ticket created in JIRA with status "Open"

**Test Steps:**

1. **Stage 1: Detection**
   - Verify ticket exists with status "Open"
   - Record detection timestamp

2. **Stage 2: Enrichment**
   - Transition to "In Progress"
   - Execute enrichment workflow
   - Priority assigned: P4 (Low)
   - **Expected:** Enrichment complete, priority P4

3. **Stage 3: Review** (Skipped)
   - Verify review NOT mandatory for P4
   - Transition directly to "Remediation Planning" (skip "In Review")
   - **Expected:** Review stage bypassed

4. **Stage 4-7: Remediation Planning → Execution → Verification → Closure**
   - Execute remaining stages normally
   - **Expected:** All stages complete successfully

**Validation Checks:**

- ✓ "In Review" status never set
- ✓ No review report in `reviews/` directory
- ✓ Direct transition from "In Progress" to "Remediation Planning"
- ✓ All other metrics captured normally
- ✓ Enrichment document still saved to `enrichments/`

**Expected Result:** ✅ PASS - Lifecycle completes successfully without review stage

---

### TC-003: Failed Review - Revision Loop

**Test ID:** TC-LIFECYCLE-003
**Priority:** High
**Story Reference:** Story 3.3, AC #1, #2
**Description:** Validate revision loop when review identifies Critical Issues

**Test Workflow Path:**

```
Detection → Enrichment → Review (Critical Issues) → Back to Enrichment →
Review (Approved) → Remediation Planning → Execution → Verification → Closure
```

**Prerequisites:**

- TC-LIFECYCLE-003 ticket created in JIRA with status "Open"

**Test Steps:**

1. **Stages 1-2: Detection → Enrichment**
   - Complete detection and initial enrichment
   - Priority: P2 (mandatory review)
   - Transition to "In Review"

2. **Stage 3: Review - First Attempt (Fail)**
   - Reviewer finds Critical Issues
   - Review report documents gaps
   - Transition ticket BACK to "In Progress"
   - Add JIRA comment: "Critical Issues found - requires revision"
   - **Expected:** Ticket returned to analyst for revision

3. **Stage 2: Enrichment - Revision**
   - Analyst addresses Critical Issues
   - Updates enrichment document
   - Updates JIRA custom fields
   - Transition back to "In Review"
   - **Expected:** Revised enrichment ready for re-review

4. **Stage 3: Review - Second Attempt (Pass)**
   - Reviewer validates fixes
   - Review approved
   - Transition to "Remediation Planning"
   - **Expected:** Review approved, moves to next stage

5. **Stages 4-7: Remediation → Verification → Closure**
   - Complete remaining stages normally

**Validation Checks:**

- ✓ JIRA status transitions: In Progress → In Review → In Progress → In Review → Remediation Planning
- ✓ Two review attempts recorded in metrics
- ✓ JIRA comments document revision loop
- ✓ Updated enrichment document reflects fixes
- ✓ Metrics show increased enrichment and review durations

**Expected Result:** ✅ PASS - Revision loop handled correctly, workflow completes after fixes

---

### TC-004: Failed Verification - Remediation Retry Loop

**Test ID:** TC-LIFECYCLE-004
**Priority:** High
**Story Reference:** Story 3.3, AC #1, #2
**Description:** Validate retry loop when verification fails

**Test Workflow Path:**

```
Detection → Enrichment → Review → Remediation Planning →
Remediation Execution → Verification (Fail) → Back to Remediation Execution →
Verification (Pass) → Closure
```

**Prerequisites:**

- TC-LIFECYCLE-004 ticket created in JIRA with status "Open"

**Test Steps:**

1. **Stages 1-5: Detection → Enrichment → Review → Planning → Execution**
   - Complete all stages through initial remediation execution
   - Deploy initial patch
   - Transition to "Verification"

2. **Stage 6: Verification - First Attempt (Fail)**
   - Re-scan affected systems
   - Verify vulnerability STILL present (patch failed)
   - Record verification status: Fail
   - Transition ticket BACK to "Remediation In Progress"
   - Add JIRA comment: "Verification failed - vulnerability still present"
   - **Expected:** Ticket returned for remediation retry

3. **Stage 5: Remediation Execution - Retry**
   - DevOps team investigates failure
   - Deploy corrected patch or alternative remediation
   - Record second execution timestamps
   - Transition back to "Verification"
   - **Expected:** Second remediation attempt ready for verification

4. **Stage 6: Verification - Second Attempt (Pass)**
   - Re-scan affected systems
   - Verify vulnerability NO LONGER present
   - Record verification status: Pass
   - Transition to "Closed"
   - **Expected:** Verification passed, ready for closure

5. **Stage 7: Closure**
   - Complete closure normally
   - Capture lessons learned about failed remediation

**Validation Checks:**

- ✓ JIRA status transitions: Remediation In Progress → Verification → Remediation In Progress → Verification → Closed
- ✓ Two verification attempts recorded in metrics
- ✓ Two remediation execution periods captured
- ✓ JIRA comments document retry loop
- ✓ Increased MTTR reflects retry time

**Expected Result:** ✅ PASS - Retry loop handled correctly, workflow completes after successful remediation

---

### TC-005: JIRA Configuration Validation

**Test ID:** TC-LIFECYCLE-005
**Priority:** Critical
**Story Reference:** Story 3.3, AC #2
**Description:** Validate JIRA configuration prerequisites before workflow execution

**Prerequisites:**

- Access to JIRA project configuration
- Admin permissions to view workflow configuration

**Test Steps:**

1. **Validate JIRA Statuses Exist**
   - Query JIRA project for available statuses
   - Verify all 7 required statuses exist:
     - ✓ Open
     - ✓ In Progress
     - ✓ In Review
     - ✓ Remediation Planning
     - ✓ Remediation In Progress
     - ✓ Verification
     - ✓ Closed
   - **Expected:** All 7 statuses configured in JIRA project

2. **Validate Status Transitions Exist**
   - Query JIRA workflow for allowed transitions
   - Verify all 9 required transitions configured:
     - ✓ Open → In Progress
     - ✓ In Progress → In Review
     - ✓ In Progress → Remediation Planning
     - ✓ In Review → In Progress
     - ✓ In Review → Remediation Planning
     - ✓ Remediation Planning → Remediation In Progress
     - ✓ Remediation In Progress → Verification
     - ✓ Verification → Remediation In Progress
     - ✓ Verification → Closed
   - **Expected:** All transitions allowed in JIRA workflow

3. **Validate Custom Fields Exist**
   - Query JIRA for custom fields
   - Verify required fields configured:
     - ✓ CVE ID
     - ✓ CVSS Score
     - ✓ EPSS Score
     - ✓ KEV Status
     - ✓ Priority Level
     - ✓ Quality Score
     - ✓ Affected Systems
     - ✓ Asset Criticality Rating
     - ✓ System Exposure
   - **Expected:** All custom fields exist with correct field types

4. **Validation Error Handling**
   - Test with JIRA project missing required status
   - Test with JIRA project missing required transition
   - **Expected:** Workflow fails gracefully with clear error message identifying missing configuration

**Validation Checks:**

- ✓ Pre-flight validation runs before workflow execution
- ✓ Missing statuses detected and reported
- ✓ Missing transitions detected and reported
- ✓ Missing custom fields detected and reported
- ✓ Clear error messages guide user to fix configuration

**Expected Result:** ✅ PASS - JIRA configuration validated before workflow execution

---

### TC-006: Metrics Capture Validation

**Test ID:** TC-LIFECYCLE-006
**Priority:** High
**Story Reference:** Story 3.3, AC #3
**Description:** Validate all metrics captured at each lifecycle stage

**Prerequisites:**

- Complete lifecycle test ticket (use TC-LIFECYCLE-001 or create new ticket)
- Access to `metrics/enrichment-metrics.csv`

**Test Steps:**

1. **Execute Complete Lifecycle**
   - Run complete lifecycle workflow from Detection to Closure
   - Track timestamps at each stage transition

2. **Validate Metrics File Structure**
   - Open `metrics/enrichment-metrics.csv`
   - Verify CSV headers match specification:
     ```
     ticket_id, detection_timestamp, enrichment_start_timestamp,
     enrichment_completion_timestamp, enrichment_duration_minutes,
     enrichment_quality_score, review_start_timestamp,
     review_completion_timestamp, review_duration_minutes,
     review_quality_score, gaps_found_critical, gaps_found_significant,
     gaps_found_minor, remediation_planning_start,
     remediation_planning_completion, remediation_execution_start,
     remediation_execution_completion, verification_timestamp,
     closure_timestamp, total_lifecycle_duration_hours, mttr_hours
     ```
   - **Expected:** CSV has correct headers

3. **Validate Metrics Values**
   - Find row for test ticket ID
   - Verify all timestamp fields populated
   - Verify calculated durations accurate:
     - enrichment_duration_minutes = (completion - start)
     - review_duration_minutes = (completion - start)
     - total_lifecycle_duration_hours = (closure - detection)
     - mttr_hours = (remediation_execution_completion - detection)
   - Verify quality scores recorded
   - Verify gap counts recorded
   - **Expected:** All metrics accurate and complete

4. **Validate Metrics Timing**
   - Verify metrics logged immediately after each stage (not batched at end)
   - Verify partial metrics exist even if workflow incomplete
   - **Expected:** Real-time metrics logging

**Validation Checks:**

- ✓ CSV file created in `metrics/` directory
- ✓ All 20 metric fields populated
- ✓ Timestamps in ISO 8601 format
- ✓ Duration calculations correct
- ✓ Metrics logged incrementally (not just at closure)

**Expected Result:** ✅ PASS - All metrics captured accurately at each stage

---

### TC-007: Directory Creation Validation

**Test ID:** TC-LIFECYCLE-007
**Priority:** Medium
**Story Reference:** Story 3.3, AC #3, #4
**Description:** Validate required directories created if missing

**Prerequisites:**

- Clean test environment
- Ability to delete/create directories

**Test Steps:**

1. **Delete Required Directories**
   - Remove `enrichments/` directory
   - Remove `reviews/` directory
   - Remove `metrics/` directory
   - **Expected:** Directories deleted

2. **Execute Workflow**
   - Run enrichment workflow (Story 3.1)
   - Attempt to save enrichment document
   - **Expected:** Workflow creates `enrichments/` directory automatically

3. **Verify Directory Creation**
   - Verify `enrichments/` directory exists
   - Verify enrichment document saved successfully
   - Run review workflow (Story 3.2)
   - Verify `reviews/` directory created automatically
   - Verify review report saved successfully
   - Verify `metrics/` directory created when metrics logged
   - **Expected:** All directories created as needed

4. **Verify .gitkeep Files**
   - Verify each directory contains `.gitkeep` file
   - **Expected:** Empty directories preserved in git

**Validation Checks:**

- ✓ `enrichments/` directory created on demand
- ✓ `reviews/` directory created on demand
- ✓ `metrics/` directory created on demand
- ✓ `.gitkeep` files present in each directory
- ✓ Workflow does not fail due to missing directories

**Expected Result:** ✅ PASS - Required directories created automatically

---

### TC-008: Audit Trail Completeness

**Test ID:** TC-LIFECYCLE-008
**Priority:** High
**Story Reference:** Story 3.3, AC #4
**Description:** Validate complete audit trail from detection to closure

**Prerequisites:**

- Complete lifecycle test ticket (use TC-LIFECYCLE-001 or create new ticket)

**Test Steps:**

1. **Execute Complete Lifecycle**
   - Run complete lifecycle workflow from Detection to Closure
   - Ensure all stages complete successfully

2. **Validate JIRA Audit Trail**
   - Open ticket in JIRA
   - Review JIRA History tab
   - Verify all status transitions recorded with timestamps:
     - Open → In Progress
     - In Progress → In Review
     - In Review → Remediation Planning
     - Remediation Planning → Remediation In Progress
     - Remediation In Progress → Verification
     - Verification → Closed
   - Verify all custom field updates recorded
   - Verify all JIRA comments preserved:
     - Enrichment summary comment
     - Review report comment
     - Remediation plan comment
     - Verification result comment
   - Verify assignee/reporter attribution for each action
   - **Expected:** Complete JIRA history with all actions timestamped and attributed

3. **Validate File System Artifacts**
   - Verify enrichment document exists: `enrichments/{ticket-id}-enrichment.md`
   - Verify review report exists: `reviews/{ticket-id}-review.md`
   - Open each file and verify complete content
   - **Expected:** All artifacts preserved with complete content

4. **Validate Metrics Audit Trail**
   - Open `metrics/enrichment-metrics.csv`
   - Find row for test ticket
   - Verify all stage timestamps recorded
   - Cross-reference timestamps with JIRA history
   - **Expected:** Metrics timestamps match JIRA history

5. **Validate Attribution**
   - Verify analyst name/ID recorded in:
     - JIRA assignee field during enrichment
     - Enrichment document metadata
     - Metrics CSV (if analyst field exists)
   - Verify reviewer name/ID recorded in:
     - JIRA assignee field during review
     - Review report metadata
     - Metrics CSV
   - **Expected:** Complete attribution chain for all actions

**Validation Checks:**

- ✓ JIRA ticket history complete with all status transitions
- ✓ All JIRA comments preserved
- ✓ Enrichment document archived in `enrichments/`
- ✓ Review report archived in `reviews/`
- ✓ All metrics logged in `metrics/enrichment-metrics.csv`
- ✓ All timestamps recorded in ISO 8601 format
- ✓ Analyst and reviewer attribution preserved
- ✓ Audit trail supports compliance requirements (who, what, when)

**Expected Result:** ✅ PASS - Complete audit trail from detection to closure

---

## Test Execution Summary

### Test Execution Checklist

Before running tests:

- [ ] JIRA test instance configured with all 7 statuses
- [ ] All 9 status transitions configured in JIRA workflow
- [ ] All required custom fields created in JIRA
- [ ] All test tickets created and documented
- [ ] Atlassian MCP server authenticated
- [ ] Perplexity MCP server authenticated
- [ ] All required directories exist (or test directory auto-creation)
- [ ] Security Analyst agent available
- [ ] Security Reviewer agent available

Test execution order:

1. TC-005: JIRA Configuration Validation (MUST pass first)
2. TC-007: Directory Creation Validation
3. TC-001: P1 Ticket - Full Lifecycle
4. TC-006: Metrics Capture Validation
5. TC-008: Audit Trail Completeness
6. TC-002: P4 Ticket - Review Skipped
7. TC-003: Failed Review Loop
8. TC-004: Failed Verification Loop

### Success Criteria

All 8 test cases must pass for Story 3.3 to be considered complete.

---

## Notes for QA/PO

### Manual vs Automated Testing

These test cases are designed for manual execution during initial implementation. Future automation recommended for:

- JIRA configuration validation (TC-005)
- Metrics validation (TC-006)
- Directory creation (TC-007)
- Audit trail verification (TC-008)

### Test Data Cleanup

After test execution:

- Archive or delete test tickets in JIRA
- Clean up test artifacts from `enrichments/`, `reviews/`, `metrics/` directories
- Document actual ticket IDs used for regression testing

### Integration with CI/CD

Future enhancement: Integrate workflow validation into CI/CD pipeline to catch JIRA configuration issues before deployment.
