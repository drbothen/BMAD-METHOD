# Test Design: Story 1.6 - JIRA Custom Field Updates

**Date:** 2025-11-08
**Designer:** Quinn (Test Architect)
**Story:** 1.6 - JIRA Custom Field Updates
**Epic:** Epic 1 - Security Analyst Agent & Core Enrichment Workflow

---

## Test Strategy Overview

- **Total test scenarios:** 33
- **Unit tests:** 18 (55%)
- **Integration tests:** 12 (36%)
- **E2E tests:** 3 (9%)
- **Priority distribution:** P0: 24, P1: 9, P2: 0, P3: 0

### Strategy Rationale

This story is **security-critical** as it updates fields that drive vulnerability prioritization decisions. Test strategy emphasizes:

1. **Comprehensive validation testing** - All field types require robust validation at unit level
2. **Integration resilience** - MCP tool and JIRA configuration dependencies require thorough integration testing
3. **Fail-safe mechanisms** - Error handling must prevent partial updates and data corruption
4. **Shift-left approach** - 55% unit tests enable fast feedback on validation logic

---

## Test Scenarios by Acceptance Criteria

### AC1: Agent updates custom fields using `mcp__atlassian__updateJiraIssue`

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-UNIT-001 | Unit | P0 | Build field update payload from enrichment data | Pure logic - payload construction without external dependencies |
| 1.6-UNIT-002 | Unit | P0 | Parse configuration from config.yaml structure | Data transformation logic - config parsing |
| 1.6-INT-001 | Integration | P0 | Successfully invoke MCP tool with valid payload | Critical integration point - MCP tool invocation |
| 1.6-INT-002 | Integration | P0 | Handle MCP tool errors gracefully (400/403/500) | Error resilience - MCP failure scenarios |
| 1.6-INT-003 | Integration | P0 | Handle missing/invalid configuration file | Config dependency - fail fast on misconfiguration |

---

### AC2: CVSS score (number field)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-UNIT-003 | Unit | P0 | Validate CVSS score within range (0.0-10.0) | Boundary validation - critical for security scoring |
| 1.6-UNIT-004 | Unit | P1 | Round CVSS to 1 decimal place (e.g., 7.856 → 7.9) | Data formatting logic - ensures consistent precision |
| 1.6-UNIT-005 | Unit | P0 | Reject CVSS out of range (e.g., 11.5, -1.0) | Validation logic - prevent invalid data in JIRA |
| 1.6-UNIT-006 | Unit | P0 | Handle missing CVSS score (skip field update) | Null handling - partial updates allowed |
| 1.6-INT-004 | Integration | P0 | Update CVSS custom field in JIRA successfully | Field mapping verification - CVSS field integration |

#### Edge Cases Covered
- Boundary values: 0.0, 10.0
- Precision: 7.85, 7.856 (rounding)
- Invalid: 11.5, -1.0, null, "invalid"

---

### AC3: EPSS score (number field)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-UNIT-007 | Unit | P0 | Validate EPSS score within range (0.0-1.0) | Boundary validation - EPSS is probability metric |
| 1.6-UNIT-008 | Unit | P1 | Round EPSS to 2 decimal places (e.g., 0.8563 → 0.86) | Data formatting logic - EPSS standard precision |
| 1.6-UNIT-009 | Unit | P0 | Reject EPSS out of range (e.g., 1.5, -0.1) | Validation logic - probability must be 0-1 |
| 1.6-UNIT-010 | Unit | P0 | Handle missing EPSS score (skip field update) | Null handling - EPSS may not always be available |
| 1.6-INT-005 | Integration | P0 | Update EPSS custom field in JIRA successfully | Field mapping verification - EPSS field integration |

#### Edge Cases Covered
- Boundary values: 0.0, 0.00, 1.0, 1.00
- Precision: 0.856, 0.8563 (rounding)
- Invalid: 1.5, -0.1, 2.0, null

---

### AC4: KEV status (dropdown: Listed/Not Listed)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-UNIT-011 | Unit | P0 | Format KEV value as dropdown object `{value: "Listed"}` | Dropdown formatting - JIRA select field structure |
| 1.6-UNIT-012 | Unit | P0 | Reject invalid KEV values (e.g., "Unknown", "Yes") | Validation logic - only "Listed"/"Not Listed" allowed |
| 1.6-UNIT-013 | Unit | P0 | Handle missing KEV status (default to "Not Listed") | Default value logic - safe fallback for KEV |
| 1.6-INT-006 | Integration | P0 | Update KEV dropdown field in JIRA successfully | Field mapping verification - dropdown field integration |

#### Valid Values
- "Listed" (CVE in CISA KEV catalog)
- "Not Listed" (CVE not in catalog)

#### Invalid Values to Reject
- "Unknown", "Yes", "No", "True", "False", null

---

### AC5: Priority (standard field: Critical/High/Medium/Low)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-UNIT-014 | Unit | P0 | Map P1 → Critical priority | Priority mapping logic - highest severity |
| 1.6-UNIT-015 | Unit | P0 | Map P2 → High priority | Priority mapping logic - high severity |
| 1.6-UNIT-016 | Unit | P0 | Map P3 → Medium priority | Priority mapping logic - medium severity |
| 1.6-UNIT-017 | Unit | P1 | Map P4 → Low priority | Priority mapping logic - low severity |
| 1.6-UNIT-018 | Unit | P1 | Map P5 → Trivial priority | Priority mapping logic - lowest severity |
| 1.6-INT-007 | Integration | P0 | Update priority standard field in JIRA | Priority field integration - standard JIRA field |

#### Priority Mapping
```
P1 → Critical (Highest)
P2 → High
P3 → Medium
P4 → Low
P5 → Trivial (Lowest)
```

---

### AC6: CVE ID (text field)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-UNIT-019 | Unit | P0 | Validate CVE format `CVE-YYYY-NNNNN` using regex | Format validation - CVE ID standard format |
| 1.6-UNIT-020 | Unit | P0 | Reject invalid CVE format (e.g., "2024-1234") | Validation logic - prevent malformed CVE IDs |
| 1.6-UNIT-021 | Unit | P1 | Handle multiple CVEs (use first, log others in comment) | Multi-value logic - primary CVE selection |
| 1.6-INT-008 | Integration | P0 | Update CVE ID text field in JIRA successfully | Field mapping verification - CVE ID field integration |

#### Valid CVE Formats
- `CVE-2024-1234`
- `CVE-2024-12345`
- `CVE-2024-1234567`

#### Invalid Formats to Reject
- `2024-1234` (missing prefix)
- `CVE-24-1234` (invalid year format)
- `CVE-2024` (missing number)
- `cve-2024-1234` (lowercase)

---

## Cross-Cutting Scenarios

These scenarios test behaviors spanning multiple acceptance criteria:

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 1.6-INT-009 | Integration | P0 | Partial field update (some succeed, some fail) | Error resilience - handle mixed success/failure |
| 1.6-INT-010 | Integration | P1 | Handle field permission errors (read-only user) | Permission handling - graceful degradation |
| 1.6-INT-011 | Integration | P1 | Handle non-existent custom field error | Config validation - detect misconfigured fields |
| 1.6-INT-012 | Integration | P1 | Handle network timeout/connection errors | Network resilience - MCP tool connectivity |
| 1.6-E2E-001 | E2E | P0 | Complete field update workflow in enrichment | Critical path - full enrichment integration |
| 1.6-E2E-002 | E2E | P1 | Verify updated fields display in JIRA web UI | User validation - visual confirmation |
| 1.6-E2E-003 | E2E | P1 | Verify JQL queries using updated custom fields | Integration validation - JIRA query functionality |

---

## Risk Coverage

### Identified Risks

| Risk ID | Description | Mitigated By Test IDs | Severity |
|---|---|---|---|
| RISK-1.6-001 | Invalid CVSS/EPSS scores cause JIRA field update failure | 1.6-UNIT-003, 1.6-UNIT-005, 1.6-UNIT-007, 1.6-UNIT-009 | High |
| RISK-1.6-002 | Wrong priority mapping leads to incorrect triage | 1.6-UNIT-014 through 1.6-UNIT-018 | Critical |
| RISK-1.6-003 | MCP tool failures block entire enrichment workflow | 1.6-INT-002, 1.6-INT-009, 1.6-INT-012 | High |
| RISK-1.6-004 | Misconfigured custom field IDs cause silent failures | 1.6-INT-003, 1.6-INT-011 | Medium |
| RISK-1.6-005 | Multiple CVEs cause data loss in single-value field | 1.6-UNIT-021 | Medium |

---

## Test Coverage Matrix

### By Acceptance Criterion

| AC | Unit Tests | Integration Tests | E2E Tests | Total | Coverage |
|---|---|---|---|---|---|
| AC1 | 2 | 3 | - | 5 | Complete |
| AC2 | 4 | 1 | - | 5 | Complete |
| AC3 | 4 | 1 | - | 5 | Complete |
| AC4 | 3 | 1 | - | 4 | Complete |
| AC5 | 5 | 1 | - | 6 | Complete |
| AC6 | 3 | 1 | - | 4 | Complete |
| Cross-cutting | - | 4 | 3 | 7 | Complete |

### By Priority

| Priority | Count | Percentage | Test Level Distribution |
|---|---|---|---|
| P0 | 24 | 73% | Unit: 14, Integration: 10, E2E: 1 |
| P1 | 9 | 27% | Unit: 4, Integration: 2, E2E: 2 |
| P2 | 0 | 0% | - |
| P3 | 0 | 0% | - |

---

## Recommended Execution Order

### Phase 1: Critical Validation (P0 Unit Tests) - Run First
Execute immediately - fail fast on core validation logic

1. 1.6-UNIT-001, 1.6-UNIT-002 (Payload/Config)
2. 1.6-UNIT-003, 1.6-UNIT-005 (CVSS validation)
3. 1.6-UNIT-007, 1.6-UNIT-009 (EPSS validation)
4. 1.6-UNIT-011, 1.6-UNIT-012, 1.6-UNIT-013 (KEV validation)
5. 1.6-UNIT-014, 1.6-UNIT-015, 1.6-UNIT-016 (Priority mapping)
6. 1.6-UNIT-019, 1.6-UNIT-020 (CVE validation)
7. 1.6-UNIT-006, 1.6-UNIT-010 (Null handling)

### Phase 2: Critical Integration (P0 Integration Tests)
Execute after unit tests pass - validates JIRA/MCP integration

1. 1.6-INT-001 (MCP tool success)
2. 1.6-INT-002 (MCP tool errors)
3. 1.6-INT-003 (Config errors)
4. 1.6-INT-004 through 1.6-INT-008 (Field updates)
5. 1.6-INT-009 (Partial updates)

### Phase 3: Critical E2E (P0 E2E Test)
Execute after integration tests - validates complete workflow

1. 1.6-E2E-001 (Complete enrichment workflow)

### Phase 4: High Priority (P1 Tests)
Execute for comprehensive coverage

1. P1 Unit tests (formatting, low-priority mappings)
2. P1 Integration tests (permissions, error edge cases)
3. P1 E2E tests (UI verification, JQL validation)

---

## Test Implementation Notes

### Unit Test Framework
- Framework: TBD (awaiting project test standards)
- Mocking: Mock config.yaml loading, enrichment data inputs
- Assertions: Validate exact values, error messages, payload structure

### Integration Test Setup
- Requires: Test JIRA instance with configured custom fields
- MCP Tool: Use test cloud ID and project key
- Test Data: Sample enrichment data with all field types
- Cleanup: Reset test ticket fields after each test

### E2E Test Environment
- JIRA Access: Test instance with web UI access
- JQL Queries: Validate custom field queries work
- Visual Validation: Confirm fields display correctly in UI

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with security risk (24 P0 tests)
- [x] Test IDs follow naming convention (1.6-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] Error handling comprehensively tested
- [x] Boundary conditions covered (0.0, 10.0, 1.0, etc.)

---

## Coverage Gaps

**None identified.** All acceptance criteria have comprehensive test coverage across appropriate test levels.

---

## Dependencies & Prerequisites

### Configuration Requirements
- `expansion-packs/bmad-1898-engineering/config.yaml` must have:
  - `jira.cloud_id` configured
  - `jira.custom_fields` section with all field IDs
  - `jira.priority_mapping` defined

### Test Data Requirements
- Sample enrichment data with:
  - Valid CVSS scores (0.0-10.0)
  - Valid EPSS scores (0.0-1.0)
  - KEV status values
  - CVE IDs in proper format
  - Priority levels (P1-P5)

### Environment Requirements
- JIRA test instance access
- MCP tool configured with test credentials
- Custom fields created in JIRA project

---

## Test Execution Metrics (Target)

| Metric | Target | Justification |
|---|---|---|
| Unit test execution time | < 5 seconds | Fast feedback for validation logic |
| Integration test execution time | < 30 seconds | MCP tool calls with reasonable timeout |
| E2E test execution time | < 2 minutes | Full workflow with JIRA round-trips |
| Code coverage (unit) | > 90% | Security-critical validation logic |
| Code coverage (integration) | > 80% | All integration paths tested |

---

## Next Steps

1. **Create test implementation plan** - Define test framework and tooling
2. **Set up test JIRA instance** - Configure custom fields matching config.yaml
3. **Implement unit tests** - Start with P0 validation tests (Phase 1)
4. **Implement integration tests** - Test MCP tool integration (Phase 2)
5. **Implement E2E tests** - Validate complete workflow (Phase 3)
6. **Integrate with CI/CD** - Automate test execution on commits

---

**Test Design Complete** ✓

This comprehensive test design provides 33 test scenarios with clear priorities, levels, and justifications. The strategy emphasizes security-critical validation while maintaining efficient test execution through appropriate test level selection.
