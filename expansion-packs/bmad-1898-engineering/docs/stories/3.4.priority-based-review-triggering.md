# Story 3.4: Priority-Based Review Triggering

## Status

Draft

## Story

**As a** security operations team,
**I want** mandatory review for Critical/High vulnerabilities and sampling for Medium/Low,
**so that** QA resources focus on highest-risk tickets.

## Acceptance Criteria

1. P1/P2 vulnerabilities trigger mandatory review
2. P3 vulnerabilities: 25% sampling review
3. P4 vulnerabilities: 10% sampling review
4. P5 vulnerabilities: 5% sampling review
5. Review assignment configurable

## Tasks / Subtasks

- [ ] Define review triggering rules (AC: 1, 2, 3, 4)
  - [ ] P1 (Critical): 100% mandatory review
  - [ ] P2 (High): 100% mandatory review
  - [ ] P3 (Medium): 25% random sampling
  - [ ] P4 (Low): 10% random sampling
  - [ ] P5 (Info): 5% random sampling
  - [ ] Document rationale for each threshold
- [ ] Implement mandatory review logic (AC: 1)
  - [ ] After P1/P2 enrichment, automatically transition to "In Review" status
  - [ ] Assign to review queue
  - [ ] Block remediation until review approved
  - [ ] Notify reviewer
- [ ] Implement sampling review logic (AC: 2, 3, 4)
  - [ ] Generate random number for P3/P4/P5 enrichments
  - [ ] If selected for review: Transition to "In Review"
  - [ ] If not selected: Transition directly to "Remediation Planning"
  - [ ] Log sampling decision
- [ ] Create review assignment configuration (AC: 5)
  - [ ] Define reviewer assignment rules in config.yaml
  - [ ] Support round-robin assignment
  - [ ] Support skill-based assignment
  - [ ] Support priority-based assignment (P1/P2 ‚Üí senior reviewers)
  - [ ] Allow manual override
- [ ] Implement assignment automation
  - [ ] Auto-assign to next available reviewer
  - [ ] Consider reviewer workload
  - [ ] Honor reviewer specializations
  - [ ] Send notifications
- [ ] Create sampling transparency report
  - [ ] Log all sampling decisions
  - [ ] Report: "Ticket AOD-1234 (P3) randomly selected for review (25% sampling)"
  - [ ] Track sampling statistics (actual vs. target percentages)

## Dev Notes

### Source Attribution & Context

**Requirements Source:**

- **Parent Epic:** Epic 3 - Workflow Integration and Orchestration (docs/prd/epic-3-workflow-integration.md)
  - Story 3.4 specification (Epic 3:128-151)
  - Sampling rate rationale (Epic 3:137-140)
  - Integration requirements (Epic 3:142-149)

- **Priority Framework:** Story 1.7 - Multi-Factor Priority Assessment (docs/stories/1.7.multi-factor-priority-assessment.md)
  - P1-P5 priority levels defined (Story 1.7:54-59, 218-246)
  - Priority criteria and SLA timelines (Story 1.7:218-246)
  - Multi-factor scoring algorithm (Story 1.7:131-211)
  - SLA timelines: P1 (24h), P2 (7d), P3 (30d), P4 (90d), P5 (no SLA)

- **Workflow Context:** Story 3.3 - Vulnerability Lifecycle Workflow (docs/stories/3.3.vulnerability-lifecycle-workflow.md)
  - JIRA workflow states defined (Story 3.3:87-246)
  - Status transitions documented (Story 3.3:248-283)
  - Workflow integration points (Story 3.3:99-246)

- **Review Workflow:** Story 3.2 - Security Analysis Review Workflow (docs/stories/3.2.security-analysis-review-workflow.md)
  - Review workflow stages (Story 3.2:87-247)
  - Priority-based triggering mentioned (Story 3.2:249-264)
  - Review duration target: 15-20 minutes

**Sampling Rate Rationale (Epic 3:137-140, Industry Best Practices):**

- **P1/P2 (100% Mandatory):** Critical/High severity vulnerabilities with short SLAs (24h-7d) require complete QA coverage to prevent high-impact errors. Industry standard for critical security issues.

- **P3 (25% Sampling):** Medium severity with 30-day SLA. 25% sampling rate provides statistical confidence in quality trends while managing reviewer workload. Based on risk-based QA approaches.

- **P4 (10% Sampling):** Low severity with 90-day SLA. 10% sampling sufficient to detect systematic quality issues without overwhelming QA resources.

- **P5 (5% Sampling):** Informational items with no SLA. Minimal sampling for process improvement and trend detection only.

**Source Tree Reference:** See docs/architecture/source-tree.md for expansion pack directory structure and file organization conventions.

### JIRA Workflow States (Story 3.3:87-246)

**Required JIRA Workflow States:**

Organizations must configure these workflow states in their JIRA project for lifecycle workflow integration:

1. **Open** - Initial detection state
2. **In Progress** - Enrichment active
3. **In Review** - QA review (triggered by this story's logic)
4. **Remediation Planning** - Planning phase (destination after review or sampling skip)
5. **Remediation In Progress** - Patching/remediation
6. **Verification** - Testing remediation
7. **Closed** - Terminal state

**Relevant Transitions for This Story (Story 3.3:248-283):**

```yaml
# After enrichment completes, this story determines next transition:

- from: 'In Progress'
  to: 'In Review'
  trigger: Enrichment complete + P1/P2 mandatory review

- from: 'In Progress'
  to: 'Remediation Planning'
  trigger: Enrichment complete + P3/P4/P5 not selected for review

- from: 'In Review'
  to: 'In Progress'
  trigger: Review identifies Critical Issues (re-enrichment needed)

- from: 'In Review'
  to: 'Remediation Planning'
  trigger: Review approved
```

### Review Triggering Rules

```yaml
review_triggers:
  P1:
    review_required: true
    sampling_rate: 100%
    rationale: 'Critical vulnerabilities require 100% QA to prevent high-impact errors'
    assignment: 'senior-reviewer'
    blocking: true

  P2:
    review_required: true
    sampling_rate: 100%
    rationale: 'High vulnerabilities require 100% QA to ensure quality remediation'
    assignment: 'senior-reviewer'
    blocking: true

  P3:
    review_required: false
    sampling_rate: 25%
    rationale: 'Medium vulnerabilities benefit from 25% sampling to maintain quality while managing resources'
    assignment: 'any-reviewer'
    blocking: false

  P4:
    review_required: false
    sampling_rate: 10%
    rationale: 'Low vulnerabilities need minimal QA (10% sampling) to detect systemic issues'
    assignment: 'any-reviewer'
    blocking: false

  P5:
    review_required: false
    sampling_rate: 5%
    rationale: 'Informational items need very low QA (5% sampling) for process improvement'
    assignment: 'any-reviewer'
    blocking: false
```

### Review Triggering Logic

```python
def determine_review_requirement(ticket):
    """
    Determine if ticket requires review based on priority and sampling rules
    """
    priority = ticket.priority  # P1, P2, P3, P4, or P5
    config = load_config("review_triggers")

    trigger_rule = config[priority]

    if trigger_rule.review_required:
        # Mandatory review (P1/P2)
        return ReviewDecision(
            review_required=True,
            reason="Mandatory review for {} priority".format(priority),
            assignment_pool=trigger_rule.assignment,
            blocking=trigger_rule.blocking
        )
    else:
        # Sampling-based review (P3/P4/P5)
        random_value = random.random()  # 0.0 to 1.0
        sampling_threshold = trigger_rule.sampling_rate / 100.0

        if random_value < sampling_threshold:
            # Selected for review
            return ReviewDecision(
                review_required=True,
                reason="Randomly selected for review ({:.0%} sampling)".format(trigger_rule.sampling_rate / 100),
                assignment_pool=trigger_rule.assignment,
                blocking=False
            )
        else:
            # Not selected, proceed directly to remediation
            return ReviewDecision(
                review_required=False,
                reason="Not selected for review ({:.0%} sampling)".format(trigger_rule.sampling_rate / 100),
                assignment_pool=None,
                blocking=False
            )
```

### Reviewer Assignment Configuration

**Source:** Epic 3 defines configurable reviewer assignment (Epic 3:147), config.yaml stores reviewer configuration (Epic 3:198)

**Note:** The configuration below is an example template. Organizations should customize reviewer names, specializations, capacities, and assignment rules based on their security team structure.

```yaml
reviewer_assignment:
  method: 'priority-weighted-round-robin'

  reviewers:
    - name: 'Alex'
      role: 'senior-reviewer'
      specializations: ['web-vulnerabilities', 'infrastructure']
      max_concurrent: 5
      priorities: ['P1', 'P2', 'P3', 'P4', 'P5']

    - name: 'Jordan'
      role: 'senior-reviewer'
      specializations: ['application-security', 'cryptography']
      max_concurrent: 5
      priorities: ['P1', 'P2', 'P3', 'P4', 'P5']

    - name: 'Taylor'
      role: 'reviewer'
      specializations: ['network-security']
      max_concurrent: 8
      priorities: ['P3', 'P4', 'P5']

  assignment_rules:
    P1:
      pool: ['Alex', 'Jordan']
      method: 'least-loaded'
      fallback: 'any-senior-reviewer'

    P2:
      pool: ['Alex', 'Jordan']
      method: 'least-loaded'
      fallback: 'any-senior-reviewer'

    P3:
      pool: ['Alex', 'Jordan', 'Taylor']
      method: 'round-robin'
      fallback: 'any-available-reviewer'

    P4:
      pool: ['Taylor']
      method: 'round-robin'
      fallback: 'any-available-reviewer'

    P5:
      pool: ['Taylor']
      method: 'round-robin'
      fallback: 'any-available-reviewer'

  notification:
    method: 'jira-assignment'  # Primary: JIRA ticket assignment with auto-notification
    additional: ['email', 'slack']  # Optional: Additional notification channels

    email:
      enabled: false  # Set to true to enable email notifications
      smtp_server: 'smtp.example.com'
      from_address: 'security-ops@example.com'
      subject_template: '[JIRA] {ticket_id} ({priority}) assigned for review'
      body_template: |
        You have been assigned to review security ticket {ticket_id}.

        Priority: {priority}
        CVE: {cve_id}
        Review Type: {review_type}  # "Mandatory" or "Sampling"

        Access ticket: {jira_url}

    slack:
      enabled: false  # Set to true to enable Slack notifications
      webhook_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
      channel: '#security-reviews'
      message_template: |
        üîç *Review Assignment*

        *Ticket:* <{jira_url}|{ticket_id}>
        *Priority:* {priority}
        *Reviewer:* @{reviewer_name}
        *Type:* {review_type}

    error_handling:
      fallback_to_jira_only: true  # If email/Slack fail, still assign in JIRA
      retry_count: 2
      log_failures: true
```

**Notification Integration Notes:**

- **Primary Method (JIRA Assignment):** Always executed. Uses Atlassian MCP to assign ticket to reviewer. JIRA automatically sends email notification if reviewer has email notifications enabled.

- **Email Notifications (Optional):** Requires SMTP configuration. If enabled, sends explicit email with review details. Useful for organizations not using JIRA email notifications.

- **Slack Notifications (Optional):** Requires Slack webhook integration. Sends message to designated channel mentioning assigned reviewer. Useful for real-time team awareness.

- **Error Handling:** If additional notification methods (email/Slack) fail, workflow still completes JIRA assignment and logs error. Review assignment is never blocked by notification failures.

### Workflow Integration

**After Enrichment Complete:**

```python
def post_enrichment_workflow(ticket):
    """
    Determine next step after enrichment based on priority
    """
    priority = ticket.priority

    # Determine if review required
    review_decision = determine_review_requirement(ticket)

    if review_decision.review_required:
        # Transition to review
        jira.transition_issue(ticket.id, "In Review")

        # Assign reviewer
        reviewer = assign_reviewer(priority, review_decision.assignment_pool)
        jira.assign_issue(ticket.id, reviewer)

        # Add comment
        comment = f"""
üîç **Review Required**

This {priority} ticket has been assigned for quality assurance review.

**Reason:** {review_decision.reason}
**Assigned Reviewer:** {reviewer}
**Blocking Remediation:** {"Yes" if review_decision.blocking else "No"}
        """
        jira.add_comment(ticket.id, comment)

        # Notify reviewer
        notify_reviewer(reviewer, ticket.id)

    else:
        # Skip review, proceed to remediation
        jira.transition_issue(ticket.id, "Remediation Planning")

        # Add comment
        comment = f"""
‚úÖ **Review Skipped**

This {priority} ticket is proceeding directly to remediation planning.

**Reason:** {review_decision.reason}
        """
        jira.add_comment(ticket.id, comment)
```

### Sampling Statistics Tracking

**Log Format:**

```csv
ticket_id,priority,review_decision,reason,timestamp,reviewer
AOD-1234,P1,required,Mandatory review for P1 priority,2025-11-06T10:30:00Z,Alex
AOD-1235,P3,required,Randomly selected for review (25% sampling),2025-11-06T11:00:00Z,Taylor
AOD-1236,P3,not_required,Not selected for review (25% sampling),2025-11-06T11:15:00Z,
AOD-1237,P2,required,Mandatory review for P2 priority,2025-11-06T12:00:00Z,Jordan
```

**Sampling Statistics Report:**

```markdown
# Review Sampling Statistics - 2025-11

## Overall

- Total Tickets: 150
- Reviewed: 45 (30%)
- Skipped: 105 (70%)

## By Priority

| Priority | Total | Mandatory | Sampled  | Skipped | Review Rate |
| -------- | ----- | --------- | -------- | ------- | ----------- |
| P1       | 10    | 10 (100%) | 0        | 0       | 100%        |
| P2       | 20    | 20 (100%) | 0        | 0       | 100%        |
| P3       | 60    | 0         | 15 (25%) | 45      | 25%         |
| P4       | 50    | 0         | 5 (10%)  | 45      | 10%         |
| P5       | 10    | 0         | 0 (0%)   | 10      | 0%          |

**Target Compliance:**

- P3: Target 25%, Actual 25% ‚úÖ
- P4: Target 10%, Actual 10% ‚úÖ
- P5: Target 5%, Actual 0% ‚ö†Ô∏è (insufficient volume)
```

### Testing

**Test Framework:** pytest (consistent with expansion pack testing standards from Story 1.7:323)

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/workflows/`

**Test File:** `test_priority_based_review_triggering.py`

**Test Standards:**

- Unit tests using pytest for priority-based triggering logic
- Statistical validation for sampling rates (run 100+ iterations per priority level)
- Integration tests with JIRA workflow transitions
- Pytest fixtures for mock ticket data and reviewer pools
- Parametrized tests for different priority levels and scenarios
- Test mandatory review for P1/P2
- Test sampling logic for P3/P4/P5
- Verify sampling rates match targets (¬±5% tolerance for statistical variance)
- Test reviewer assignment logic (round-robin, least-loaded, skill-based)
- Test notification delivery (JIRA assignment + optional email/Slack)

**Test Cases:**

1. P1 ticket: Always requires review
2. P2 ticket: Always requires review
3. P3 tickets (100): ~25 should require review (20-30 acceptable)
4. P4 tickets (100): ~10 should require review (5-15 acceptable)
5. P5 tickets (100): ~5 should require review (0-10 acceptable)
6. Reviewer assignment: P1/P2 assigned to senior reviewers
7. Workload balancing: Reviews distributed evenly

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                                                                                                             | Author     |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-11-06 | 1.0     | Initial story creation                                                                                                                                                                                                                                                                                                                                                                                                                                  | Sarah (PO) |
| 2025-11-08 | 1.1     | Remediated validation issues: Added comprehensive source attribution section (Epic 3, Story 1.7, Story 3.2, Story 3.3 references), documented JIRA workflow states and transitions from Story 3.3, added sampling rate rationale from Epic 3, specified pytest testing framework with test file name and standards, added reviewer assignment source reference and customization note, added detailed notification integration configuration and notes | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_To be populated after QA review_
