# Story 3.4: Priority-Based Review Triggering

## Status

Draft

## Story

**As a** security operations team,
**I want** mandatory review for Critical/High vulnerabilities and sampling for Medium/Low,
**so that** QA resources focus on highest-risk tickets.

## Acceptance Criteria

1. P1/P2 vulnerabilities trigger mandatory review
2. P3 vulnerabilities: 25% sampling review
3. P4 vulnerabilities: 10% sampling review
4. P5 vulnerabilities: 5% sampling review
5. Review assignment configurable

## Tasks / Subtasks

- [ ] Define review triggering rules (AC: 1, 2, 3, 4)
  - [ ] P1 (Critical): 100% mandatory review
  - [ ] P2 (High): 100% mandatory review
  - [ ] P3 (Medium): 25% random sampling
  - [ ] P4 (Low): 10% random sampling
  - [ ] P5 (Info): 5% random sampling
  - [ ] Document rationale for each threshold
- [ ] Implement mandatory review logic (AC: 1)
  - [ ] After P1/P2 enrichment, automatically transition to "In Review" status
  - [ ] Assign to review queue
  - [ ] Block remediation until review approved
  - [ ] Notify reviewer
- [ ] Implement sampling review logic (AC: 2, 3, 4)
  - [ ] Generate random number for P3/P4/P5 enrichments
  - [ ] If selected for review: Transition to "In Review"
  - [ ] If not selected: Transition directly to "Remediation Planning"
  - [ ] Log sampling decision
- [ ] Create review assignment configuration (AC: 5)
  - [ ] Define reviewer assignment rules in config.yaml
  - [ ] Support round-robin assignment
  - [ ] Support skill-based assignment
  - [ ] Support priority-based assignment (P1/P2 â†’ senior reviewers)
  - [ ] Allow manual override
- [ ] Implement assignment automation
  - [ ] Auto-assign to next available reviewer
  - [ ] Consider reviewer workload
  - [ ] Honor reviewer specializations
  - [ ] Send notifications
- [ ] Create sampling transparency report
  - [ ] Log all sampling decisions
  - [ ] Report: "Ticket AOD-1234 (P3) randomly selected for review (25% sampling)"
  - [ ] Track sampling statistics (actual vs. target percentages)

## Dev Notes

### Review Triggering Rules

```yaml
review_triggers:
  P1:
    review_required: true
    sampling_rate: 100%
    rationale: 'Critical vulnerabilities require 100% QA to prevent high-impact errors'
    assignment: 'senior-reviewer'
    blocking: true

  P2:
    review_required: true
    sampling_rate: 100%
    rationale: 'High vulnerabilities require 100% QA to ensure quality remediation'
    assignment: 'senior-reviewer'
    blocking: true

  P3:
    review_required: false
    sampling_rate: 25%
    rationale: 'Medium vulnerabilities benefit from 25% sampling to maintain quality while managing resources'
    assignment: 'any-reviewer'
    blocking: false

  P4:
    review_required: false
    sampling_rate: 10%
    rationale: 'Low vulnerabilities need minimal QA (10% sampling) to detect systemic issues'
    assignment: 'any-reviewer'
    blocking: false

  P5:
    review_required: false
    sampling_rate: 5%
    rationale: 'Informational items need very low QA (5% sampling) for process improvement'
    assignment: 'any-reviewer'
    blocking: false
```

### Review Triggering Logic

```python
def determine_review_requirement(ticket):
    """
    Determine if ticket requires review based on priority and sampling rules
    """
    priority = ticket.priority  # P1, P2, P3, P4, or P5
    config = load_config("review_triggers")

    trigger_rule = config[priority]

    if trigger_rule.review_required:
        # Mandatory review (P1/P2)
        return ReviewDecision(
            review_required=True,
            reason="Mandatory review for {} priority".format(priority),
            assignment_pool=trigger_rule.assignment,
            blocking=trigger_rule.blocking
        )
    else:
        # Sampling-based review (P3/P4/P5)
        random_value = random.random()  # 0.0 to 1.0
        sampling_threshold = trigger_rule.sampling_rate / 100.0

        if random_value < sampling_threshold:
            # Selected for review
            return ReviewDecision(
                review_required=True,
                reason="Randomly selected for review ({:.0%} sampling)".format(trigger_rule.sampling_rate / 100),
                assignment_pool=trigger_rule.assignment,
                blocking=False
            )
        else:
            # Not selected, proceed directly to remediation
            return ReviewDecision(
                review_required=False,
                reason="Not selected for review ({:.0%} sampling)".format(trigger_rule.sampling_rate / 100),
                assignment_pool=None,
                blocking=False
            )
```

### Reviewer Assignment Configuration

```yaml
reviewer_assignment:
  method: 'priority-weighted-round-robin'

  reviewers:
    - name: 'Alex'
      role: 'senior-reviewer'
      specializations: ['web-vulnerabilities', 'infrastructure']
      max_concurrent: 5
      priorities: ['P1', 'P2', 'P3', 'P4', 'P5']

    - name: 'Jordan'
      role: 'senior-reviewer'
      specializations: ['application-security', 'cryptography']
      max_concurrent: 5
      priorities: ['P1', 'P2', 'P3', 'P4', 'P5']

    - name: 'Taylor'
      role: 'reviewer'
      specializations: ['network-security']
      max_concurrent: 8
      priorities: ['P3', 'P4', 'P5']

  assignment_rules:
    P1:
      pool: ['Alex', 'Jordan']
      method: 'least-loaded'
      fallback: 'any-senior-reviewer'

    P2:
      pool: ['Alex', 'Jordan']
      method: 'least-loaded'
      fallback: 'any-senior-reviewer'

    P3:
      pool: ['Alex', 'Jordan', 'Taylor']
      method: 'round-robin'
      fallback: 'any-available-reviewer'

    P4:
      pool: ['Taylor']
      method: 'round-robin'
      fallback: 'any-available-reviewer'

    P5:
      pool: ['Taylor']
      method: 'round-robin'
      fallback: 'any-available-reviewer'

  notification:
    method: 'jira-assignment'
    additional: ['email', 'slack']
```

### Workflow Integration

**After Enrichment Complete:**

```python
def post_enrichment_workflow(ticket):
    """
    Determine next step after enrichment based on priority
    """
    priority = ticket.priority

    # Determine if review required
    review_decision = determine_review_requirement(ticket)

    if review_decision.review_required:
        # Transition to review
        jira.transition_issue(ticket.id, "In Review")

        # Assign reviewer
        reviewer = assign_reviewer(priority, review_decision.assignment_pool)
        jira.assign_issue(ticket.id, reviewer)

        # Add comment
        comment = f"""
ðŸ” **Review Required**

This {priority} ticket has been assigned for quality assurance review.

**Reason:** {review_decision.reason}
**Assigned Reviewer:** {reviewer}
**Blocking Remediation:** {"Yes" if review_decision.blocking else "No"}
        """
        jira.add_comment(ticket.id, comment)

        # Notify reviewer
        notify_reviewer(reviewer, ticket.id)

    else:
        # Skip review, proceed to remediation
        jira.transition_issue(ticket.id, "Remediation Planning")

        # Add comment
        comment = f"""
âœ… **Review Skipped**

This {priority} ticket is proceeding directly to remediation planning.

**Reason:** {review_decision.reason}
        """
        jira.add_comment(ticket.id, comment)
```

### Sampling Statistics Tracking

**Log Format:**

```csv
ticket_id,priority,review_decision,reason,timestamp,reviewer
AOD-1234,P1,required,Mandatory review for P1 priority,2025-11-06T10:30:00Z,Alex
AOD-1235,P3,required,Randomly selected for review (25% sampling),2025-11-06T11:00:00Z,Taylor
AOD-1236,P3,not_required,Not selected for review (25% sampling),2025-11-06T11:15:00Z,
AOD-1237,P2,required,Mandatory review for P2 priority,2025-11-06T12:00:00Z,Jordan
```

**Sampling Statistics Report:**

```markdown
# Review Sampling Statistics - 2025-11

## Overall

- Total Tickets: 150
- Reviewed: 45 (30%)
- Skipped: 105 (70%)

## By Priority

| Priority | Total | Mandatory | Sampled  | Skipped | Review Rate |
| -------- | ----- | --------- | -------- | ------- | ----------- |
| P1       | 10    | 10 (100%) | 0        | 0       | 100%        |
| P2       | 20    | 20 (100%) | 0        | 0       | 100%        |
| P3       | 60    | 0         | 15 (25%) | 45      | 25%         |
| P4       | 50    | 0         | 5 (10%)  | 45      | 10%         |
| P5       | 10    | 0         | 0 (0%)   | 10      | 0%          |

**Target Compliance:**

- P3: Target 25%, Actual 25% âœ…
- P4: Target 10%, Actual 10% âœ…
- P5: Target 5%, Actual 0% âš ï¸ (insufficient volume)
```

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/workflows/`

**Test Standards:**

- Test mandatory review for P1/P2
- Test sampling logic for P3/P4/P5
- Verify sampling rates match targets
- Test reviewer assignment logic
- Test notification delivery

**Test Cases:**

1. P1 ticket: Always requires review
2. P2 ticket: Always requires review
3. P3 tickets (100): ~25 should require review (20-30 acceptable)
4. P4 tickets (100): ~10 should require review (5-15 acceptable)
5. P5 tickets (100): ~5 should require review (0-10 acceptable)
6. Reviewer assignment: P1/P2 assigned to senior reviewers
7. Workload balancing: Reviews distributed evenly

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-06 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_To be populated after QA review_
