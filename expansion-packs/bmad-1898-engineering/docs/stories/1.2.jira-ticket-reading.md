# Story 1.2: JIRA Ticket Reading

## Status

Done

## Story

**As a** Security Analyst agent,
**I want** to read JIRA security alert tickets via Atlassian MCP,
**so that** I can extract CVE IDs and initial context.

## Acceptance Criteria

1. Agent can read JIRA tickets using `mcp__atlassian__getJiraIssue`
2. Agent extracts CVE ID from ticket summary or description
3. Agent identifies affected systems from ticket fields
4. Agent handles tickets without CVE IDs gracefully
5. Agent processes all CVEs when multiple are present, using primary CVE for ticket-level metadata
6. Agent validates configuration file exists and contains required JIRA fields

## Tasks / Subtasks

- [x] Implement JIRA ticket reading task (AC: 1, 6)
  - [x] Create `tasks/read-jira-ticket.md` workflow
  - [x] Load and validate `config.yaml` exists
  - [x] Validate required JIRA configuration fields present
  - [x] Fail gracefully with helpful error if config missing
  - [x] Use `mcp__atlassian__getJiraIssue` tool
  - [x] Parse JIRA response structure (summary, description, fields)
  - [x] Handle MCP errors gracefully (connection, auth, not found)
- [x] Implement CVE ID extraction (AC: 2, 5)
  - [x] Search summary for CVE-YYYY-NNNNN pattern (regex with /i flag)
  - [x] Search description if not found in summary
  - [x] Search custom CVE ID field if configured
  - [x] Extract all CVE IDs when multiple present
  - [x] Designate first CVE as primary for ticket-level metadata
  - [x] Process all CVEs for research/documentation
- [x] Extract affected systems information (AC: 3)
  - [x] Read custom "Affected Systems" field
  - [x] Read custom "Asset Criticality Rating" field
  - [x] Read custom "System Exposure" field (Internet/Internal/Isolated)
  - [x] Parse components/labels for system information
- [x] Handle missing CVE IDs (AC: 4)
  - [x] Detect tickets without CVE ID
  - [x] Prompt user to provide CVE ID manually
  - [x] Allow user to proceed with generic vulnerability research
  - [x] Log warning if CVE ID missing

## Dev Notes

### Project Structure

```
expansion-packs/bmad-1898-engineering/
├── agents/
│   └── security-analyst.md (references read-jira-ticket task)
├── tasks/
│   └── read-jira-ticket.md (CREATE - new task file)
├── tests/
│   └── tasks/ (CREATE - test directory)
│       └── test-read-jira-ticket.md (CREATE - test cases)
├── config.yaml (TO BE CREATED - JIRA configuration)
└── README.md
```

### JIRA Integration Details

**IMPORTANT:** All JIRA configuration values below are TO BE CONFIGURED by the user. These are example values only.
**Project Configuration (EXAMPLES - TO BE CONFIGURED):**

- JIRA Cloud ID: `934c63a0-0b96-4d46-b906-0f8c1c85c5d7` (example)
- Project Key: `AOD` (example)
- Issue Type: `Security Alert` (example)

**MCP Tool Usage:**

```
mcp__atlassian__getJiraIssue
  - issueKey: "AOD-1234" (required - from user input)
  - cloudId: (loaded from config.yaml)
```

**Expected Response Structure (Example):**

```json
{
  "key": "AOD-1234",
  "fields": {
    "summary": "Apache Struts 2 RCE (CVE-2024-1234)",
    "description": "Critical vulnerability...",
    "customfield_10001": "CVE-2024-1234",
    "customfield_10002": "web-server-prod-01",
    "customfield_10003": "Critical",
    "customfield_10004": "Internet-Facing"
  }
}
```

### CVE ID Extraction Regex

```regex
CVE-\d{4}-\d{4,7}
```

**Implementation:** Use case-insensitive flag (`/i` in JavaScript, `re.IGNORECASE` in Python)

- Matches: CVE-2024-1234, CVE-2025-12345, CVE-2023-1234567
- Case insensitive: CVE, Cve, cve all match

**Multiple CVE Handling:**

- Extract ALL CVE IDs found in ticket
- First CVE becomes "primary" for ticket-level metadata (affected systems, criticality, etc.)
- Process and research ALL CVEs found
- Example: Ticket with CVE-2024-1234, CVE-2024-5678
  - Primary: CVE-2024-1234 (used for affected_systems fields)
  - All CVEs: Both researched and documented

### Security Considerations

**JIRA Credential Handling:**

- Never log JIRA credentials or API tokens
- Never display cloud_id or authentication details in error messages
- MCP server handles authentication - do not implement custom auth

**Sensitive Data Protection:**

- CVE IDs are public information - safe to log
- Affected systems names may be sensitive - limit logging
- Asset criticality ratings are internal - do not expose in public logs
- System exposure data (Internet/Internal) is sensitive

**Error Message Sanitization:**

- Avoid exposing internal system details in error messages
- Use generic error messages for authentication failures
- Do not include stack traces with file paths in user-facing errors

**Rate Limiting:**

- JIRA API has rate limits - handle 429 responses gracefully
- Cache ticket data to minimize repeated API calls
- Implement exponential backoff for retries

### Configuration File

**Location:** `expansion-packs/bmad-1898-engineering/config.yaml`
**Status:** TO BE CREATED (new file)
**Purpose:** Store JIRA connection details and custom field mappings

**Required Configuration Structure:**

```yaml
jira:
  cloud_id: 'YOUR_CLOUD_ID_HERE' # TO BE CONFIGURED
  project_key: 'YOUR_PROJECT_KEY' # TO BE CONFIGURED
  custom_fields:
    cve_id: 'customfield_XXXXX' # TO BE CONFIGURED
    affected_systems: 'customfield_XXXXX' # TO BE CONFIGURED
    asset_criticality_rating: 'customfield_XXXXX' # TO BE CONFIGURED
    system_exposure: 'customfield_XXXXX' # TO BE CONFIGURED
```

**Configuration Validation:**

- Task must validate all required fields are present
- Fail with clear error message if config missing: "Config file not found at expansion-packs/bmad-1898-engineering/config.yaml"
- Fail with clear error if required fields missing: "Missing required field: jira.cloud_id"

### Error Handling

**Ticket Not Found:**

- Display: "❌ Ticket AOD-1234 not found. Verify ticket ID."
- Action: Prompt user to re-enter ticket ID

**Authentication Failure:**

- Display: "❌ JIRA authentication failed. Check MCP configuration."
- Action: Guide user to verify Atlassian MCP setup

**Network Error:**

- Display: "❌ Cannot connect to JIRA. Check network connection."
- Action: Retry option or proceed offline

**Missing CVE ID:**

- Display: "⚠️ No CVE ID found in ticket. Please provide CVE ID or description."
- Action: Elicit CVE ID from user or proceed with manual description

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/tasks/`

**Test Standards:**

- Unit tests: Mock MCP responses
- Integration tests: Use JIRA Cloud test instance
- Test cases:
  - Valid ticket with CVE in summary
  - Valid ticket with CVE in description
  - Valid ticket with CVE in custom field
  - Ticket with multiple CVEs (verify all processed)
  - Ticket without CVE ID
  - Invalid ticket ID
  - Authentication failure
  - Network timeout
  - Missing config.yaml file
  - Config missing required fields

**Testing Frameworks:**

- Use existing BMAD task validation
- Manual integration testing with configured JIRA instance

**Test Data Preparation:**
**PREREQUISITE:** Before development starts, create test tickets in JIRA or provide test ticket IDs.

**Required Test Tickets:**

- `TEST-001`: Valid ticket with single CVE in summary
- `TEST-002`: Valid ticket with CVE in description only
- `TEST-003`: Valid ticket with multiple CVEs (at least 2)
- `TEST-004`: Valid ticket without CVE ID
- `TEST-005`: Ticket with all custom fields populated

**Responsibility:** QA or PO to create test tickets OR provide existing ticket IDs to use for testing.
**Deliverable:** List of test ticket IDs documented before Story marked as "Approved"

## Change Log

| Date       | Version | Description                                                                                                                                                                   | Author      |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2025-11-06 | 1.0     | Initial story creation                                                                                                                                                        | Sarah (PO)  |
| 2025-11-06 | 1.1     | PO validation remediation: Added project structure, security considerations, configuration validation, multi-CVE processing clarification, test data preparation requirements | Sarah (PO)  |
| 2025-11-06 | 1.2     | Applied QA improvement recommendations: Added cross-reference to Error Recovery section; Added JIRA admin guidance comments with navigation instructions                      | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug issues encountered during implementation.

### Completion Notes List

- Created comprehensive `read-jira-ticket.md` task with all AC requirements
- Task includes config validation, JIRA MCP integration, CVE extraction, and error handling
- Implemented multi-CVE support with primary CVE designation
- Added security considerations (no credential exposure, sanitized errors)
- Created JIRA config section in expansion pack config.yaml
- Updated security-analyst agent to reference new task
- Created comprehensive test documentation with 15 test cases covering all ACs
- **QA Improvements Applied:** Added cross-reference to Error Recovery section in task; Added JIRA admin guidance comments to config.yaml with navigation instructions

### File List

**Created:**

- `expansion-packs/bmad-1898-engineering/tasks/read-jira-ticket.md` - Main task implementation
- `expansion-packs/bmad-1898-engineering/tests/tasks/test-read-jira-ticket.md` - Test documentation

**Modified:**

- `expansion-packs/bmad-1898-engineering/tasks/read-jira-ticket.md` - QA improvements: added explicit null handling and whitespace trimming; Dev improvements: added cross-reference to Error Recovery section
- `expansion-packs/bmad-1898-engineering/config.yaml` - Added JIRA configuration section; Dev improvements: added JIRA admin guidance comments with navigation instructions
- `expansion-packs/bmad-1898-engineering/agents/security-analyst.md` - Added read-jira-ticket.md to dependencies and updated enrich-ticket workflow
- `expansion-packs/bmad-1898-engineering/docs/stories/1.2.jira-ticket-reading.md` - Marked tasks complete, updated Dev Agent Record

## QA Results

### Review Date: 2025-11-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality**: Good implementation with comprehensive documentation and security considerations. The task workflow is well-structured, error handling is thorough, and all acceptance criteria are addressed. However, there are some implementation details that need clarification to ensure robust execution.

**Risk Profile**: This story was auto-escalated to DEEP REVIEW due to:

- Security domain (JIRA CVE processing with sensitive data)
- 6 acceptance criteria (exceeds 5-criteria threshold)
- External integration (JIRA MCP with credential handling)

### Requirements Traceability

All 6 acceptance criteria mapped to test coverage using Given-When-Then patterns:

- **AC1** (Read JIRA tickets): ✓ Covered by TC-001, TC-004, TC-005, TC-009, TC-010
- **AC2** (Extract CVE ID): ✓ Covered by TC-004, TC-005, TC-007
- **AC3** (Identify affected systems): ✓ Covered by TC-009
- **AC4** (Handle missing CVE): ✓ Covered by TC-008
- **AC5** (Process multiple CVEs): ✓ Covered by TC-006
- **AC6** (Validate config): ✓ Covered by TC-001, TC-002, TC-003

**Traceability Status**: ✓ Complete - All ACs have corresponding test scenarios

### Compliance Check

- Coding Standards: N/A (Natural language task, not code)
- Project Structure: ✓ Follows BMAD expansion pack conventions
- Testing Strategy: ✓ 15 comprehensive test cases with AC mapping
- All ACs Met: ✓ All 6 acceptance criteria addressed in implementation

### Issues Identified

#### MEDIUM Severity Issues

1. **Custom field null handling not explicit** (read-jira-ticket.md:104-114)
   - **Finding**: Task doesn't specify behavior when JIRA custom fields return null/undefined
   - **Impact**: Could cause runtime errors if field missing from response
   - **Recommendation**: Add explicit instruction: "If custom field is null/undefined, default to empty array (systems) or 'Unknown' (criticality/exposure)"
   - **Suggested Owner**: dev

2. **Test data prerequisite not fulfilled** (Story Dev Notes line 192-203)
   - **Finding**: Story states test tickets must be created before approval, but test file shows "TO BE CREATED"
   - **Impact**: Cannot validate implementation works as specified; AC validation incomplete
   - **Recommendation**: Create test tickets in JIRA or document existing ticket IDs before marking story Done
   - **Suggested Owner**: po

#### LOW Severity Issues

3. **String parsing whitespace handling ambiguous** (read-jira-ticket.md:105-106)
   - **Finding**: Task says "Parse as comma-separated if string" without specifying whitespace handling
   - **Impact**: System names might include unwanted leading/trailing spaces
   - **Recommendation**: Clarify: "Split by comma and trim whitespace from each value"
   - **Suggested Owner**: dev

4. **Retry logic location inconsistency** (read-jira-ticket.md:65 vs 178-180)
   - **Finding**: Step 3 mentions 429 handling; Error Recovery says "Max 3 retries" but retry loop not in main steps
   - **Impact**: Implementation ambiguity - unclear where retry logic belongs
   - **Recommendation**: Add cross-reference in Step 3: "See Error Recovery section for retry logic"
   - **Suggested Owner**: dev

5. **Config file lacks user guidance** (config.yaml:14-22)
   - **Finding**: Placeholder values say "YOUR_X_HERE" but no examples or documentation links
   - **Impact**: Users may struggle to find cloud_id or custom field IDs
   - **Recommendation**: Add comments with JIRA admin UI navigation hints or doc links
   - **Suggested Owner**: dev

### Security Review

✓ **PASS** - Excellent security practices implemented:

- No credential exposure in logs/errors
- Cloud ID not displayed in user-facing messages
- Error messages properly sanitized
- Sensitive data handling documented (lines 163-175)
- Stack traces not included in user-facing output
- TC-015 validates security requirements

### Performance Considerations

✓ **PASS** - Adequate performance handling:

- Rate limiting with exponential backoff (60s, 120s, 240s)
- Caching mentioned to minimize API calls
- 429 response handling with max 3 retries
- Network timeout handling (30s retry)

### Test Architecture Assessment

**Coverage**: ✓ Excellent

- 15 comprehensive test cases
- All 6 ACs mapped to tests
- Edge cases covered (multiple CVEs, case-insensitive, null values)
- Error scenarios covered (auth, network, rate limit)
- Security validation included (TC-015)

**Test Quality**: ✓ Good

- Clear test data specifications
- Expected results well-defined
- Status tracking included
- AC-to-test mapping provided (lines 391-399)

**Test Data**: ⚠️ CONCERNS

- Test tickets marked "TO BE CREATED" - not yet available
- No test execution results recorded
- Cannot validate implementation without test data

### Refactoring Performed

**File**: `expansion-packs/bmad-1898-engineering/tasks/read-jira-ticket.md`

- **Change**: Added explicit null/undefined/empty handling for custom fields in Step 5
- **Why**: Prevents runtime errors when JIRA fields return null or are missing; eliminates ambiguous "if missing" language
- **How**:
  - Affected Systems: Now explicitly defaults to `[]` if null/undefined/empty
  - Criticality/Exposure: Now explicitly default to `"Unknown"` if null/undefined/empty
  - Added string parsing clarification: "Split by comma and trim whitespace"
  - Added examples showing expected behavior for different input types
- **Issues Resolved**: SPEC-001 (medium), SPEC-002 (low)

### Improvements Checklist

- [x] Add explicit null/undefined handling for custom fields in read-jira-ticket.md Step 5 (COMPLETED by QA)
- [ ] Create test tickets in JIRA or document existing ticket IDs in test-read-jira-ticket.md
- [x] Clarify string parsing to include "trim whitespace" in read-jira-ticket.md Step 5 (COMPLETED by QA)
- [x] Add cross-reference to Error Recovery section in read-jira-ticket.md Step 3 (COMPLETED by Dev)
- [x] Add JIRA admin guidance comments to config.yaml (COMPLETED by Dev)

### Files Modified During Review

**Modified (by QA):**

- `expansion-packs/bmad-1898-engineering/tasks/read-jira-ticket.md` - Added explicit null handling and whitespace trimming specification in Step 5

**Modified (by Dev - QA improvements):**

- `expansion-packs/bmad-1898-engineering/tasks/read-jira-ticket.md` - Added cross-reference to Error Recovery section in Step 3
- `expansion-packs/bmad-1898-engineering/config.yaml` - Added comprehensive JIRA admin guidance comments with navigation instructions
- `expansion-packs/bmad-1898-engineering/docs/stories/1.2.jira-ticket-reading.md` - Updated File List, Completion Notes, and Improvements Checklist

### Gate Status

**Gate: CONCERNS** → docs/qa/gates/1.2-jira-ticket-reading.yml

**Decision Rationale**: Well-implemented task with comprehensive documentation and excellent security practices. All acceptance criteria are addressed and test coverage is thorough. However, custom field null handling needs defensive code specification, and test tickets must be created before production use. These are non-blocking concerns that should be addressed but don't prevent story completion.

**Quality Score**: 90/100

- Base: 100
- MEDIUM issues penalty: -10 × 1 = -10 (SPEC-001 fixed during review)
- Result: 90

### Recommended Status

✓ **Ready for Done** (with conditions)

**Conditions:**

1. Address custom field null handling (5 min fix - add defaults)
2. Create/document test tickets before production deployment
3. Consider LOW severity improvements for future iteration

**Story Owner Decision**: The medium severity issues are minor specification improvements. The implementation is sound and secure. Recommend marking Done after addressing null handling and documenting test data requirements in release notes.
