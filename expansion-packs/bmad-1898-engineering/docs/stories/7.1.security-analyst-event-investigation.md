# Story 7.1: Security Analyst Event Investigation Capability

## Status

Pending

## Story

**As a** Security Analyst agent,
**I want** to investigate security event alerts (ICS, IDS, SIEM) with structured enrichment,
**so that** I can provide comprehensive analysis of alert disposition, investigation methodology, and incident triage.

## Acceptance Criteria

1. Agent accepts event investigation command with ticket-id parameter
2. Agent detects event alert type (ICS, IDS, SIEM) from ticket metadata
3. Agent performs systematic investigation collecting alert metadata, network identifiers, timeline, evidence
4. Agent determines disposition (True Positive, False Positive, Benign True Positive) with evidence-based reasoning
5. Agent generates structured event investigation document from template
6. Agent updates JIRA ticket with investigation findings
7. Agent handles errors gracefully with clear guidance for incomplete investigations

## Tasks / Subtasks

- [ ] Create investigate-event-alert.md task file scaffolding (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create `expansion-packs/bmad-1898-engineering/tasks/investigate-event-alert.md`
  - [ ] Define task purpose and inputs (ticket-id parameter, event type detection)
  - [ ] Define task outputs (structured investigation document)
  - [ ] Add task header and metadata
- [ ] Design event alert detection and parsing logic (AC: 2)
  - [ ] Detect ICS alerts (Claroty, Nozomi, Dragos platforms)
  - [ ] Detect IDS/IPS alerts (Snort, Suricata, Palo Alto threat signatures)
  - [ ] Detect SIEM alerts (Splunk, QRadar, Sentinel correlation rules)
  - [ ] Parse alert metadata (source, timestamp, severity, rule ID, category)
  - [ ] Extract network identifiers (source/dest IPs, hostnames, ports, protocols)
  - [ ] Build event timeline (detection time, occurrence time, investigation time)
- [ ] Implement systematic investigation workflow (AC: 3)
  - [ ] Step 1: Alert Metadata Collection (source, rule ID, severity, timestamps)
  - [ ] Step 2: Network/Host Identifier Documentation (IPs, hostnames, asset types, criticality)
  - [ ] Step 3: Evidence Collection (relevant logs, correlation with related events, historical context)
  - [ ] Step 4: Asset Context Research (criticality, function, ownership, business impact)
  - [ ] Step 5: Technical Analysis (protocol/port validation, log interpretation, attack vector analysis)
  - [ ] Step 6: Hypothesis-Driven Investigation (alternative explanations, confidence levels)
- [ ] Implement disposition determination logic (AC: 4)
  - [ ] True Positive: Genuine malicious activity confirmed with evidence
  - [ ] False Positive: Benign activity incorrectly flagged, no threat present
  - [ ] Benign True Positive: Real activity detected but authorized/expected (e.g., maintenance, testing)
  - [ ] Reasoning framework: Evidence → Logic → Confidence Level → Disposition
  - [ ] Escalation decision criteria (severity + confidence + business impact)
  - [ ] Next actions specification (containment, tuning, monitoring, closure)
- [ ] Create event-investigation-tmpl.yaml template (AC: 5)
  - [ ] Template structure: Metadata, Executive Summary, Investigation Steps, Evidence, Analysis, Disposition, Recommendations
  - [ ] Variable substitution fields for all investigation data points
  - [ ] Integration with create-doc.md task
  - [ ] Self-contained LLM instructions for document generation
- [ ] Integrate JIRA update functionality (AC: 6)
  - [ ] Call update-jira-fields.md task to update custom fields
  - [ ] Post investigation comment to ticket using post-enrichment-comment.md pattern
  - [ ] Update ticket status based on disposition (if workflow configured)
  - [ ] Handle JIRA API errors gracefully
- [ ] Implement comprehensive error handling (AC: 7)
  - [ ] Handle missing ticket data (incomplete alert information)
  - [ ] Handle unsupported alert types (provide guidance for manual investigation)
  - [ ] Handle incomplete evidence (flag gaps, continue with available data)
  - [ ] Handle JIRA connection failures (save investigation locally, retry logic)
  - [ ] Provide clear user guidance for each error scenario
- [ ] Extend security-analyst.md agent with new command (AC: 1)
  - [ ] Add *investigate-event command definition
  - [ ] Document command usage and workflow
  - [ ] Add investigate-event-alert.md to task dependencies
  - [ ] Add event-investigation-tmpl.yaml to template dependencies
  - [ ] Update agent integration section with MCP tools required

## Dev Notes

### Epic Context

**Epic 7: Security Event Investigation Review Capability**

This story extends the Security Analyst agent (created in Epic 1) to support security event investigations in addition to CVE vulnerability enrichments. The epic addresses a critical gap identified when ticket AOD-4052 (Event Alert type) could not be processed by existing CVE-focused workflows.

**Related Stories:**

- Story 7.1: Security Analyst Event Investigation Capability (This story)
- Story 7.2: Event Investigation Quality Checklists
- Story 7.3: Event Investigation Review Report Template
- Story 7.4: Security Reviewer Auto-Detection and Event Review
- Story 7.5: Event Investigation Workflow Tasks
- Story 7.6: Event Fact Verification Extension
- Story 7.7: Event Investigation Best Practices Knowledge Base
- Story 7.8: Testing and Validation
- Story 7.9: Documentation and Training Materials

**Integration Point:** The Security Analyst agent (defined in Story 1.1) will gain a new `*investigate-event` command that executes the `investigate-event-alert.md` task created by this story.

### Relevant Source Tree

```
expansion-packs/bmad-1898-engineering/
├── agents/
│   └── security-analyst.md              (TO BE MODIFIED - add new command)
├── tasks/
│   ├── enrich-security-ticket.md        (Existing - CVE enrichment)
│   ├── investigate-event-alert.md       (TO BE CREATED - this story)
│   ├── read-jira-ticket.md              (Existing - reuse for event tickets)
│   └── update-jira-fields.md            (Existing - reuse for event updates)
├── templates/
│   ├── security-enrichment-tmpl.yaml    (Existing - CVE enrichment)
│   └── event-investigation-tmpl.yaml    (TO BE CREATED - this story)
├── checklists/
│   └── enrichment-completeness-checklist.md (Existing - for CVE)
├── data/
│   ├── bmad-kb.md                       (Existing - general knowledge)
│   └── event-investigation-patterns.md  (Future - Story 7.7)
├── tests/
│   └── tasks/
│       ├── test-investigate-event-alert.md (TO BE CREATED - this story)
│       └── test-enrich-security-ticket.md  (Existing - CVE tests)
└── docs/
    ├── prd/
    │   └── epic-7-security-event-investigation-review.md (Epic PRD)
    └── stories/
        └── 7.1.security-analyst-event-investigation.md (This file)
```

**Files to Create:**
- `expansion-packs/bmad-1898-engineering/tasks/investigate-event-alert.md`
- `expansion-packs/bmad-1898-engineering/templates/event-investigation-tmpl.yaml`
- `expansion-packs/bmad-1898-engineering/tests/tasks/test-investigate-event-alert.md`

**Files to Modify:**
- `expansion-packs/bmad-1898-engineering/agents/security-analyst.md` (add new command)

### Investigation Methodology Research

Based on comprehensive research of security event investigation best practices, the following principles guide this story's implementation:

**NIST SP 800-61 Framework Integration:**
- Detection & Analysis phase activities (data collection, correlation, prioritization)
- Evidence preservation and chain of custody protocols
- Systematic investigation workflow with clear decision points

**Key Investigation Steps (Industry Best Practices):**
1. Alert Metadata Capture (source, timestamp, severity, rule ID)
2. Network/Host Identifier Documentation (IPs, hostnames, asset types)
3. Timeline Reconstruction (detection time, occurrence time, investigation time)
4. Log Collection and Evidence Preservation
5. Event Correlation (related events, historical patterns)
6. Asset Context Assessment (criticality, function, ownership)
7. Technical Analysis (protocol validation, log interpretation, attack vectors)
8. Hypothesis-Driven Investigation (alternative explanations, confidence levels)

**Disposition Framework:**
- **True Positive (TP):** Malicious activity confirmed with evidence
- **False Positive (FP):** Benign activity incorrectly flagged, no threat
- **Benign True Positive (BTP):** Real activity detected but authorized (maintenance, testing)

**Cognitive Bias Awareness:**
- Confirmation bias (seeking only supporting evidence)
- Anchoring bias (over-reliance on initial alert severity)
- Automation bias (blindly trusting alert systems)
- Availability bias (over-weighting recent/memorable incidents)

### Event Alert Type Detection Heuristics

The task must auto-detect event alert types from ticket metadata and content structure:

**ICS/SCADA Platform Alerts:**
- Platforms: Claroty, Nozomi Networks, Dragos, CyberX
- Indicators: "ICS", "SCADA", "OT", "Operational Technology", "PLC", "HMI", "Modbus", "DNP3"
- Typical metadata: Asset type (PLC, HMI, RTU), Zone (Control, DMZ), Criticality levels
- Example: "Claroty Alert: SSH Connection in Control Environments (#317)"

**IDS/IPS Alerts:**
- Platforms: Snort, Suricata, Palo Alto Threat Prevention, Cisco Firepower
- Indicators: "IDS", "IPS", "Intrusion Detection", "Threat Signature", "SID:"
- Typical metadata: Signature ID, Classification (attempted-admin, trojan-activity), Priority
- Example: "Snort Alert [1:12345:6]: ET EXPLOIT Known Malicious Traffic"

**SIEM Correlation Alerts:**
- Platforms: Splunk, IBM QRadar, Microsoft Sentinel, Elastic Security
- Indicators: "SIEM", "Correlation Rule", "Use Case", "Notable Event", "Incident"
- Typical metadata: Correlation rule ID, Risk score, Aggregated events count
- Example: "Splunk Notable: Multiple Failed Logins Followed by Success (UC-AUTH-001)"

**Detection Logic:**
```
1. Check JIRA Issue Type field:
   - "Event Alert" → Event investigation workflow
   - "ICS Alert" → ICS-specific investigation
   - "Security Vulnerability" → CVE enrichment workflow (existing)

2. Check ticket description/summary keywords:
   - Contains ICS/SCADA terms → ICS alert
   - Contains IDS/IPS terms → IDS alert
   - Contains SIEM terms → SIEM alert
   - Contains "CVE-YYYY-NNNNN" → CVE enrichment (existing)

3. Check comment structure:
   - Contains "Alert Name/Signature" section → Event investigation
   - Contains "Security Analysis Enrichment" heading → CVE enrichment (existing)

4. If ambiguous:
   - Prompt user to specify investigation type
   - Provide context clues from ticket to aid selection
```

### Event Investigation Template Structure

```yaml
template:
  name: event-investigation
  version: 1.0
  description: Structured security event investigation documentation

sections:
  - metadata:
      ticket_id: '{ticket_id}'
      alert_platform: '{alert_platform}' # Claroty, Snort, Splunk, etc.
      alert_id: '{alert_id}'
      alert_name: '{alert_name}'
      alert_severity: '{alert_severity}' # Critical, High, Medium, Low
      detection_timestamp: '{detection_timestamp}'
      analyst_name: '{analyst_name}'
      investigation_date: '{investigation_date}'
      investigation_duration: '{investigation_duration}'

  - executive_summary:
      disposition: '{True Positive|False Positive|Benign True Positive}'
      confidence_level: '{High|Medium|Low}'
      escalation_required: '{Yes|No}'
      summary: '2-3 sentences summarizing investigation findings and disposition reasoning'

  - alert_details:
      alert_source: '{sensor/platform that generated alert}'
      alert_rule_id: '{rule/signature identifier}'
      alert_category: '{category/classification}'
      detection_engine: '{detection engine version}'
      raw_alert_data: |
        {original alert message or relevant excerpts}

  - network_identifiers:
      source_ip: '{source IP address}'
      source_hostname: '{source hostname}'
      source_asset_type: '{server|workstation|ICS device|network equipment}'
      destination_ip: '{destination IP address}'
      destination_hostname: '{destination hostname}'
      destination_asset_type: '{asset type}'
      protocol: '{protocol}'
      port: '{port number}'
      asn_information: '{ASN details if relevant}'

  - timeline:
      event_occurrence_time: '{when activity actually occurred}'
      alert_detection_time: '{when alert was generated}'
      investigation_start_time: '{when investigation began}'
      key_events: |
        - {timestamp}: {event description}
        - {timestamp}: {event description}

  - evidence_collected:
      log_sources_reviewed: '{firewall, IDS, endpoint, application logs}'
      relevant_log_excerpts: |
        {key log entries that informed investigation}
      correlated_events: |
        - {related event 1}
        - {related event 2}
      historical_context: '{previous occurrences, known patterns}'

  - asset_context:
      asset_criticality: '{Critical|High|Medium|Low}'
      asset_function: '{business/operational purpose}'
      asset_ownership: '{responsible team/department}'
      business_impact: '{potential impact if compromised}'
      environmental_factors: '{test vs prod, maintenance windows, known changes}'

  - technical_analysis:
      protocol_port_analysis: '{validation of protocol/port combination}'
      attack_vector_analysis: '{how attack could be executed}'
      log_interpretation: '{detailed analysis of log evidence}'
      ioc_analysis: '{indicators of compromise identified}'
      threat_intelligence: '{correlation with known threats}'

  - investigation_methodology:
      hypothesis: '{initial hypothesis about alert}'
      investigation_steps: |
        1. {step description}
        2. {step description}
      alternative_explanations_considered: |
        - {alternative explanation 1}
        - {alternative explanation 2}
      dead_ends_noted: '{what was checked but yielded no findings}'
      peer_consultation: '{any escalation or consultation performed}'

  - disposition_reasoning:
      disposition: '{True Positive|False Positive|Benign True Positive}'
      confidence_level: '{High|Medium|Low}'
      evidence_summary: |
        {key evidence supporting disposition}
      reasoning: |
        {detailed logic connecting evidence to disposition conclusion}
      alternative_dispositions_considered: |
        {why other dispositions were ruled out}

  - recommendations:
      escalation_decision: '{Escalate|Monitor|Tune|Close}'
      next_actions: |
        - {specific action 1}
        - {specific action 2}
      containment_required: '{Yes|No - if yes, specify actions}'
      tuning_recommendations: |
        {if FP or BTP, suggest alert tuning}
      monitoring_recommendations: |
        {ongoing monitoring suggestions if needed}

  - appendix:
      sources_consulted: |
        - {source 1}
        - {source 2}
      tools_used: |
        - {tool 1}
        - {tool 2}
```

### Example Execution Flow

**Scenario:** Security Analyst investigating AOD-4052 (Claroty ICS Alert - SSH Connection in Control Environments)

1. **User Action:** Security Analyst agent receives command `*investigate-event AOD-4052`
2. **Task Invocation:** Agent loads and executes `investigate-event-alert.md` task with ticket-id parameter
3. **Ticket Reading:** Task calls `read-jira-ticket.md` to fetch ticket data
4. **Alert Type Detection:** Task identifies "Event Alert" Issue Type and Claroty platform from description → ICS alert
5. **Metadata Collection:** Task extracts alert name, severity, sensor, rule ID, category, timestamp
6. **Network Identifiers:** Task extracts source/dest IPs, hostnames, asset types, zone, protocols
7. **Evidence Collection:** Task prompts analyst to provide relevant logs, historical context, asset information
8. **Technical Analysis:** Task guides analysis of SSH traffic patterns, port 22 usage, source/dest legitimacy
9. **Disposition Determination:** Task evaluates evidence, considers alternatives, determines disposition
10. **Document Generation:** Task calls `create-doc.md` with `event-investigation-tmpl.yaml` template
11. **JIRA Update:** Task posts investigation findings as comment, updates custom fields
12. **Completion:** Task returns success with investigation summary

**Expected Output:**
- Structured investigation document (markdown format)
- JIRA ticket updated with investigation comment
- Custom fields updated (Disposition, Confidence Level, Next Actions)
- Investigation metrics captured (duration, evidence sources, disposition)

### MCP Integration Context

**Atlassian JIRA MCP Server** - Read and update JIRA tickets

**Status:** Required (same as existing CVE enrichment workflow)

**Available Tools:**
- `mcp__atlassian__getJiraIssue` - Fetch ticket data
- `mcp__atlassian__updateJiraIssue` - Update ticket fields
- `mcp__atlassian__addComment` - Post investigation findings

**Perplexity MCP Server** - AI-powered research for threat intelligence (optional)

**Status:** Optional (for threat intelligence correlation)

**Available Tools:**
- `mcp__perplexity__search` - Quick lookup of threat intelligence for IPs, domains
- `mcp__perplexity__reason` - Analysis of attack patterns and techniques

**Tool Usage:**
- IP reputation lookup: "Is IP 192.0.2.50 associated with known malicious activity or threat actors?"
- Protocol analysis: "Is SSH traffic from 10.50.1.100 to 10.10.5.25 port 22 typical for ICS environments?"
- Alert pattern research: "Known false positive patterns for Claroty SSH Connection in Control Environments alert"

### References

**Source Documents:**
- Epic 7 PRD: `expansion-packs/bmad-1898-engineering/docs/prd/epic-7-security-event-investigation-review.md`
- Security Analyst Agent: `expansion-packs/bmad-1898-engineering/agents/security-analyst.md` (Story 1.1)
- Existing CVE Enrichment Task: `expansion-packs/bmad-1898-engineering/tasks/enrich-security-ticket.md` (Story 1.4)
- JIRA Ticket Reading Task: `expansion-packs/bmad-1898-engineering/tasks/read-jira-ticket.md` (Story 1.2)

**External Documentation:**
- NIST SP 800-61r2: Computer Security Incident Handling Guide
- SANS Incident Handler's Handbook
- MITRE ATT&CK for ICS: https://attack.mitre.org/matrices/ics/
- CISA ICS Security: https://www.cisa.gov/topics/industrial-control-systems

**Industry Best Practices:**
- SOC Alert Triage Process (comprehensive research completed)
- Security Event Investigation Methodologies
- True Positive vs False Positive Determination
- Cognitive Bias Detection in Security Analysis

### Error Handling

**Missing Ticket Data:**
- Prompt user for required information (alert name, severity, network identifiers)
- Flag gaps: "⚠️ Source IP not available in ticket - manual collection required"
- Continue with available data, document limitations

**Unsupported Alert Type:**
- Detect unsupported platforms or alert formats
- Provide guidance: "This alert type is not fully supported. Manual investigation recommended."
- Offer generic investigation template as fallback

**Incomplete Evidence:**
- Flag evidence gaps: "⚠️ No logs collected - investigation incomplete"
- Require minimum evidence for disposition determination
- Document what evidence was attempted but unavailable

**JIRA Connection Failures:**
- Save investigation document locally
- Retry JIRA update with exponential backoff (max 3 attempts)
- Provide manual posting instructions if all retries fail

**Disposition Uncertainty:**
- Require confidence level assignment (High/Medium/Low)
- If confidence is Low, recommend escalation or peer review
- Document alternative dispositions considered

### Testing

**Test File Location:**
- Unit Tests: `expansion-packs/bmad-1898-engineering/tests/tasks/test-investigate-event-alert.md`

**Test Scenarios:**

_Unit Tests (Mocked JIRA responses):_
1. ICS Alert Detection (Claroty platform)
2. IDS Alert Detection (Snort signature)
3. SIEM Alert Detection (Splunk correlation rule)
4. Complete Investigation Workflow (all steps executed)
5. True Positive Disposition (with high confidence)
6. False Positive Disposition (with reasoning)
7. Benign True Positive Disposition (authorized activity)
8. Missing Evidence Handling (incomplete logs)
9. JIRA Update Success
10. JIRA Update Failure (retry logic)

_Integration Tests (Real JIRA tickets):_
1. AOD-4052 (Claroty ICS alert) - Full investigation workflow
2. Test IDS alert ticket - Snort alert investigation
3. Test SIEM alert ticket - Splunk correlation rule investigation

_Error Handling Tests:_
1. Invalid ticket ID
2. Unsupported alert type
3. Missing critical fields (source IP, timestamp)
4. JIRA connection timeout
5. Malformed alert data

**Test Data:**
- Mock JIRA responses for various alert types
- Sample alert structures (ICS, IDS, SIEM)
- Example log excerpts for evidence
- Known disposition scenarios (TP, FP, BTP)

## Change Log

| Date       | Version | Description             | Author     |
| ---------- | ------- | ----------------------- | ---------- |
| 2025-11-09 | 1.0     | Initial story creation  | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_To be populated during QA_
