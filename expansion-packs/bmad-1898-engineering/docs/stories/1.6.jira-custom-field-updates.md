# Story 1.6: JIRA Custom Field Updates

## Status
Draft

## Story
**As a** Security Analyst agent,
**I want** to update JIRA custom fields for CVSS, EPSS, KEV, Priority,
**so that** JIRA queries and automation can leverage structured data.

## Acceptance Criteria
1. Agent updates custom fields using `mcp__atlassian__editJiraIssue`
2. CVSS score (number field)
3. EPSS score (number field)
4. KEV status (dropdown: Listed/Not Listed)
5. Priority (standard field: Critical/High/Medium/Low)
6. CVE ID (text field)

## Tasks / Subtasks
- [ ] Implement JIRA field update task (AC: 1)
  - [ ] Create `tasks/update-jira-fields.md`
  - [ ] Use `mcp__atlassian__editJiraIssue` MCP tool
  - [ ] Map enrichment data to JIRA fields
  - [ ] Handle field update errors gracefully
- [ ] Configure custom field mappings (AC: 2-6)
  - [ ] Define field mappings in `config.yaml`
  - [ ] Map CVSS score to custom number field
  - [ ] Map EPSS score to custom number field
  - [ ] Map KEV status to custom dropdown field
  - [ ] Map CVE ID to custom text field
  - [ ] Map priority to standard JIRA priority field
- [ ] Implement CVSS score update (AC: 2)
  - [ ] Field type: Number (decimal, 1 decimal place)
  - [ ] Value range: 0.0 - 10.0
  - [ ] Validation: Reject invalid scores
  - [ ] Also store CVSS vector string in description or comment
- [ ] Implement EPSS score update (AC: 3)
  - [ ] Field type: Number (decimal, 2 decimal places)
  - [ ] Value range: 0.00 - 1.00
  - [ ] Validation: Reject invalid scores
  - [ ] Also store EPSS percentile in comment
- [ ] Implement KEV status update (AC: 4)
  - [ ] Field type: Dropdown/Select
  - [ ] Allowed values: "Listed", "Not Listed"
  - [ ] If Listed: Also store KEV date_added in comment
- [ ] Implement Priority update (AC: 5)
  - [ ] Use standard JIRA priority field
  - [ ] Map P1 → Critical (Highest)
  - [ ] Map P2 → High
  - [ ] Map P3 → Medium
  - [ ] Map P4 → Low
  - [ ] Map P5 → Trivial (Lowest)
- [ ] Implement CVE ID update (AC: 6)
  - [ ] Field type: Text (single line)
  - [ ] Format: CVE-YYYY-NNNNN
  - [ ] Validation: Regex pattern match
  - [ ] Handle multiple CVEs: Store primary CVE, list others in comment

## Dev Notes

### JIRA Custom Field Configuration

**config.yaml Structure:**
```yaml
jira:
  cloud_id: "934c63a0-0b96-4d46-b906-0f8c1c85c5d7"
  project_key: "AOD"
  issue_type: "Security Alert"

  custom_fields:
    cve_id:
      field_id: "customfield_10001"
      field_type: "text"
      label: "CVE ID"
      validation: "^CVE-\\d{4}-\\d{4,7}$"

    cvss_score:
      field_id: "customfield_10010"
      field_type: "number"
      label: "CVSS Base Score"
      min: 0.0
      max: 10.0
      decimals: 1

    epss_score:
      field_id: "customfield_10011"
      field_type: "number"
      label: "EPSS Score"
      min: 0.0
      max: 1.0
      decimals: 2

    kev_status:
      field_id: "customfield_10012"
      field_type: "select"
      label: "CISA KEV Status"
      options: ["Listed", "Not Listed"]

    exploit_status:
      field_id: "customfield_10013"
      field_type: "select"
      label: "Exploit Availability"
      options: ["None", "PoC", "Public Exploit", "Active Exploitation"]

  priority_mapping:
    P1: "Critical"
    P2: "High"
    P3: "Medium"
    P4: "Low"
    P5: "Trivial"
```

### MCP Tool Usage
```
mcp__atlassian__editJiraIssue
  - issueKey: "AOD-1234"
  - cloudId: "934c63a0-0b96-4d46-b906-0f8c1c85c5d7"
  - fields:
      customfield_10001: "CVE-2024-1234"
      customfield_10010: 9.8
      customfield_10011: 0.85
      customfield_10012: { value: "Listed" }
      customfield_10013: { value: "Active Exploitation" }
      priority: { name: "Critical" }
```

### Field Update Logic
```python
def update_jira_fields(ticket_id, enrichment_data):
    """Update JIRA custom fields with enrichment data"""

    # Load config
    config = load_config("config.yaml")

    # Build field update payload
    fields = {}

    # CVE ID
    if enrichment_data.cve_id:
        fields[config.custom_fields.cve_id.field_id] = enrichment_data.cve_id

    # CVSS Score
    if enrichment_data.cvss_score:
        cvss = round(enrichment_data.cvss_score, 1)
        if 0.0 <= cvss <= 10.0:
            fields[config.custom_fields.cvss_score.field_id] = cvss

    # EPSS Score
    if enrichment_data.epss_score:
        epss = round(enrichment_data.epss_score, 2)
        if 0.0 <= epss <= 1.0:
            fields[config.custom_fields.epss_score.field_id] = epss

    # KEV Status
    if enrichment_data.kev_status:
        fields[config.custom_fields.kev_status.field_id] = {
            "value": enrichment_data.kev_status  # "Listed" or "Not Listed"
        }

    # Priority
    if enrichment_data.priority:
        priority_name = config.priority_mapping[enrichment_data.priority]
        fields["priority"] = {"name": priority_name}

    # Execute update
    mcp__atlassian__editJiraIssue(
        issueKey=ticket_id,
        cloudId=config.cloud_id,
        fields=fields
    )
```

### Field Validation
Before updating JIRA, validate all values:
- **CVSS:** Must be 0.0-10.0, round to 1 decimal
- **EPSS:** Must be 0.0-1.0, round to 2 decimals
- **KEV Status:** Must be "Listed" or "Not Listed" exactly
- **CVE ID:** Must match pattern `CVE-\d{4}-\d{4,7}`
- **Priority:** Must map to valid JIRA priority value

### Error Handling

**Invalid Field Value:**
```
❌ Cannot update CVSS score: 11.5 is out of range (0.0-10.0)
Action: Skip field update, log warning, proceed with other fields
```

**Field Does Not Exist:**
```
❌ Custom field 'customfield_10010' does not exist in JIRA project AOD
Action: Skip field update, log error, suggest admin create field
```

**Permission Denied:**
```
❌ Cannot update fields in AOD-1234. Check JIRA edit permissions.
Action: Skip field updates, enrichment comment still posted
```

**Multiple CVEs:**
```
⚠️ Ticket contains multiple CVEs: CVE-2024-1234, CVE-2024-5678
Action: Store first CVE in CVE ID field, list all in comment
```

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/tasks/`

**Test Standards:**
- Unit tests: Mock MCP responses
- Integration tests: Update real JIRA Cloud test tickets
- Validate field value formatting
- Test validation logic
- Verify error handling

**Test Cases:**
1. Valid values: All fields within range
2. Invalid CVSS: Score 11.5 (out of range)
3. Invalid EPSS: Score 1.5 (out of range)
4. Invalid KEV: Value "Unknown" (not in options)
5. Invalid CVE: Format "2024-1234" (missing CVE- prefix)
6. Missing fields: Only CVSS provided
7. Field doesn't exist: Unmapped custom field
8. Permission denied: Read-only user

**Testing Requirements:**
- Create test ticket `AOD-TEST-FIELDS`
- Configure test custom fields in JIRA
- Test each field individually
- Test all fields together
- Verify JIRA web UI shows updated values
- Test JIRA JQL queries using custom fields

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated after QA review_
