# Story 3.1: Security Alert Enrichment Workflow

## Status

Draft

## Story

**As a** security operations team,
**I want** a complete end-to-end enrichment workflow,
**so that** enrichment is consistent and comprehensive.

## Acceptance Criteria

1. Workflow includes all stages: Triage ‚Üí Research ‚Üí Business Context ‚Üí Remediation ‚Üí ATT&CK ‚Üí Priority ‚Üí Documentation ‚Üí Validation
2. Each stage has clear inputs/outputs
3. Workflow takes 10-15 minutes with AI assistance
4. Workflow produces enriched JIRA ticket

## Tasks / Subtasks

- [ ] Create enrichment workflow definition (AC: 1, 2)
  - [ ] Create `workflows/security-alert-enrichment-workflow.yaml`
  - [ ] Define all 8 workflow stages
  - [ ] Specify inputs/outputs for each stage
  - [ ] Add Mermaid diagram for visualization
  - [ ] Include time estimates per stage
- [ ] Define Stage 1: Triage (AC: 1, 2)
  - [ ] Input: JIRA ticket ID
  - [ ] Actions: Read ticket, extract CVE ID, identify affected systems
  - [ ] Output: CVE ID, affected systems list, initial context
  - [ ] Estimated Time: 1-2 minutes
- [ ] Define Stage 2: CVE Research (AC: 1, 2)
  - [ ] Input: CVE ID
  - [ ] Actions: Perplexity research (CVSS, EPSS, KEV, exploits, patches, ATT&CK)
  - [ ] Output: Comprehensive CVE intelligence
  - [ ] Estimated Time: 3-5 minutes (AI-assisted)
- [ ] Define Stage 3: Business Context Assessment (AC: 1, 2)
  - [ ] Input: Affected systems, CVE intelligence
  - [ ] Actions: Assess ACR rating, system exposure, business impact
  - [ ] Output: Business context analysis
  - [ ] Estimated Time: 2-3 minutes
- [ ] Define Stage 4: Remediation Planning (AC: 1, 2)
  - [ ] Input: CVE intelligence, business context
  - [ ] Actions: Identify patches/workarounds, compensating controls
  - [ ] Output: Remediation guidance
  - [ ] Estimated Time: 2-3 minutes
- [ ] Define Stage 5: MITRE ATT&CK Mapping (AC: 1, 2)
  - [ ] Input: CVE intelligence
  - [ ] Actions: Map to tactics and techniques
  - [ ] Output: ATT&CK mapping
  - [ ] Estimated Time: 1-2 minutes
- [ ] Define Stage 6: Priority Assessment (AC: 1, 2)
  - [ ] Input: All previous outputs
  - [ ] Actions: Multi-factor priority calculation
  - [ ] Output: Priority level (P1-P5), SLA deadline, rationale
  - [ ] Estimated Time: 1-2 minutes
- [ ] Define Stage 7: Documentation (AC: 1, 2)
  - [ ] Input: All enrichment data
  - [ ] Actions: Generate structured enrichment document
  - [ ] Output: Enrichment markdown document
  - [ ] Estimated Time: 1 minute
- [ ] Define Stage 8: JIRA Update & Validation (AC: 1, 2, 4)
  - [ ] Input: Enrichment document
  - [ ] Actions: Post comment, update custom fields, validate completeness
  - [ ] Output: Enriched JIRA ticket
  - [ ] Estimated Time: 1-2 minutes
- [ ] Create workflow orchestration task (AC: 3)
  - [ ] Create `tasks/enrich-security-ticket.md`
  - [ ] Implement complete workflow execution
  - [ ] Progress tracking through stages
  - [ ] Error handling and retry logic
  - [ ] Total time target: 10-15 minutes

## Dev Notes

### Workflow YAML Structure

```yaml
workflow:
  id: security-alert-enrichment-v1
  name: Security Alert Enrichment Workflow
  version: 1.0
  description: End-to-end workflow for enriching security alert tickets with AI-assisted research
  estimated_duration: 10-15 minutes
  prerequisites:
    - JIRA ticket with security alert
    - Atlassian MCP configured
    - Perplexity MCP configured
    - Security Analyst agent activated

  stages:
    - id: stage1-triage
      name: Triage & Context Extraction
      duration: 1-2 minutes
      inputs:
        - JIRA ticket ID
      actions:
        - Read JIRA ticket via Atlassian MCP
        - Extract CVE ID from summary/description
        - Identify affected systems from custom fields
        - Extract initial severity and context
      outputs:
        - CVE ID
        - Affected systems list
        - Initial context
      success_criteria:
        - CVE ID extracted successfully
        - Affected systems identified
      error_handling:
        - If no CVE ID: Prompt user for CVE ID or description
        - If ticket not found: Verify ticket ID and retry

    - id: stage2-cve-research
      name: AI-Assisted CVE Research
      duration: 3-5 minutes
      inputs:
        - CVE ID
      actions:
        - Determine CVSS severity (if available)
        - Select Perplexity tool based on severity (search/reason/deep_research)
        - Construct comprehensive research query
        - Execute Perplexity research
        - Parse and structure research findings
      outputs:
        - CVSS score and vector
        - EPSS score
        - CISA KEV status
        - Affected versions
        - Patched versions
        - Exploit status
        - MITRE ATT&CK suggestions
        - Authoritative source links
      success_criteria:
        - CVSS score obtained
        - Patch status determined
        - Authoritative sources cited
      error_handling:
        - If Perplexity timeout: Retry with simpler query
        - If no data: Use manual research fallback

    - id: stage3-business-context
      name: Business Context Assessment
      duration: 2-3 minutes
      inputs:
        - Affected systems
        - CVE intelligence
      actions:
        - Retrieve Asset Criticality Rating (ACR) from JIRA or config
        - Determine system exposure (Internet/Internal/Isolated)
        - Assess business impact (availability, confidentiality, integrity)
        - Identify affected business processes
      outputs:
        - ACR rating
        - System exposure classification
        - Business impact analysis
      success_criteria:
        - ACR rating determined
        - System exposure classified
      error_handling:
        - If ACR unknown: Prompt user or default to Medium

    - id: stage4-remediation-planning
      name: Remediation Planning
      duration: 2-3 minutes
      inputs:
        - CVE intelligence
        - Business context
      actions:
        - Identify patch availability and version
        - Research workarounds if no patch
        - Identify compensating controls
        - Create actionable remediation steps
      outputs:
        - Patch information
        - Workaround procedures
        - Compensating controls
        - Remediation steps
      success_criteria:
        - Remediation guidance provided
        - Specific action items included

    - id: stage5-attack-mapping
      name: MITRE ATT&CK Mapping
      duration: 1-2 minutes
      inputs:
        - CVE intelligence
        - Vulnerability type
      actions:
        - Map vulnerability to MITRE ATT&CK tactics
        - Identify relevant techniques (T-numbers)
        - Add detection and defense guidance
      outputs:
        - ATT&CK tactics
        - ATT&CK techniques with T-numbers
        - Detection implications
      success_criteria:
        - At least one tactic identified
        - At least one technique mapped

    - id: stage6-priority-assessment
      name: Multi-Factor Priority Assessment
      duration: 1-2 minutes
      inputs:
        - CVSS score
        - EPSS score
        - KEV status
        - ACR rating
        - System exposure
        - Exploit status
      actions:
        - Calculate priority score using algorithm
        - Determine priority level (P1-P5)
        - Generate priority rationale
        - Calculate SLA deadline
      outputs:
        - Priority level (P1-P5)
        - Priority rationale
        - SLA deadline
      success_criteria:
        - Priority level assigned
        - Rationale explains decision

    - id: stage7-documentation
      name: Structured Documentation
      duration: 1 minute
      inputs:
        - All enrichment data from previous stages
      actions:
        - Use security-enrichment-tmpl.yaml
        - Populate all template sections
        - Generate markdown document
        - Validate completeness
      outputs:
        - Enrichment markdown document
      success_criteria:
        - All 12 template sections populated
        - Executive summary present

    - id: stage8-jira-update
      name: JIRA Update & Validation
      duration: 1-2 minutes
      inputs:
        - Enrichment document
        - Priority level
        - Structured data (CVSS, EPSS, KEV)
      actions:
        - Post enrichment as JIRA comment
        - Update custom fields (CVSS, EPSS, KEV, Priority)
        - Save enrichment to local directory
        - Validate ticket updated successfully
      outputs:
        - Enriched JIRA ticket
        - Local enrichment file
      success_criteria:
        - Comment posted successfully
        - Custom fields updated
        - Local file saved

  success_metrics:
    - Total time: <15 minutes
    - All 8 stages completed
    - JIRA ticket enriched
    - Quality score >75%

  integration_points:
    - Atlassian MCP (JIRA)
    - Perplexity MCP (Research)
    - Local file system (Documentation storage)

  mermaid_diagram: |
    graph TD
      A[Start: JIRA Ticket ID] --> B[Stage 1: Triage]
      B --> C[Stage 2: CVE Research]
      C --> D[Stage 3: Business Context]
      D --> E[Stage 4: Remediation Planning]
      E --> F[Stage 5: MITRE ATT&CK]
      F --> G[Stage 6: Priority Assessment]
      G --> H[Stage 7: Documentation]
      H --> I[Stage 8: JIRA Update]
      I --> J[End: Enriched Ticket]
```

### Workflow Orchestration Task

```markdown
# Enrich Security Ticket Task

## Purpose

Execute complete security alert enrichment workflow from JIRA ticket to fully enriched analysis.

## Usage
```

\*enrich-ticket {ticket-id}

```

## Process

### Progress Tracking
Display progress through workflow stages:
```

üîÑ Security Alert Enrichment Workflow
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ Stage 1: Triage (completed in 1m 23s)
‚úÖ Stage 2: CVE Research (completed in 4m 12s)
üîÑ Stage 3: Business Context (in progress...)
‚è≥ Stage 4: Remediation Planning
‚è≥ Stage 5: MITRE ATT&CK
‚è≥ Stage 6: Priority Assessment
‚è≥ Stage 7: Documentation
‚è≥ Stage 8: JIRA Update
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Elapsed: 5m 35s | Estimated Remaining: 6m

```

### Error Recovery
- Retry failed stages automatically
- Save progress at each stage
- Allow resume from last completed stage
- Provide clear error messages and next steps
```

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/workflows/`

**Test Standards:**

- End-to-end integration test with real JIRA ticket
- Mock MCP responses for unit tests
- Measure total workflow execution time
- Verify all stages complete successfully
- Test error handling and recovery

**Test Cases:**

1. Happy path: All stages complete successfully (<15 minutes)
2. Missing CVE: User prompted to provide CVE ID
3. Perplexity timeout: Retry logic activates
4. JIRA update fails: Error handled gracefully, enrichment saved locally
5. Resume workflow: Start from Stage 5 after interruption

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-06 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated during development_

### Debug Log References

_To be populated during development_

### Completion Notes List

_To be populated during development_

### File List

_To be populated during development_

## QA Results

_To be populated after QA review_
