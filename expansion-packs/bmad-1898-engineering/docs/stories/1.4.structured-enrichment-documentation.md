# Story 1.4: Structured Enrichment Documentation

## Status
Draft

## Story
**As a** Security Analyst agent,
**I want** to structure research findings using the enrichment template,
**so that** all enrichment comments follow consistent, comprehensive format.

## Acceptance Criteria
1. Agent uses security-enrichment-tmpl.yaml
2. All 12 sections of template completed
3. Executive summary provides 2-3 sentence overview
4. Severity metrics include CVSS, EPSS, KEV
5. MITRE ATT&CK mapping included
6. Priority recommendation with rationale

## Tasks / Subtasks
- [ ] Create security enrichment template (AC: 1, 2)
  - [ ] Create `templates/security-enrichment-tmpl.yaml`
  - [ ] Define all 12 required sections (see Dev Notes)
  - [ ] Add instructions for each section
  - [ ] Include variable substitution placeholders
  - [ ] Follow BMAD template format specification
- [ ] Implement Executive Summary section (AC: 3)
  - [ ] 2-3 sentence overview of vulnerability
  - [ ] Include CVE ID, affected product, severity
  - [ ] Highlight exploitability and impact
  - [ ] State recommended priority
- [ ] Implement Severity Metrics section (AC: 4)
  - [ ] CVSS Base Score and Vector String
  - [ ] EPSS Exploitation Probability Score
  - [ ] CISA KEV Status with date if listed
  - [ ] Severity interpretation and context
- [ ] Implement MITRE ATT&CK Mapping section (AC: 5)
  - [ ] Tactics (e.g., Initial Access, Execution)
  - [ ] Techniques with T-numbers (e.g., T1190)
  - [ ] Detection implications
  - [ ] Defensive recommendations
- [ ] Implement Priority Assessment section (AC: 6)
  - [ ] Priority level (P1-P5)
  - [ ] Rationale explaining priority factors
  - [ ] Factor breakdown (CVSS, EPSS, KEV, ACR, Exposure)
  - [ ] SLA remediation deadline
- [ ] Integrate template with create-doc task
  - [ ] Use `tasks/create-doc.md` for document generation
  - [ ] Pass research findings as template variables
  - [ ] Generate markdown output
  - [ ] Validate all sections populated

## Dev Notes

### Template Structure (12 Sections)

```yaml
template:
  id: security-enrichment-template-v1
  name: Security Alert Enrichment
  version: 1.0
  output:
    format: markdown
    title: "Security Enrichment: {{cve_id}} - {{vulnerability_title}}"

sections:
  1. Executive Summary
  2. Vulnerability Details
  3. Severity Metrics
  4. Affected Systems
  5. Exploit Intelligence
  6. Business Impact Assessment
  7. MITRE ATT&CK Mapping
  8. Remediation Guidance
  9. Compensating Controls
  10. Priority Assessment
  11. References
  12. Enrichment Metadata
```

### Section 1: Executive Summary (2-3 sentences)
```markdown
## Executive Summary
{{cve_id}} is a **{{severity}}** severity {{vulnerability_type}} affecting {{affected_product}} versions {{affected_versions}}. The vulnerability has a CVSS score of {{cvss_score}}, EPSS score of {{epss_score}}, and is {{kev_status}} on the CISA KEV catalog. Recommended priority: **{{priority}}** ({{sla_timeline}}).
```

### Section 3: Severity Metrics
```markdown
## Severity Metrics

| Metric | Value | Context |
|--------|-------|---------|
| **CVSS Base Score** | {{cvss_score}} ({{cvss_severity}}) | {{cvss_vector}} |
| **EPSS Score** | {{epss_score}} ({{epss_percentile}}th percentile) | Exploitation probability: {{epss_interpretation}} |
| **CISA KEV Status** | {{kev_status}} | {{kev_context}} |
| **Exploit Availability** | {{exploit_status}} | {{exploit_context}} |
```

### Section 7: MITRE ATT&CK Mapping
```markdown
## MITRE ATT&CK Mapping

**Tactics:**
{{#each tactics}}
- {{this}}
{{/each}}

**Techniques:**
{{#each techniques}}
- **{{this.id}}** - {{this.name}}
  - Detection: {{this.detection_guidance}}
{{/each}}
```

### Section 10: Priority Assessment
```markdown
## Priority Assessment

**Priority Level:** {{priority}} ({{priority_label}})

**Rationale:**
{{priority_rationale}}

**Factor Analysis:**
- CVSS Severity: {{cvss_severity}} ({{cvss_score}})
- EPSS Exploitation Probability: {{epss_interpretation}} ({{epss_score}})
- CISA KEV Status: {{kev_status}}
- Asset Criticality Rating: {{acr_rating}}
- System Exposure: {{system_exposure}}
- Exploit Availability: {{exploit_status}}

**SLA Remediation Timeline:** {{sla_deadline}}
```

### Template Variable Substitution
Research findings from Story 1.3 map to template variables:
```
cve_id → {{cve_id}}
cvss.score → {{cvss_score}}
cvss.vector → {{cvss_vector}}
epss.score → {{epss_score}}
kev.status → {{kev_status}}
attack_mapping.tactics → {{tactics}}
attack_mapping.techniques → {{techniques}}
```

### Quality Gates
Before generating enrichment document, validate:
- [ ] All 12 sections have content (no empty sections)
- [ ] Executive summary is 2-3 sentences
- [ ] CVSS score present and valid (0.0-10.0)
- [ ] EPSS score present and valid (0.0-1.0)
- [ ] KEV status determined (Listed/Not Listed)
- [ ] At least one MITRE ATT&CK tactic identified
- [ ] Priority level assigned (P1-P5)
- [ ] Priority rationale provided
- [ ] At least 3 authoritative sources cited

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/templates/`

**Test Standards:**
- Validate YAML template structure
- Test variable substitution
- Verify all 12 sections render
- Test with complete data
- Test with partial data (missing fields)
- Validate markdown output formatting

**Test Cases:**
1. Complete data: All fields populated
2. Partial data: Some fields missing (e.g., no EPSS)
3. Minimal data: Only required fields
4. Invalid data: Out-of-range values
5. Multiple CVEs: Template handles lists

**Testing Requirements:**
- Template validates against BMAD template spec
- Generated markdown is valid
- All sections render without errors
- Missing data handled gracefully
- Output is human-readable and well-formatted

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated after QA review_
