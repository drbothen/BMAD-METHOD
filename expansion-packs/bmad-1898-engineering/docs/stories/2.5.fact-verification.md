# Story 2.5: Fact Verification

## Status
Draft

## Story
**As a** Security Reviewer agent,
**I want** to verify factual claims using Perplexity,
**so that** critical assertions are validated against authoritative sources.

## Acceptance Criteria
1. Agent can optionally verify claims
2. Agent checks: CVSS scores, EPSS scores, KEV status, patch availability
3. Agent compares analyst claims with authoritative sources
4. Agent documents discrepancies
5. Agent provides corrections with sources

## Tasks / Subtasks
- [ ] Create fact verification task (AC: 1, 2, 3, 4, 5)
  - [ ] Create `tasks/fact-verify-claims.md`
  - [ ] Use Perplexity MCP to verify factual claims
  - [ ] Compare analyst claims with authoritative data
  - [ ] Document discrepancies with severity
  - [ ] Generate fact-checking report
- [ ] Implement selective verification (AC: 1)
  - [ ] Allow reviewer to select which claims to verify
  - [ ] Default: Verify critical claims (CVSS, KEV, Priority)
  - [ ] Optional: Verify all claims (comprehensive fact-check)
  - [ ] Skip verification if time-constrained
- [ ] Verify CVSS scores (AC: 2)
  - [ ] Query NVD for official CVSS base score
  - [ ] Compare with analyst-reported score
  - [ ] Verify CVSS vector string matches
  - [ ] Flag discrepancies
- [ ] Verify EPSS scores (AC: 2)
  - [ ] Query FIRST EPSS for exploitation probability
  - [ ] Compare with analyst-reported score
  - [ ] Check if score is current (daily updates)
  - [ ] Flag discrepancies
- [ ] Verify KEV status (AC: 2)
  - [ ] Query CISA KEV catalog for CVE
  - [ ] Compare with analyst-reported status
  - [ ] If Listed: Verify date_added matches
  - [ ] Flag discrepancies
- [ ] Verify patch availability (AC: 2)
  - [ ] Query vendor advisory for patch status
  - [ ] Compare with analyst-reported patch version
  - [ ] Verify patch version correctness
  - [ ] Flag discrepancies
- [ ] Document discrepancies (AC: 4, 5)
  - [ ] Create discrepancy report with severity (Critical/Significant/Minor)
  - [ ] Provide correct information with authoritative source
  - [ ] Calculate accuracy score (% claims correct)

## Dev Notes

### Fact Verification Task Structure

```markdown
# Fact Verification Task

## Purpose
Verify factual claims in security enrichment against authoritative sources using Perplexity MCP.

## Inputs
- Enrichment document (analyst-provided)
- CVE ID
- Claims to verify (CVSS, EPSS, KEV, Patch, etc.)

## Process

### Step 1: Extract Claims
Parse enrichment and extract factual assertions:
- CVSS Base Score: X.X
- EPSS Score: X.XX
- KEV Status: Listed/Not Listed
- Affected Versions: X.X.X - X.X.X
- Patched Version: X.X.X
- Exploit Status: PoC/Public/Active

### Step 2: Verify Critical Claims
Use Perplexity to verify against authoritative sources:

**CVSS Verification:**
Query: "What is the official CVSS base score for {cve_id} according to NIST NVD?"
Expected Source: nvd.nist.gov

**EPSS Verification:**
Query: "What is the current EPSS score for {cve_id} according to FIRST.org?"
Expected Source: first.org/epss

**KEV Verification:**
Query: "Is {cve_id} listed on the CISA KEV catalog? If yes, what is the date_added?"
Expected Source: cisa.gov/known-exploited-vulnerabilities-catalog

**Patch Verification:**
Query: "What is the patched version for {cve_id} according to {vendor} security advisory?"
Expected Source: Vendor official security site

### Step 3: Compare Claims
For each claim:
- Match: ‚úÖ Analyst claim matches authoritative source
- Mismatch: ‚ùå Analyst claim differs from authoritative source
- Unknown: ‚ö†Ô∏è Cannot verify (source unavailable or conflicting)

### Step 4: Document Discrepancies
For each mismatch:
- Severity: Critical (wrong priority impact), Significant (quality impact), Minor (formatting)
- Analyst Claim: What analyst stated
- Authoritative Source: What source says
- Source URL: Authoritative source link
- Impact: How this affects enrichment quality

### Step 5: Calculate Accuracy Score
Accuracy = (Matching Claims / Total Claims Verified) √ó 100%
- 95-100%: Excellent accuracy
- 85-94%: Good accuracy
- 75-84%: Fair accuracy
- <75%: Poor accuracy, requires significant corrections
```

### Fact Verification Queries

**CVSS Score Verification:**
```
Verify the official CVSS base score for CVE-{cve_id} from NIST NVD.
Provide:
- CVSS Base Score (numeric)
- CVSS Vector String
- CVSS Severity Label (Low/Medium/High/Critical)
Source must be nvd.nist.gov
```

**EPSS Score Verification:**
```
Verify the current EPSS exploitation probability score for CVE-{cve_id} from FIRST.org EPSS.
Provide:
- EPSS Score (0.00-1.00)
- EPSS Percentile
- Date of EPSS score
Source must be first.org/epss
```

**KEV Status Verification:**
```
Verify if CVE-{cve_id} is listed on the CISA Known Exploited Vulnerabilities (KEV) catalog.
Provide:
- KEV Status (Listed or Not Listed)
- If Listed: date_added, due_date, required_action
Source must be cisa.gov/known-exploited-vulnerabilities-catalog
```

### Discrepancy Report Template

```markdown
# Fact Verification Report

**CVE:** {{cve_id}}
**Analyst:** {{analyst_name}}
**Reviewer:** {{reviewer_name}}
**Verification Date:** {{verification_timestamp}}

---

## Verification Summary

**Claims Verified:** {{total_claims}}
**Matches:** {{matches}} ({{match_percentage}}%)
**Discrepancies:** {{discrepancies}} ({{discrepancy_percentage}}%)
**Unable to Verify:** {{unknown}}

**Accuracy Score:** {{accuracy_score}}% ({{accuracy_classification}})

---

## Discrepancies Found

### üî¥ Critical Discrepancy #1: CVSS Score Mismatch

**Claim:** CVSS Base Score: 7.5 (High)
**Authoritative Source:** CVSS Base Score: 9.8 (Critical)
**Source:** [NIST NVD](https://nvd.nist.gov/vuln/detail/CVE-2024-1234)
**Impact:** Priority assessment based on incorrect CVSS. Should be P1, not P3.
**Recommended Action:** Correct CVSS score to 9.8, recalculate priority.

---

### üü° Significant Discrepancy #2: KEV Status Incorrect

**Claim:** CISA KEV Status: Not Listed
**Authoritative Source:** KEV Status: Listed (date_added: 2024-11-01)
**Source:** [CISA KEV](https://www.cisa.gov/known-exploited-vulnerabilities-catalog)
**Impact:** Missing critical prioritization factor. KEV listing should elevate to P1/P2.
**Recommended Action:** Add KEV status and date_added, update priority.

---

## Verified Claims (‚úÖ Accurate)

- ‚úÖ EPSS Score: 0.85 (Verified: FIRST.org)
- ‚úÖ Affected Versions: Apache Struts 2.0.0-2.5.32 (Verified: Apache Advisory)
- ‚úÖ Patched Version: 2.5.33+ (Verified: Apache Advisory)

---

## Unable to Verify (‚ö†Ô∏è)

- ‚ö†Ô∏è Exploit Status: "Active Exploitation" - Unable to confirm independently
```

### Error Handling

**Perplexity Unavailable:**
- Skip fact verification
- Note in review: "‚ö†Ô∏è Fact verification skipped (Perplexity unavailable)"
- Recommend manual verification

**Conflicting Sources:**
- Note discrepancy: "‚ö†Ô∏è Conflicting information across sources"
- Prioritize: NVD > CISA > Vendor Advisory > Other
- Document all sources and discrepancies

**Information Not Available:**
- Note: "‚ö†Ô∏è Unable to verify - information not yet available (new CVE)"
- Do not mark as discrepancy
- Recommend re-verification when available

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/tasks/`

**Test Standards:**
- Mock Perplexity responses for unit tests
- Use real CVEs for integration tests
- Test with correct enrichment (should match 100%)
- Test with incorrect enrichment (should detect discrepancies)
- Test with recent CVEs (limited data available)

**Test Cases:**
1. Correct enrichment: All claims match ‚Üí 100% accuracy
2. Wrong CVSS: 7.5 vs. actual 9.8 ‚Üí Critical discrepancy
3. Wrong KEV: Not Listed vs. actual Listed ‚Üí Significant discrepancy
4. Minor formatting: CVSS 9.80 vs. 9.8 ‚Üí Minor or no discrepancy
5. New CVE: EPSS not yet available ‚Üí Unable to verify

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated after QA review_
