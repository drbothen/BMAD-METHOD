# Story 3.3: Vulnerability Lifecycle Workflow

## Status

Done

## Story

**As a** security operations team,
**I want** complete lifecycle tracking from alert to closure,
**so that** vulnerabilities are systematically managed.

## Acceptance Criteria

1. Workflow stages: Detection → Enrichment → Review → Remediation Planning → Execution → Verification → Closure
2. Integration with existing ticketing workflows
3. Metrics captured at each stage
4. Audit trail maintained

## Tasks / Subtasks

- [x] Create vulnerability lifecycle workflow (AC: 1, 2)
  - [x] Create `workflows/vulnerability-lifecycle-workflow.yaml`
  - [x] Define all 7 lifecycle stages
  - [x] Specify JIRA status transitions
  - [x] Add Mermaid diagram
  - [x] Document integration with existing processes
- [x] Define Stage 1: Detection (AC: 1, 2)
  - [x] Input: Scanner/feed alert
  - [x] JIRA Status: "Open"
  - [x] Actions: Create JIRA ticket, assign to triage queue
  - [x] Output: Security Alert ticket
- [x] Define Stage 2: Enrichment (AC: 1, 3)
  - [x] Input: Security Alert ticket
  - [x] JIRA Status: "In Progress"
  - [x] Actions: Execute enrichment workflow (Story 3.1)
  - [x] Output: Enriched ticket
  - [x] Metrics: Enrichment duration, quality score
- [x] Define Stage 3: Review (AC: 1, 3)
  - [x] Input: Enriched ticket
  - [x] JIRA Status: "In Review"
  - [x] Actions: Execute review workflow (Story 3.2)
  - [x] Output: Reviewed ticket (approved or needs revision)
  - [x] Metrics: Review duration, quality score, gaps found
- [x] Define Stage 4: Remediation Planning (AC: 1, 2)
  - [x] Input: Approved enrichment
  - [x] JIRA Status: "Remediation Planning"
  - [x] Actions: DevOps team plans patch deployment
  - [x] Output: Remediation plan
  - [x] Metrics: Planning duration
- [x] Define Stage 5: Remediation Execution (AC: 1, 2)
  - [x] Input: Remediation plan
  - [x] JIRA Status: "Remediation In Progress"
  - [x] Actions: Deploy patches/workarounds
  - [x] Output: Remediation completed
  - [x] Metrics: Execution duration, MTTR
- [x] Define Stage 6: Verification (AC: 1, 3)
  - [x] Input: Remediation completed
  - [x] JIRA Status: "Verification"
  - [x] Actions: Verify vulnerability closed, test systems
  - [x] Output: Verification results
  - [x] Metrics: Verification duration
- [x] Define Stage 7: Closure (AC: 1, 3, 4)
  - [x] Input: Verification passed
  - [x] JIRA Status: "Closed"
  - [x] Actions: Close ticket, archive enrichment, capture metrics
  - [x] Output: Closed ticket, audit trail
  - [x] Metrics: Total lifecycle duration, lessons learned
- [x] Document JIRA status transitions (AC: 2)
  - [x] Define allowed status transitions
  - [x] Map workflow stages to JIRA statuses
  - [x] Document transition rules
- [x] Define metrics capture (AC: 3)
  - [x] Time to enrich (Detection → Enrichment complete)
  - [x] Time to review (Enrichment → Review complete)
  - [x] Time to remediate (Review → Remediation complete)
  - [x] MTTR (Detection → Closure)
  - [x] Quality scores
  - [x] Gap counts
- [x] Define audit trail requirements (AC: 4)
  - [x] All enrichment artifacts saved to expansion-packs/bmad-1898-engineering/enrichments/
  - [x] All review reports saved to expansion-packs/bmad-1898-engineering/reviews/
  - [x] All JIRA comments preserved in ticket history
  - [x] Timestamps for each stage in JIRA and metrics CSV
  - [x] Analyst/reviewer attribution in JIRA and logs
  - [x] Metrics logged to expansion-packs/bmad-1898-engineering/metrics/enrichment-metrics.csv
- [x] Create required directories (AC: 3, 4)
  - [x] Create metrics/ directory if not exists
  - [x] Create enrichments/ directory if not exists
  - [x] Create reviews/ directory if not exists
  - [x] Create workflows/ directory if not exists
  - [x] Add .gitkeep files to preserve empty directories

## Dev Notes

### Epic and Source References

**Parent Epic:** Epic 3: Workflow Integration and Orchestration
**Epic File:** `expansion-packs/bmad-1898-engineering/docs/prd/epic-3-workflow-integration.md`

**Architecture References:**
- JIRA workflow standards: `docs/architecture/jira-workflow-standards.md` (defines all 7 statuses, transitions, custom fields, SLAs)
- Source tree: `docs/architecture/source-tree.md` (defines file locations and directory structure)

**Related Stories:**
- Story 3.1: Security Alert Enrichment Workflow (Stage 2: Enrichment)
- Story 3.2: Security Analysis Review Workflow (Stage 3: Review)
- Story 3.4: Priority-Based Review Triggering (Review decision logic between Stage 2 and Stage 3)

**Source Verification:**
- Workflow design based on Epic 3 requirements (lines 111-123 in epic-3-workflow-integration.md)
- 7 lifecycle stages specified in Epic 3 Acceptance Criteria #1
- JIRA status names defined in `docs/architecture/jira-workflow-standards.md` (lines 10-18)
- Metrics requirements from Epic 3 Success Criteria (lines 177-179)
- Audit trail requirements from Epic 3 AC #4 and architecture document (lines 219-227)

### JIRA Configuration Requirements

**IMPORTANT:** This workflow requires specific JIRA configuration. Refer to `docs/architecture/jira-workflow-standards.md` for complete setup.

**Required JIRA Statuses** (must exist in JIRA project):
1. Open
2. In Progress
3. In Review
4. Remediation Planning
5. Remediation In Progress
6. Verification
7. Closed

**Required Status Transitions** (must be configured in JIRA):
- Open → In Progress (Analyst starts enrichment)
- In Progress → In Review (P1/P2 or sampled P3/P4/P5)
- In Progress → Remediation Planning (P3/P4/P5, review skipped)
- In Review → In Progress (Critical Issues found)
- In Review → Remediation Planning (Review approved)
- Remediation Planning → Remediation In Progress
- Remediation In Progress → Verification
- Verification → Remediation In Progress (Verification failed)
- Verification → Closed (Verification passed)

**Validation:** Before implementing this story, validate that all statuses and transitions exist in target JIRA instance.

### Integration Points with Technical Details

**JIRA Cloud (Atlassian MCP):**
- API: JIRA REST API v3
- Authentication: OAuth 2.0 via Atlassian MCP server
- Tools used:
  - `mcp__atlassian__getJiraIssue` - Read ticket data
  - `mcp__atlassian__addCommentToJiraIssue` - Post lifecycle comments
  - `mcp__atlassian__updateJiraIssue` - Update custom fields
  - `mcp__atlassian__transitionJiraIssue` - Change status
- Custom fields: CVSS, EPSS, KEV, Priority, Quality Score (field IDs in config.yaml)
- Error handling: Retry on transient failures, fail gracefully with user notification

**Vulnerability Scanners (Detection):**
- Supported scanners: Qualys, Rapid7, Tenable (any that can create JIRA tickets)
- Integration: Scanner creates JIRA ticket with CVE ID in summary/description
- Data format: CVE ID must be extractable via regex pattern
- Fallback: Manual ticket creation supported

**Patch Management Tools (Remediation Execution):**
- Examples: Ansible Tower, SCCM, custom deployment scripts
- Integration: Manual - DevOps team uses remediation guidance from enrichment
- Future enhancement: API integration for automated deployment tracking

**Metrics Dashboards (Reporting):**
- Data export: CSV format from `metrics/enrichment-metrics.csv`
- Visualization: Grafana, Tableau, Power BI, or custom dashboards
- Key metrics: MTTR, quality scores, stage durations, SLA compliance
- Update frequency: Real-time (metrics logged immediately after each stage)

### File and Directory Structure

**Metrics Storage:**
```
expansion-packs/bmad-1898-engineering/metrics/
├── enrichment-metrics.csv          # All lifecycle metrics (created by Story 3.1, 3.2, 3.3)
└── review-decisions.csv            # Sampling decisions (created by Story 3.4)
```

**Artifact Storage:**
```
expansion-packs/bmad-1898-engineering/
├── enrichments/                    # Enrichment documents archive
│   └── {ticket-id}-enrichment.md   # Example: AOD-1234-enrichment.md
├── reviews/                        # Review reports archive
│   └── {ticket-id}-review.md       # Example: AOD-1234-review.md
└── workflows/                      # Workflow definitions
    └── vulnerability-lifecycle-workflow.yaml  # Created by this story
```

**Note:** Task should verify these directories exist or create them during workflow execution.

### Vulnerability Lifecycle Workflow YAML

```yaml
workflow:
  id: vulnerability-lifecycle-v1
  name: Vulnerability Lifecycle Management
  version: 1.0
  description: Complete vulnerability lifecycle from detection to closure
  estimated_duration: Days to weeks (depends on priority and remediation complexity)

  stages:
    - id: stage1-detection
      name: Detection
      jira_status: 'Open'
      description: Vulnerability scanner or feed alerts security team
      inputs:
        - Scanner alert
        - CVE feed notification
        - Manual report
      actions:
        - Create JIRA Security Alert ticket
        - Extract basic information (CVE ID, affected systems)
        - Assign to triage queue
      outputs:
        - JIRA ticket (AOD-XXXX)
        - Initial severity estimate
      metrics:
        - Detection timestamp
      next_stage: Enrichment

    - id: stage2-enrichment
      name: Enrichment
      jira_status: 'In Progress'
      description: Security Analyst enriches ticket with comprehensive analysis
      inputs:
        - JIRA Security Alert ticket
      actions:
        - Analyst activates Security Analyst agent
        - Execute enrichment workflow (Story 3.1)
        - Post enrichment comment to JIRA
        - Update custom fields
      outputs:
        - Enriched JIRA ticket
        - Priority level (P1-P5)
        - SLA deadline
      metrics:
        - Enrichment start timestamp
        - Enrichment completion timestamp
        - Enrichment duration
        - Quality score (if self-assessed)
      next_stage: Review (if P1/P2) or Remediation Planning (if approved)

    - id: stage3-review
      name: Quality Assurance Review
      jira_status: 'In Review'
      description: Peer review validates enrichment quality
      inputs:
        - Enriched JIRA ticket
      actions:
        - Reviewer activates Security Reviewer agent
        - Execute review workflow (Story 3.2)
        - Post review report to JIRA
        - If Critical Issues: Assign back to analyst
        - If approved: Transition to Remediation Planning
      outputs:
        - Review report in JIRA
        - Quality score
        - Approval status
      metrics:
        - Review start timestamp
        - Review completion timestamp
        - Review duration
        - Quality score
        - Gaps found (Critical/Significant/Minor)
        - Approval status
      next_stage: Remediation Planning (if approved) or Enrichment (if needs revision)

    - id: stage4-remediation-planning
      name: Remediation Planning
      jira_status: 'Remediation Planning'
      description: DevOps/Engineering team plans patch deployment
      inputs:
        - Approved enrichment
        - Priority and SLA
      actions:
        - DevOps team reviews remediation guidance
        - Plan patch deployment or workaround implementation
        - Schedule maintenance window (if needed)
        - Identify dependencies and risks
        - Create remediation plan
      outputs:
        - Remediation plan document
        - Scheduled deployment date/time
      metrics:
        - Planning start timestamp
        - Planning completion timestamp
      next_stage: Remediation Execution

    - id: stage5-remediation-execution
      name: Remediation Execution
      jira_status: 'Remediation In Progress'
      description: Deploy patches/workarounds to affected systems
      inputs:
        - Remediation plan
      actions:
        - Execute patch deployment
        - Implement workarounds
        - Apply compensating controls
        - Document execution steps
      outputs:
        - Remediation completed
        - Execution log
      metrics:
        - Execution start timestamp
        - Execution completion timestamp
        - MTTR (Mean Time To Remediate)
      next_stage: Verification

    - id: stage6-verification
      name: Remediation Verification
      jira_status: 'Verification'
      description: Verify vulnerability successfully remediated
      inputs:
        - Remediation execution complete
      actions:
        - Re-scan affected systems
        - Verify vulnerability no longer present
        - Test system functionality
        - Document verification results
      outputs:
        - Verification results
        - Scanner confirmation
      metrics:
        - Verification timestamp
        - Verification status (Pass/Fail)
      next_stage: Closure (if pass) or Remediation Execution (if fail)

    - id: stage7-closure
      name: Ticket Closure
      jira_status: 'Closed'
      description: Close ticket and capture lessons learned
      inputs:
        - Verification passed
      actions:
        - Close JIRA ticket
        - Archive enrichment artifacts
        - Log all metrics
        - Capture lessons learned (if notable)
        - Update knowledge base (if applicable)
      outputs:
        - Closed ticket
        - Complete audit trail
        - Metrics logged
      metrics:
        - Closure timestamp
        - Total lifecycle duration
        - All stage metrics aggregated
      next_stage: None (terminal)

  jira_status_transitions:
    - from: 'Open'
      to: 'In Progress'
      trigger: Analyst starts enrichment

    - from: 'In Progress'
      to: 'In Review'
      trigger: Enrichment complete (P1/P2 priority)

    - from: 'In Progress'
      to: 'Remediation Planning'
      trigger: Enrichment complete (P3/P4/P5 priority, review optional)

    - from: 'In Review'
      to: 'In Progress'
      trigger: Review identifies Critical Issues

    - from: 'In Review'
      to: 'Remediation Planning'
      trigger: Review approved

    - from: 'Remediation Planning'
      to: 'Remediation In Progress'
      trigger: Plan approved, execution starts

    - from: 'Remediation In Progress'
      to: 'Verification'
      trigger: Remediation complete

    - from: 'Verification'
      to: 'Remediation In Progress'
      trigger: Verification failed

    - from: 'Verification'
      to: 'Closed'
      trigger: Verification passed

  metrics_captured:
    - detection_timestamp
    - enrichment_start_timestamp
    - enrichment_completion_timestamp
    - enrichment_duration_minutes
    - enrichment_quality_score
    - review_start_timestamp
    - review_completion_timestamp
    - review_duration_minutes
    - review_quality_score
    - gaps_found_critical
    - gaps_found_significant
    - gaps_found_minor
    - remediation_planning_start
    - remediation_planning_completion
    - remediation_execution_start
    - remediation_execution_completion
    - verification_timestamp
    - closure_timestamp
    - total_lifecycle_duration_hours
    - mttr_hours

  audit_trail:
    - All JIRA comments preserved in JIRA ticket history
    - All enrichment artifacts saved to expansion-packs/bmad-1898-engineering/enrichments/{ticket-id}-enrichment.md
    - All review reports saved to expansion-packs/bmad-1898-engineering/reviews/{ticket-id}-review.md
    - All metrics logged to expansion-packs/bmad-1898-engineering/metrics/enrichment-metrics.csv
    - Timestamps for all stage transitions recorded in JIRA and metrics CSV
    - Analyst and reviewer attribution in JIRA assignee field and audit logs

  integration_points:
    - JIRA Cloud (ticket management, status transitions)
    - Vulnerability scanners (detection, verification)
    - Patch management tools (remediation execution)
    - Metrics dashboards (reporting)

  mermaid_diagram: |
    graph TD
      A[Detection: Scanner Alert] --> B[Enrichment: Security Analyst]
      B --> C{Priority?}
      C -->|P1/P2| D[Review: Mandatory]
      C -->|P3/P4/P5| E[Review: Optional Sampling]
      D --> F{Approved?}
      E --> F
      F -->|No| B
      F -->|Yes| G[Remediation Planning]
      G --> H[Remediation Execution]
      H --> I[Verification]
      I --> J{Pass?}
      J -->|No| H
      J -->|Yes| K[Closure]
```

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/workflows/`

**Test Standards:**

- End-to-end integration test through complete lifecycle
- Test all stage transitions
- Verify metrics captured at each stage
- Test audit trail completeness

**Test Cases:**

1. P1 ticket: Detection → Enrichment → Mandatory Review → Remediation → Verification → Closure
2. P4 ticket: Detection → Enrichment → Optional Review (skip) → Remediation → Closure
3. Failed review: Enrichment → Review → Back to Enrichment (revision loop)
4. Failed verification: Remediation → Verification (fail) → Remediation (retry) → Verification (pass) → Closure
5. JIRA configuration validation: Verify all statuses and transitions exist before workflow execution
6. Metrics capture: Verify all metrics logged to CSV at each stage
7. Directory creation: Verify required directories created if missing
8. Audit trail: Verify complete audit trail from detection to closure

## Change Log

| Date       | Version | Description                                                                                     | Author     |
| ---------- | ------- | ----------------------------------------------------------------------------------------------- | ---------- |
| 2025-11-08 | 1.1     | Added Epic 3 references, JIRA configuration requirements, integration details, directory paths  | Sarah (PO) |
| 2025-11-06 | 1.0     | Initial story creation                                                                          | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No critical issues encountered during development.

### Completion Notes List

- Created comprehensive vulnerability lifecycle workflow YAML file defining all 7 stages from Detection through Closure
- Documented all 9 required JIRA status transitions with triggers and conditions
- Defined complete metrics capture specification covering 20+ metrics across all lifecycle stages
- Documented audit trail requirements for JIRA comments, enrichment artifacts, review reports, and metrics CSV
- Created enrichments/ and reviews/ directories with .gitkeep files for artifact storage
- Developed 8 comprehensive test cases covering:
  - P1 ticket complete lifecycle with mandatory review (TC-001)
  - P4 ticket with review skipped (TC-002)
  - Failed review revision loop (TC-003)
  - Failed verification retry loop (TC-004)
  - JIRA configuration validation (TC-005)
  - Metrics capture validation (TC-006)
  - Directory auto-creation validation (TC-007)
  - Complete audit trail validation (TC-008)
- All test cases include detailed prerequisites, step-by-step execution instructions, and validation checks
- Workflow integrates seamlessly with Story 3.1 (Enrichment) and Story 3.2 (Review)

### File List

**Created:**
- `expansion-packs/bmad-1898-engineering/workflows/vulnerability-lifecycle-workflow.yaml` - Complete lifecycle workflow definition
- `expansion-packs/bmad-1898-engineering/tests/workflows/test-vulnerability-lifecycle-workflow.md` - Comprehensive test suite (8 test cases)
- `expansion-packs/bmad-1898-engineering/enrichments/.gitkeep` - Directory preservation
- `expansion-packs/bmad-1898-engineering/reviews/.gitkeep` - Directory preservation

**Modified:**
- `expansion-packs/bmad-1898-engineering/docs/stories/3.3.vulnerability-lifecycle-workflow.md` - Updated status to "In Progress", marked all tasks complete, populated Dev Agent Record

## QA Results

### Review Date: 2025-11-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

This is a **workflow definition and documentation story** (not code implementation). The deliverables include a comprehensive workflow YAML definition, detailed dev notes, and an extensive test suite. Overall assessment: **EXCELLENT**

**Strengths:**
- Comprehensive 7-stage lifecycle workflow with complete specifications
- All 9 JIRA status transitions properly defined (7 forward + 2 reverse for retry/revision loops)
- 20 metrics captured across all stages for complete observability
- Excellent audit trail design (JIRA history, file artifacts, metrics CSV, attribution)
- Outstanding test coverage with 8 test cases covering happy paths, edge cases, and error scenarios
- Perfect alignment with architecture standards (jira-workflow-standards.md, source-tree.md)
- Integration points well-documented (JIRA MCP, scanners, patch management, dashboards)
- Clear Mermaid diagram visualizing workflow flow

**Areas for Future Enhancement:**
- Error handling workflows not explicitly defined in YAML (noted in dev notes line 154)
- No test case for JIRA API failures (transient errors, auth failures)
- Access control for workflow stages not specified
- SLA monitoring implementation details not included

### Refactoring Performed

No refactoring performed. This is a documentation/workflow definition story with no code to refactor.

### Compliance Check

- **JIRA Workflow Standards**: ✓ FULL COMPLIANCE
  - All 7 required JIRA statuses correctly defined
  - All 9 status transitions properly configured
  - Metrics specification aligns with standards
  - Audit trail requirements fully met
  - Lifecycle stage mapping accurate
- **Source Tree Standards**: ✓ FULL COMPLIANCE
  - Workflow YAML in workflows/ directory
  - Test file in tests/workflows/ directory
  - Required directories created (enrichments/, reviews/, metrics/)
  - Naming conventions followed
- **All ACs Met**: ✓ YES
  - AC #1: All 7 workflow stages fully specified
  - AC #2: JIRA integration complete with 9 transitions
  - AC #3: 20 metrics defined for all stages
  - AC #4: Complete audit trail specification

### Improvements Checklist

Future enhancements (non-blocking):
- [ ] Add test case for JIRA API error handling (TC-009: JIRA API Failure Scenarios)
- [ ] Define explicit error handling workflows in YAML for MCP failures
- [ ] Add access control specification for workflow stage permissions
- [ ] Define SLA monitoring implementation approach
- [ ] Consider circuit breaker pattern documentation for JIRA API resilience

### Security Review

✓ **PASS** - Security considerations properly addressed:
- OAuth 2.0 authentication documented for JIRA MCP integration
- Complete audit trail maintains compliance (who, what, when)
- Attribution tracking for all analyst/reviewer actions
- Artifact preservation for forensic analysis
- No security vulnerabilities identified

**Future consideration**: Access control not explicitly defined - recommend documenting role-based permissions for each workflow stage in future iteration.

### Performance Considerations

✓ **ADEQUATE** - Performance approach documented:
- Real-time metrics logging specified (not batch)
- Workflow estimated duration documented (days to weeks)
- Metrics include all timing data (enrichment duration, review duration, MTTR, total lifecycle)

**Future consideration**: No specific performance benchmarks defined - recommend establishing baseline metrics after initial deployment.

### Files Modified During Review

None. No files modified during this QA review.

### Gate Status

**Gate**: PASS → docs/qa/gates/3.3-vulnerability-lifecycle-workflow.yml

**Decision Rationale**: All acceptance criteria fully met, excellent test coverage, full standards compliance, and comprehensive documentation. Future enhancements identified are non-blocking improvements that can be addressed in subsequent iterations.

### Recommended Status

✓ **Ready for Done**

This story is complete and ready for production use. All acceptance criteria met, comprehensive test suite in place, and full compliance with architecture standards. The future enhancements noted above are improvements, not defects, and should be tracked as separate backlog items if desired.
