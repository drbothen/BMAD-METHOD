# Story 7.4: Security Reviewer Event Review Capability

## Status

Pending

## Story

**As a** Security Reviewer agent,
**I want** to automatically detect and review event investigations using event-specific workflow,
**so that** I can provide systematic quality feedback on ICS/IDS/SIEM alert investigations with disposition validation.

## Acceptance Criteria

1. Agent automatically detects ticket type (CVE enrichment vs. event investigation)
2. Agent executes 7 event investigation quality checklists for event reviews
3. Agent calculates weighted quality scores (Completeness 25%, Accuracy 20%, Disposition 20%, Context 15%, Methodology 10%, Documentation 5%, Bias 5%)
4. Agent validates analyst disposition and provides agreement/disagreement assessment
5. Agent generates event investigation review report using event template
6. Agent posts review feedback to JIRA ticket
7. Agent provides manual override for ambiguous ticket types (--type parameter)

## Tasks / Subtasks

- [ ] Extend security-reviewer.md agent with event review capability (AC: 1, 7)
  - [ ] Modify `expansion-packs/bmad-1898-engineering/agents/security-reviewer.md`
  - [ ] Update *review-enrichment command to accept --type parameter
  - [ ] Add auto-detection logic for ticket type
  - [ ] Add dependencies for event investigation checklists (7 new checklists from Story 7.2)
  - [ ] Add dependency for event investigation review template (Story 7.3)
  - [ ] Update command documentation with event investigation examples
  - [ ] Document --type=auto|cve|event parameter usage

- [ ] Implement auto-detection logic (AC: 1, 7)
  - [ ] Check 1: JIRA Issue Type field ("Event Alert" → event, "Security Vulnerability" → CVE)
  - [ ] Check 2: Ticket description keywords (ICS/IDS/SIEM terms → event, CVE-YYYY-NNNNN → CVE)
  - [ ] Check 3: Comment structure ("Alert Name/Signature" → event, "Security Analysis Enrichment" → CVE)
  - [ ] Check 4: If ambiguous, prompt user to select review type
  - [ ] Implement --type=cve parameter (force CVE review workflow)
  - [ ] Implement --type=event parameter (force event review workflow)
  - [ ] Implement --type=auto parameter (default - auto-detect)
  - [ ] Clear error message if unsupported ticket type detected

- [ ] Integrate event investigation checklists (AC: 2, 3)
  - [ ] Execute investigation-completeness-checklist.md (Weight: 25%)
  - [ ] Execute investigation-technical-accuracy-checklist.md (Weight: 20%)
  - [ ] Execute disposition-reasoning-checklist.md (Weight: 20%)
  - [ ] Execute investigation-contextualization-checklist.md (Weight: 15%)
  - [ ] Execute investigation-methodology-checklist.md (Weight: 10%)
  - [ ] Execute investigation-documentation-quality-checklist.md (Weight: 5%)
  - [ ] Execute investigation-cognitive-bias-checklist.md (Weight: 5%)
  - [ ] Calculate dimension scores: (Passed / Total) × 100
  - [ ] Calculate overall score using weighted formula
  - [ ] Assign quality classification (Excellent/Good/Needs Improvement/Inadequate)

- [ ] Implement disposition validation (AC: 4)
  - [ ] Extract analyst disposition from investigation document (TP/FP/BTP)
  - [ ] Reviewer independently assesses disposition based on evidence
  - [ ] Compare analyst disposition vs. reviewer disposition
  - [ ] If agreement: Confirm disposition with brief reasoning
  - [ ] If disagreement: Provide detailed reasoning with specific evidence
  - [ ] Flag disposition uncertainty (if confidence level is Low)
  - [ ] Include disposition assessment in review report

- [ ] Integrate event investigation review template (AC: 5)
  - [ ] Call create-doc.md with security-event-investigation-review-report-tmpl.yaml
  - [ ] Populate all template variables from checklist results
  - [ ] Include disposition agreement/disagreement section
  - [ ] Apply blameless language patterns
  - [ ] Generate structured review report (markdown format)

- [ ] Implement JIRA update functionality (AC: 6)
  - [ ] Post review report as comment using post-enrichment-comment.md pattern
  - [ ] Update custom fields (if configured): Review Status, Quality Score, Disposition Agreement
  - [ ] Handle JIRA API errors gracefully
  - [ ] Retry logic for transient failures

- [ ] Update agent help and documentation (AC: 7)
  - [ ] Update *help output to describe event review capability
  - [ ] Add example: *review-enrichment AOD-4052 --type=event
  - [ ] Document auto-detection heuristics in agent persona
  - [ ] Update integration section with event investigation dependencies

## Dev Notes

### Epic Context

**Epic 7: Security Event Investigation Review Capability**

This story extends the Security Reviewer agent (created in Epic 2, Story 2.1) to support reviewing event investigations in addition to CVE enrichments. This requires auto-detection logic, event-specific checklists, and disposition validation.

**Related Stories:**
- Story 7.2: Event Investigation Quality Checklists (provides checklists to execute)
- Story 7.3: Event Investigation Review Report Template (provides review template)
- **Story 7.4: Security Reviewer Event Review Capability** (This story)
- Story 7.5: Event Investigation Workflow Tasks (modifies review workflow tasks)

**Integration:** The *review-enrichment command will become polymorphic, executing different workflows based on detected ticket type.

### Relevant Source Tree

```
expansion-packs/bmad-1898-engineering/
├── agents/
│   └── security-reviewer.md                 (TO BE MODIFIED - add event review)
├── checklists/
│   ├── # CVE enrichment checklists (8 existing)
│   ├── # Event investigation checklists (7 new from Story 7.2)
│   ├── investigation-completeness-checklist.md
│   ├── investigation-technical-accuracy-checklist.md
│   ├── disposition-reasoning-checklist.md
│   ├── investigation-contextualization-checklist.md
│   ├── investigation-methodology-checklist.md
│   ├── investigation-documentation-quality-checklist.md
│   └── investigation-cognitive-bias-checklist.md
├── templates/
│   ├── security-review-report-tmpl.yaml     (Existing - CVE reviews)
│   └── security-event-investigation-review-report-tmpl.yaml (Story 7.3 - event reviews)
├── tasks/
│   ├── review-security-enrichment.md        (Existing - will extend in Story 7.5)
│   └── execute-checklist.md                 (Existing - reuse for event checklists)
└── docs/
    └── stories/
        └── 7.4.security-reviewer-event-review-capability.md (This file)
```

**File to Modify:**
- `expansion-packs/bmad-1898-engineering/agents/security-reviewer.md`

### Auto-Detection Logic (from Epic 7 PRD FR-5)

The *review-enrichment command must auto-detect ticket type to route to correct review workflow:

```
Usage: *review-enrichment {ticket-id} [--type=auto|cve|event]

Detection Logic (when --type=auto or omitted):

1. Check JIRA Issue Type field:
   - "Event Alert" → Event investigation workflow
   - "ICS Alert" → Event investigation workflow
   - "Security Vulnerability" → CVE enrichment workflow

2. Check ticket description for CVE-ID pattern:
   - Contains "CVE-YYYY-NNNNN" → CVE enrichment workflow
   - Contains ICS/IDS/SIEM keywords → Event investigation workflow

3. Check comment structure:
   - Contains "Security Analysis Enrichment" heading → CVE enrichment workflow
   - Contains "Alert Name/Signature" or "Disposition" → Event investigation workflow

4. If still ambiguous:
   - Prompt user: "Unable to determine ticket type. Is this (1) CVE enrichment or (2) Event investigation?"
   - User selects option
   - Proceed with selected workflow

Manual Override:
- --type=cve: Force CVE enrichment review workflow
- --type=event: Force event investigation review workflow
```

**Example Usage:**
```
*review-enrichment AOD-4052                    # Auto-detect (will detect Event Alert)
*review-enrichment AOD-4052 --type=event       # Force event investigation review
*review-enrichment SEC-1234 --type=cve         # Force CVE enrichment review
```

### Disposition Validation Process

This is a new requirement specific to event investigation reviews:

**Step 1: Extract Analyst Disposition**
- Parse investigation document for "Disposition:" field
- Extract value: True Positive (TP), False Positive (FP), or Benign True Positive (BTP)
- Extract confidence level: High, Medium, Low

**Step 2: Reviewer Independent Assessment**
- Review all evidence collected by analyst
- Evaluate disposition reasoning quality (checklist: disposition-reasoning-checklist.md)
- Independently determine correct disposition based on evidence

**Step 3: Comparison**
- Compare analyst disposition vs. reviewer disposition
- Determine agreement status: Agree, Disagree, Uncertain

**Step 4: Documentation**
- If Agree: Briefly confirm why disposition is correct
- If Disagree: Provide detailed reasoning with specific evidence supporting alternate disposition
- If Uncertain: Note insufficient evidence, recommend additional investigation

**Example - Disagreement:**
```
Disposition Assessment:

Analyst Disposition: False Positive (Confidence: High)
Reviewer Disposition: Benign True Positive (Confidence: High)
Agreement: Disagree

Reviewer Reasoning:
The analyst correctly identified that the activity is not malicious, but the disposition should be "Benign True Positive" rather than "False Positive" because:

Evidence:
- The SSH connection was real and correctly detected by Claroty (not a false alarm)
- The connection is authorized maintenance activity (IT Ops team confirmed)
- The alert signature correctly identified SSH in control environments (working as designed)

The distinction matters because:
- False Positive = Alert incorrectly fired, no activity actually occurred
- Benign True Positive = Alert correctly fired on real activity that is authorized/expected

Recommendation: Update disposition to "Benign True Positive" and tune alert to exclude authorized maintenance windows rather than dismissing as false positive.
```

### Weighted Scoring Integration

The review workflow must calculate weighted scores from 7 checklists:

```
Overall Score = (Completeness × 0.25) + (Accuracy × 0.20) + (Disposition × 0.20) +
                (Context × 0.15) + (Methodology × 0.10) + (Documentation × 0.05) + (Bias × 0.05)
```

**Quality Classifications:**
- Excellent: 90-100%
- Good: 75-89%
- Needs Improvement: 60-74%
- Inadequate: <60%

### Error Handling

**Unsupported Ticket Type:**
```
Error: Unable to determine ticket type for AOD-4052.

The ticket does not match expected patterns for:
- CVE vulnerability enrichment (no CVE-ID found)
- Event investigation (no alert metadata found)

Please specify ticket type manually:
*review-enrichment AOD-4052 --type=cve
*review-enrichment AOD-4052 --type=event

Or investigate ticket contents to verify expected format.
```

**Missing Investigation Document:**
```
Error: No investigation document found for ticket AOD-4052.

Event investigation reviews require a completed investigation document in the ticket comments.
Please ensure the Security Analyst has completed the *investigate-event workflow before requesting review.
```

### Testing

**Test Scenarios:**
1. Auto-detect Event Alert (AOD-4052) - Claroty ICS alert
2. Auto-detect CVE enrichment (SEC-1234) - CVE-2024-1234 ticket
3. Force event review with --type=event parameter
4. Force CVE review with --type=cve parameter
5. Ambiguous ticket - prompt user to select
6. Complete event review workflow (all 7 checklists)
7. Disposition agreement scenario
8. Disposition disagreement scenario
9. Unsupported ticket type error
10. JIRA update success and failure scenarios

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-09 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated during development_

## QA Results

_To be populated during QA_
