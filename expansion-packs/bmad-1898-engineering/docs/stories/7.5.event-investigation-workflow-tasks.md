# Story 7.5: Event Investigation Workflow Tasks

## Status

Pending

## Story

**As a** Security Reviewer agent,
**I want** adapted workflow tasks that handle both CVE enrichment and event investigation reviews,
**so that** I can execute the complete 7-stage review process for event investigations.

## Acceptance Criteria

1. review-security-enrichment.md task extended to support event investigations
2. Task routes to event-specific checklists when reviewing event investigations
3. Task routes to CVE-specific checklists when reviewing CVE enrichments
4. All 7 review stages adapted for event investigations (Preparation, Evaluation, Gap ID, Bias Detection, Fact Verification, Documentation, Feedback Loop)
5. Stage 1 (Preparation) parses event investigation structure
6. Stage 2 (Evaluation) executes 7 event checklists with weighted scoring
7. Stage 5 (Fact Verification) validates event-specific claims (IPs, protocols, threat intelligence)

## Tasks / Subtasks

- [ ] Extend review-security-enrichment.md task (AC: 1, 2, 3, 4)
  - [ ] Modify `expansion-packs/bmad-1898-engineering/tasks/review-security-enrichment.md`
  - [ ] Add investigation_type parameter (cve|event)
  - [ ] Add routing logic based on investigation_type
  - [ ] Maintain backward compatibility with existing CVE review workflow
  - [ ] Update task documentation

- [ ] Adapt Stage 1: Review Preparation (AC: 5)
  - [ ] IF investigation_type = event:
    - [ ] Parse event investigation comment structure (not CVE structure)
    - [ ] Extract: Alert metadata, network identifiers, disposition, evidence
    - [ ] Extract factual claims: IP addresses, protocols, timestamps, alert rule IDs
  - [ ] IF investigation_type = cve:
    - [ ] Use existing CVE parsing logic (no changes)

- [ ] Adapt Stage 2: Systematic Evaluation (AC: 6)
  - [ ] IF investigation_type = event:
    - [ ] Execute 7 event investigation checklists
    - [ ] Apply event-specific weighting (Completeness 25%, Accuracy 20%, etc.)
    - [ ] Calculate overall score with event weights
  - [ ] IF investigation_type = cve:
    - [ ] Execute 8 CVE enrichment checklists (existing)
    - [ ] Apply CVE-specific weighting (existing)

- [ ] Adapt Stage 3: Gap Identification
  - [ ] IF investigation_type = event:
    - [ ] Categorize gaps for event investigations:
      - [ ] Critical: Incorrect disposition, missing evidence, wrong IP/network data, no confidence level
      - [ ] Significant: Incomplete investigation, weak reasoning, missing context, no historical correlation
      - [ ] Minor: Documentation issues, formatting inconsistencies
  - [ ] IF investigation_type = cve:
    - [ ] Use existing CVE gap categorization (no changes)

- [ ] Adapt Stage 4: Cognitive Bias Detection
  - [ ] IF investigation_type = event:
    - [ ] Add automation bias detection (blindly trusting alert systems)
    - [ ] Add anchoring bias detection (locked on alert severity)
    - [ ] Maintain existing bias checks (confirmation, availability, recency)
  - [ ] IF investigation_type = cve:
    - [ ] Use existing bias checks (no automation bias for CVE)

- [ ] Adapt Stage 5: Fact Verification (AC: 7)
  - [ ] IF investigation_type = event:
    - [ ] Verify IP address ownership (ASN lookup)
    - [ ] Verify geolocation claims
    - [ ] Cross-check IPs/domains against threat intelligence
    - [ ] Verify protocol/port combinations are valid
    - [ ] Verify alert rule descriptions match behavior
    - [ ] Use Perplexity MCP for threat intelligence lookups
  - [ ] IF investigation_type = cve:
    - [ ] Use existing CVE fact verification (NVD, CISA KEV, EPSS)

- [ ] Adapt Stage 6: Documentation
  - [ ] IF investigation_type = event:
    - [ ] Use security-event-investigation-review-report-tmpl.yaml template
    - [ ] Include disposition agreement/disagreement section
  - [ ] IF investigation_type = cve:
    - [ ] Use security-review-report-tmpl.yaml template (existing)

- [ ] Stage 7: Feedback Loop (no changes needed)
  - [ ] Post review report to JIRA (same for both types)
  - [ ] Update custom fields (same for both types)

## Dev Notes

### Epic Context

**Epic 7: Security Event Investigation Review Capability**

This story adapts the existing review workflow task to handle both CVE enrichments and event investigations. The task becomes polymorphic, executing different logic based on investigation type while maintaining the same 7-stage framework.

**Key Insight:** Rather than creating a separate task for event reviews, we extend the existing `review-security-enrichment.md` task with conditional logic, reducing code duplication and maintaining consistency.

**Related Stories:**
- Story 7.2: Event Investigation Quality Checklists (checklists to execute in Stage 2)
- Story 7.3: Event Investigation Review Report Template (template to use in Stage 6)
- Story 7.4: Security Reviewer Event Review Capability (agent that calls this task)
- **Story 7.5: Event Investigation Workflow Tasks** (This story)
- Story 7.6: Event Fact Verification Extension (fact verification logic for Stage 5)

### Relevant Source Tree

```
expansion-packs/bmad-1898-engineering/
├── tasks/
│   ├── review-security-enrichment.md        (TO BE MODIFIED - add event support)
│   └── fact-verify-claims.md                (TO BE MODIFIED in Story 7.6)
└── docs/
    └── stories/
        └── 7.5.event-investigation-workflow-tasks.md (This file)
```

**File to Modify:**
- `expansion-packs/bmad-1898-engineering/tasks/review-security-enrichment.md`

### 7-Stage Review Workflow Adaptation

**Stage 1: Review Preparation**
- CVE: Parse CVE enrichment comment for CVE-ID, CVSS, EPSS, KEV, patches
- Event: Parse event investigation comment for alert metadata, IPs, disposition, evidence

**Stage 2: Systematic Evaluation**
- CVE: Execute 8 checklists (Accuracy, Completeness, Actionability, Context, Documentation, Attack Mapping, Bias, Sources)
- Event: Execute 7 checklists (Completeness, Accuracy, Disposition Reasoning, Context, Methodology, Documentation, Bias)

**Stage 3: Gap Identification**
- CVE: Critical = incorrect CVSS, missing exploitability, wrong patches
- Event: Critical = incorrect disposition, missing evidence, wrong IPs

**Stage 4: Cognitive Bias Detection**
- CVE: Confirmation bias, availability bias, anchoring bias, overconfidence bias, recency bias
- Event: **Add automation bias** (blindly trusting alert), maintain existing biases

**Stage 5: Fact Verification**
- CVE: Verify CVE data against NVD, CISA KEV, FIRST EPSS
- Event: Verify IP ownership, geolocation, threat intel, protocol/port validity

**Stage 6: Documentation**
- CVE: Use security-review-report-tmpl.yaml
- Event: Use security-event-investigation-review-report-tmpl.yaml (includes disposition assessment)

**Stage 7: Feedback Loop** (same for both)
- Post review report to JIRA
- Update custom fields

### Task Polymorphism Pattern

```markdown
# review-security-enrichment.md

## Purpose
Review security analysis (CVE enrichment OR event investigation) for quality, completeness, and accuracy.

## Parameters
- ticket_id: JIRA ticket identifier
- investigation_type: 'cve' or 'event'

## Steps

### Step 1: Review Preparation

IF investigation_type = 'cve':
  - Fetch CVE enrichment comment from JIRA
  - Parse CVE enrichment structure
  - Extract: CVE-ID, CVSS, EPSS, KEV, affected versions, patches, ATT&CK
  - Extract verifiable claims

ELSE IF investigation_type = 'event':
  - Fetch event investigation comment from JIRA
  - Parse event investigation structure
  - Extract: Alert metadata, IPs, protocols, disposition, evidence
  - Extract verifiable claims (IPs, protocols, timestamps, rule IDs)

### Step 2: Systematic Evaluation

IF investigation_type = 'cve':
  - Execute 8 CVE enrichment checklists
  - Apply CVE-specific weighting
  - Calculate overall score

ELSE IF investigation_type = 'event':
  - Execute 7 event investigation checklists
  - Apply event-specific weighting (Completeness 25%, Accuracy 20%, etc.)
  - Calculate overall score

[Continue pattern for Stages 3-7]
```

### Event-Specific Fact Verification Claims

**Verifiable Claims for Event Investigations:**

1. **IP Address Ownership:** "Source IP 192.0.2.50 belongs to Acme Corp ASN 64512"
   - Verify: ASN lookup, WHOIS query
   - Tool: Perplexity search for "IP 192.0.2.50 ASN ownership"

2. **Geolocation:** "IP 203.0.113.10 is located in Tokyo, Japan"
   - Verify: Geolocation database lookup
   - Tool: Perplexity search for "IP 203.0.113.10 geolocation"

3. **Threat Intelligence:** "IP 198.51.100.25 is associated with Emotet botnet"
   - Verify: Threat intel feeds (AbusIPDB, ThreatFox, AlienVault OTX)
   - Tool: Perplexity search for "IP 198.51.100.25 threat intelligence malicious activity"

4. **Protocol/Port Validity:** "SSH typically uses port 22"
   - Verify: Standard port assignments (IANA registry)
   - Tool: Perplexity search for "Is SSH on port 22 standard?"

5. **Alert Rule Accuracy:** "Claroty rule #317 detects SSH connections in control environments"
   - Verify: Alert rule documentation
   - Tool: Manual verification against Claroty documentation (if available)

6. **Historical Patterns:** "This alert has fired 15 times in the past 6 months"
   - Verify: JIRA search for historical occurrences
   - Tool: mcp__atlassian__searchJiraIssues

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-09 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_To be populated during development_

## QA Results

_To be populated during QA_
