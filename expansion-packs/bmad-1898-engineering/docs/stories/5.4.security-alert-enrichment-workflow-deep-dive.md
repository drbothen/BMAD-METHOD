# Story 5.4: Security Alert Enrichment Workflow Deep Dive

## Status

Done

## Story

**As a** security analyst or security operations manager,
**I want** detailed technical documentation of the enrichment workflow,
**so that** I understand each stage deeply, can optimize workflow performance, and troubleshoot stage-specific issues.

## Acceptance Criteria

1. Documentation covers all 8 workflow stages with detailed technical specifications
2. Each stage includes inputs, outputs, actions, success criteria, error handling, and timing
3. Integration points documented (Atlassian MCP, Perplexity MCP, local file system)
4. Performance optimization techniques for each stage
5. Stage-specific troubleshooting guide
6. Workflow state management and resume capability explained

## Tasks / Subtasks

- [x] Create enrichment workflow deep dive documentation (AC: 1, 2)
  - [x] Create `docs/user-guide/enrichment-workflow-deep-dive.md`
  - [x] Document workflow overview and architecture
  - [x] Detail all 8 stages with technical specifications
- [x] Document Stage 1: Triage & Context Extraction (AC: 2)
  - [x] Inputs: JIRA ticket ID
  - [x] Actions: MCP tool `mcp__atlassian__getJiraIssue`, CVE regex extraction, field parsing
  - [x] Outputs: CVE ID, affected systems, initial context
  - [x] Success criteria: CVE extracted, ticket accessible
  - [x] Error handling: Missing CVE, ticket not found, permission denied
  - [x] Performance: 1-2 minutes target, optimization tips
- [x] Document Stage 2: AI-Assisted CVE Research (AC: 2)
  - [x] Inputs: CVE ID, CVSS severity (if available)
  - [x] Actions: Perplexity tool selection logic, query construction, research execution
  - [x] Tool selection: Critical→deep_research (5-10 min), High→reason (3-5 min), Medium/Low→search (1-2 min)
  - [x] Query template and customization
  - [x] Outputs: CVSS, EPSS, KEV, versions, exploits, ATT&CK suggestions, sources
  - [x] Success criteria: Core metrics obtained (CVSS, patch status), sources cited
  - [x] Error handling: Timeout, rate limiting, insufficient data
  - [x] Performance: Variable 3-10 minutes, optimization strategies
- [x] Document Stage 3: Business Context Assessment (AC: 2)
  - [x] Inputs: Affected systems, CVE intelligence
  - [x] Actions: ACR retrieval (JIRA custom field or config), exposure classification, impact analysis
  - [x] Outputs: ACR rating, system exposure, business impact
  - [x] Success criteria: ACR determined, exposure classified
  - [x] Error handling: Missing ACR (default or prompt), unknown exposure
  - [x] Performance: 2-3 minutes, optimization via pre-populated fields
- [x] Document Stage 4: Remediation Planning (AC: 2)
  - [x] Inputs: CVE intelligence, business context
  - [x] Actions: Patch identification, workaround research, compensating controls
  - [x] Outputs: Remediation steps, patch info, workarounds, controls
  - [x] Success criteria: Actionable remediation provided
  - [x] Error handling: No patch available, vendor advisory missing
  - [x] Performance: 2-3 minutes, optimization tips
- [x] Document Stage 5: MITRE ATT&CK Mapping (AC: 2)
  - [x] Inputs: CVE intelligence, vulnerability type
  - [x] Actions: Tactic mapping, technique identification, T-number validation
  - [x] Outputs: Tactics, techniques (T-numbers), detection guidance
  - [x] Success criteria: At least 1 tactic and 1 technique mapped
  - [x] Error handling: Unfamiliar vuln type, mapping uncertainty
  - [x] Performance: 1-2 minutes
- [x] Document Stage 6: Multi-Factor Priority Assessment (AC: 2)
  - [x] Inputs: CVSS, EPSS, KEV, ACR, Exposure, Exploit Status
  - [x] Actions: Priority algorithm execution, rationale generation, SLA calculation
  - [x] Outputs: Priority (P1-P5), rationale, SLA deadline
  - [x] Success criteria: Priority assigned with clear rationale
  - [x] Error handling: Missing factors, conflicting signals
  - [x] Performance: 1-2 minutes
- [x] Document Stage 7: Structured Documentation (AC: 2)
  - [x] Inputs: All enrichment data from stages 1-6
  - [x] Actions: Template processing, section population, validation
  - [x] Template: security-enrichment-tmpl.yaml (12 sections)
  - [x] Outputs: Enrichment markdown document
  - [x] Success criteria: All 12 sections populated, >75% quality score
  - [x] Error handling: Template validation failure, missing sections
  - [x] Performance: 1 minute (automated)
- [x] Document Stage 8: JIRA Update & Validation (AC: 2)
  - [x] Inputs: Enrichment document, priority, structured data
  - [x] Actions: Comment posting, custom field updates, local file save, validation
  - [x] MCP tools: `mcp__atlassian__addCommentToJiraIssue`, `mcp__atlassian__updateJiraIssue`
  - [x] Outputs: Enriched JIRA ticket, local file, metrics entry
  - [x] Success criteria: Comment posted, fields updated, local file saved
  - [x] Error handling: JIRA API errors, permission issues, field validation errors
  - [x] Performance: 1-2 minutes
- [x] Document integration points (AC: 3)
  - [x] Atlassian MCP: JIRA ticket read/update operations
  - [x] Perplexity MCP: CVE research and intelligence gathering
  - [x] Local file system: Enrichment artifacts, state files, metrics
  - [x] expansion-packs/bmad-1898-engineering/config.yaml: JIRA configuration, priority mapping, field IDs
- [x] Create performance optimization guide (AC: 4)
  - [x] Pre-populate JIRA custom fields to accelerate Stage 3
  - [x] Cache common CVE research for related vulnerabilities
  - [x] Use faster Perplexity tools for lower-priority CVEs
  - [x] Batch enrichments for efficiency
  - [x] Optimize template processing
- [x] Create stage-specific troubleshooting (AC: 5)
  - [x] Stage 1 issues: CVE extraction failures, ticket access errors
  - [x] Stage 2 issues: Perplexity timeouts, insufficient research data
  - [x] Stage 3 issues: Missing business context, unknown ACR
  - [x] Stage 4 issues: No patch available, vendor advisory missing
  - [x] Stage 5 issues: ATT&CK mapping uncertainty
  - [x] Stage 6 issues: Priority conflicts, missing factors
  - [x] Stage 7 issues: Template validation failures
  - [x] Stage 8 issues: JIRA update failures, field errors
- [x] Document workflow state management (AC: 6)
  - [x] State file location: `.workflow-state/{ticket-id}.json`
  - [x] State structure: Current stage, completed stages, stage outputs
  - [x] Resume capability: Start from last completed stage
  - [x] State cleanup: Remove after successful completion or 24 hours

## Dev Notes

### Epic Context

**Parent Epic:** Epic 5: User Documentation & Usage Guide (`docs/prd/epic-5-user-documentation-usage-guide.md`)
**This Story (5.4) Purpose:** Provide deep technical reference for enrichment workflow, enabling advanced users to optimize performance and troubleshoot complex issues.

**Dependencies:**

- Story 5.1: Installation & Initial Setup Guide (`docs/stories/5.1.installation-initial-setup-guide.md`)
- Story 5.2: Security Analyst Agent Usage Guide (`docs/stories/5.2.security-analyst-agent-usage-guide.md`) - user-level workflow documentation
- Story 3.1: Security Alert Enrichment Workflow (`docs/stories/3.1.security-alert-enrichment-workflow.md`) - implementation reference

**Related Stories:**

- Story 5.5: Security Analysis Review Workflow Deep Dive (`docs/stories/5.5.security-analysis-review-workflow-deep-dive.md`) - parallel workflow documentation
- Story 5.10: Troubleshooting, FAQ & Best Practices (`docs/stories/5.10.troubleshooting-faq-best-practices.md`) - general troubleshooting

### Source Workflow Definition

**Workflow File:** `expansion-packs/bmad-1898-engineering/workflows/security-alert-enrichment-workflow.yaml`
**Orchestration Task:** `expansion-packs/bmad-1898-engineering/tasks/enrich-security-ticket.md`

### Documentation Style Guide

**Target Deliverable:** `docs/user-guide/enrichment-workflow-deep-dive.md`

**Writing Standards for Technical Documentation:**

1. **Tone & Voice:**
   - Professional but approachable
   - User-centric (focus on "what you can do" not "what the system does")
   - Active voice preferred ("The agent extracts CVE ID" not "CVE ID is extracted")
   - Clear, concise, jargon-free (explain technical terms on first use)

2. **Formatting Conventions:**
   - **Stage Headings:** Use `## Stage N: Stage Name` format for consistency
   - **Code/Tool References:** Use backticks for tool names (`mcp__atlassian__getJiraIssue`)
   - **File Paths:** Use backticks for paths (`` `config.yaml` ``)
   - **Duration/Timing:** Use consistent format "1-2 minutes" with ranges
   - **Priority/CVE IDs:** Use code formatting (`P1`, `CVE-2024-1234`)
   - **Tables:** Use markdown tables for structured data (inputs/outputs)
   - **Lists:** Use bullet lists for items without sequence, numbered lists for steps

3. **Structure Patterns:**
   - Each stage section must include:
     - Duration estimate
     - Inputs (bulleted list)
     - Actions (numbered steps)
     - Outputs (bulleted list)
     - Success Criteria (bulleted list)
     - Error Handling (issue → solution format)
     - Performance Optimization (tips as bulleted list)
     - Common Issues (issue → resolution format)

4. **Technical Accuracy:**
   - All tool names must match exact MCP tool IDs
   - All file paths must be relative to expansion pack root
   - All timing estimates must align with workflow YAML
   - All integration points must reference actual implementation

5. **Examples & Specificity:**
   - Use concrete examples ("`CVE-2024-1234`" not "a CVE")
   - Show actual query templates and output formats
   - Include realistic data (CVSS 9.8, EPSS 87.34%, etc.)
   - Provide specific error messages and resolution steps

6. **Cross-References:**
   - Link to related documentation using relative paths
   - Reference story files when discussing implementation details
   - Link to external authoritative sources (NVD, CISA, MITRE ATT&CK)

7. **Accessibility:**
   - Use descriptive section headers (good: "Stage 1: Triage & Context Extraction", bad: "Step 1")
   - Provide context before deep technical details
   - Include summaries for complex sections
   - Add troubleshooting for anticipated problems

### 8-Stage Workflow Technical Specifications

**Overall Workflow:**

- **ID:** security-alert-enrichment-v1
- **Estimated Duration:** 10-15 minutes (95th percentile)
- **Prerequisites:** JIRA ticket, Atlassian MCP, Perplexity MCP, Security Analyst agent
- **Success Metrics:** <15 min total, all 8 stages complete, quality score >75%

---

**Stage 1: Triage & Context Extraction**

- **Duration:** 1-2 minutes
- **Inputs:**
  - JIRA ticket ID (format: PROJECT-NUMBER, e.g., AOD-1234)
- **Actions:**
  1. Call `mcp__atlassian__getJiraIssue` with ticket ID
  2. Extract CVE ID from summary/description using regex: `CVE-\d{4}-\d{4,}`
  3. Parse affected systems from custom field or description
  4. Extract initial severity if available
  5. Retrieve Asset Criticality Rating and System Exposure from custom fields
- **Outputs:**
  - CVE ID (validated format)
  - Affected systems list
  - Initial context (severity, ACR, exposure if available)
  - Ticket metadata (reporter, created date, project)
- **Success Criteria:**
  - CVE ID successfully extracted
  - JIRA ticket accessible (no permission errors)
  - Affected systems identified (or marked as TBD)
- **Error Handling:**
  - **CVE Not Found:** Prompt user "CVE ID not found in ticket. Please provide CVE ID or description:"
  - **Ticket Not Found:** Verify ticket ID format and permissions, retry with corrected ID
  - **Permission Denied:** Check JIRA permissions, ensure API token has read access
  - **Multiple CVEs:** Extract all, prompt user to select which CVE to enrich (or enrich all sequentially)
- **Performance Optimization:**
  - Cache JIRA tickets for batch enrichments (avoid redundant MCP calls)
  - Pre-validate ticket ID format before MCP call
  - Use JIRA query to fetch multiple tickets at once for batch operations
- **Common Issues:**
  - Regex fails for non-standard CVE format (e.g., "CVE 2024 1234" with spaces) → Normalize input
  - Affected systems in description text not structured → Manual extraction required

---

**Stage 2: AI-Assisted CVE Research**

- **Duration:** 3-5 minutes (High), 1-2 minutes (Low), 5-10 minutes (Critical)
- **Inputs:**
  - CVE ID
  - CVSS severity (if available from Stage 1)
- **Actions:**
  1. Determine Perplexity tool selection based on severity:
     - CVSS 9.0-10.0 (Critical): `mcp__perplexity__deep_research` (comprehensive, slower)
     - CVSS 7.0-8.9 (High): `mcp__perplexity__reason` (analytical, moderate)
     - CVSS < 7.0 or Unknown (Medium/Low): `mcp__perplexity__search` (quick)
  2. Construct research query:
     ```
     "CVE-{cve_id} vulnerability comprehensive analysis:
     - CVSS v3.1 score and vector string
     - EPSS exploitation probability score
     - CISA Known Exploited Vulnerabilities (KEV) catalog status
     - Affected product versions (full version ranges)
     - Patched versions (specific version numbers)
     - Exploit availability (PoC, active exploitation, exploit code published)
     - Active exploitation status (observed in wild, threat actor attribution)
     - MITRE ATT&CK framework mapping (tactics and techniques with T-numbers)
     - Remediation guidance (patch instructions, workarounds, compensating controls)
     - Authoritative sources (NIST NVD, CISA, vendor advisories, CVE.org)"
     ```
  3. Execute Perplexity research with selected tool
  4. Parse and structure research findings
  5. Validate core metrics (CVSS, EPSS) against known ranges
  6. Extract authoritative source URLs
- **Outputs:**
  - CVSS score (0.0-10.0) and vector string (AV:N/AC:L/PR:N/...)
  - EPSS score (0.0-100.0%)
  - CISA KEV status (Yes/No, date added if applicable)
  - Affected versions (product name, version ranges)
  - Patched versions (specific version numbers)
  - Exploit status (Active/PoC/None/Unknown)
  - Threat intelligence (active exploitation, threat actors)
  - MITRE ATT&CK suggestions (tactics, techniques, T-numbers)
  - Authoritative source URLs (NVD, CISA, vendor advisories)
- **Success Criteria:**
  - CVSS score obtained and validated (0.0-10.0)
  - Patch status determined (patched version or "no patch available")
  - At least 3 authoritative sources cited
  - Research completed within 2x expected time for severity level
- **Error Handling:**
  - **Perplexity Timeout:** Retry with simpler query (reduce detail requirements)
  - **Rate Limiting:** Wait 30 seconds, retry with exponential backoff
  - **Insufficient Data (new CVE):** Document as "Preliminary - awaiting NVD publication", use vendor advisory if available
  - **CVSS Not Available:** Estimate from description or mark as "TBD - pending NVD analysis"
  - **No Patch Available:** Document workarounds and compensating controls only
- **Performance Optimization:**
  - For P4/P5 (Low/Trivial): Always use `search` regardless of CVSS (trade depth for speed)
  - For batch enrichments: Cache research for identical CVEs
  - For related CVEs (same product): Reuse vendor advisory and general vulnerability info
  - Adjust query complexity based on time constraints
- **Common Issues:**
  - Perplexity returns generic vulnerability info, not specific CVE details → Add "CVE-{id} specific details" to query
  - EPSS score outdated (>7 days old) → Note in enrichment, mark for re-check
  - Conflicting CVSS scores (NVD vs. vendor) → Document both, explain discrepancy

---

**Stage 3: Business Context Assessment**

- **Duration:** 2-3 minutes
- **Inputs:**
  - Affected systems (from Stage 1)
  - CVE intelligence (from Stage 2)
  - JIRA custom fields (ACR, Exposure)
- **Actions:**
  1. Retrieve Asset Criticality Rating from JIRA custom field `asset_criticality_rating`
  2. If ACR not in JIRA, check `expansion-packs/bmad-1898-engineering/config.yaml` for default or prompt user
  3. Retrieve System Exposure from JIRA custom field `system_exposure`
  4. If Exposure not in JIRA, infer from system name or prompt user
  5. Assess business impact based on ACR + Exposure + CVE type:
     - High ACR + Internet Exposure + RCE = Critical business impact
     - Medium ACR + Internal + SQLi = Moderate business impact
  6. Identify affected business processes (e.g., "E-commerce checkout", "Customer database")
  7. Document business impact in clear, non-technical language for stakeholders
- **Outputs:**
  - Asset Criticality Rating (Critical/High/Medium/Low)
  - System Exposure classification (Internet/Internal/Isolated)
  - Business impact analysis (2-3 sentences)
  - Affected business processes list
  - Stakeholders to notify
- **Success Criteria:**
  - ACR rating determined (populated or defaulted)
  - System Exposure classified
  - Business impact articulated clearly
- **Error Handling:**
  - **ACR Unknown:** Default to "Medium" and document assumption, flag for confirmation
  - **Exposure Unknown:** Default to "Internal" (safer assumption), flag for confirmation
  - **Business Processes Unknown:** Use generic based on system type (e.g., "Web server: customer-facing services")
- **Performance Optimization:**
  - Pre-populate ACR and Exposure in JIRA tickets during triage (eliminates prompts)
  - Maintain asset inventory mapping (system name → ACR/Exposure) in config
  - Use CMDB integration if available
- **Common Issues:**
  - Multiple systems with different ACRs → Use highest ACR for conservative priority
  - Exposure classification ambiguous (DMZ) → Treat as Internet-exposed for safety

---

**Stage 4: Remediation Planning**

- **Duration:** 2-3 minutes
- **Inputs:**
  - CVE intelligence (patches, workarounds from Stage 2)
  - Business context (ACR, constraints)
- **Actions:**
  1. Identify primary remediation: Patch version and installation method
  2. Research workarounds if patch not immediately applicable
  3. Identify compensating controls for interim protection
  4. Create step-by-step remediation guidance (specific commands if possible)
  5. Add verification steps to confirm remediation success
  6. Note any business impact of remediation (downtime, testing required)
- **Outputs:**
  - Primary remediation (patch version, upgrade path)
  - Workaround procedures (if patch delayed)
  - Compensating controls (WAF rules, network segmentation, access controls)
  - Remediation steps (actionable, specific)
  - Verification steps (how to confirm fix)
  - Estimated effort and downtime
- **Success Criteria:**
  - Remediation guidance is actionable and specific
  - At least one remediation path provided (patch or workaround)
  - Verification steps included
- **Error Handling:**
  - **No Patch Available:** Focus on workarounds and compensating controls, document as "Mitigation only"
  - **Vendor Advisory Missing:** Use generic upgrade guidance, flag for vendor clarification
  - **Breaking Changes in Patch:** Document rollback plan, testing requirements
- **Performance Optimization:**
  - Reuse remediation templates for common vulnerability types
  - Maintain vendor-specific patch procedure library
  - Leverage Perplexity research from Stage 2 (avoid redundant research)
- **Common Issues:**
  - Patch requires breaking changes (major version upgrade) → Document migration path
  - Multiple remediation options → Prioritize by effort and risk reduction

---

**Stage 5: MITRE ATT&CK Mapping**

- **Duration:** 1-2 minutes
- **Inputs:**
  - CVE intelligence (vulnerability type, attack vector)
  - MITRE ATT&CK suggestions from Perplexity (if available)
- **Actions:**
  1. Identify vulnerability type (RCE, SQLi, XSS, Auth Bypass, etc.)
  2. Map to primary MITRE ATT&CK tactic:
     - RCE, Deserialization → Initial Access or Execution
     - SQLi, Path Traversal → Initial Access or Discovery
     - Privilege Escalation vulns → Privilege Escalation
     - Auth Bypass → Credential Access or Defense Evasion
  3. Map to specific techniques with T-numbers:
     - RCE via public application → T1190 (Exploit Public-Facing Application)
     - Auth bypass → T1078 (Valid Accounts) or T1110 (Brute Force)
  4. Validate T-numbers against MITRE ATT&CK matrix
  5. Add detection implications (what to monitor)
  6. Add defensive recommendations aligned with ATT&CK
- **Outputs:**
  - ATT&CK tactics (1-3 tactics)
  - ATT&CK techniques with T-numbers (1-5 techniques)
  - Detection implications (log sources, signatures, behaviors)
  - Defense recommendations (mitigations, controls)
- **Success Criteria:**
  - At least 1 tactic identified
  - At least 1 technique with valid T-number
  - Detection implications provided
- **Error Handling:**
  - **Unfamiliar Vulnerability Type:** Use general mapping (T1190 for external, T1068 for local)
  - **Mapping Uncertainty:** Document multiple possible techniques, note uncertainty
  - **Invalid T-number from Perplexity:** Validate against MITRE ATT&CK, correct if needed
- **Performance Optimization:**
  - Maintain mapping library (vulnerability type → common T-numbers)
  - Use Perplexity ATT&CK suggestions as starting point, validate quickly
  - For low-priority CVEs (P4/P5): Use generic mappings
- **Common Issues:**
  - Multiple applicable techniques → Include all relevant, prioritize most likely
  - T-number format incorrect (missing T prefix) → Auto-correct to T1234 format

---

**Stage 6: Multi-Factor Priority Assessment**

- **Duration:** 1-2 minutes
- **Inputs:**
  - CVSS score (from Stage 2)
  - EPSS score (from Stage 2)
  - KEV status (from Stage 2)
  - Asset Criticality Rating (from Stage 3)
  - System Exposure (from Stage 3)
  - Exploit Status (from Stage 2)
- **Actions:**
  1. Apply priority algorithm (from priority-framework.md):
     - **P1 (Critical):** (CVSS ≥ 9.0 AND KEV=Yes) OR (CVSS ≥ 9.0 AND Internet+Critical ACR AND Exploit=Active)
     - **P2 (High):** (CVSS ≥ 7.0 AND High ACR) OR (CVSS ≥ 9.0 AND Medium/Low ACR)
     - **P3 (Medium):** (CVSS 4.0-6.9 AND Medium ACR) OR (CVSS 7.0-8.9 AND Low ACR)
     - **P4 (Low):** CVSS < 4.0 OR (Isolated systems AND Exploit=None)
     - **P5 (Trivial):** CVSS < 4.0 AND Low ACR AND Isolated AND No remediation available
  2. Generate priority rationale explaining all factors:
     - "P1: CVSS 9.8 (Critical severity) + CISA KEV listed + Internet-exposed High criticality asset + Active exploitation in wild"
  3. Calculate SLA deadline based on priority:
     - P1: 24 hours
     - P2: 7 days
     - P3: 30 days
     - P4: 90 days
     - P5: Best effort
  4. Validate priority assignment (sanity check for edge cases)
- **Outputs:**
  - Priority level (P1/P2/P3/P4/P5)
  - Priority rationale (explains all contributing factors)
  - SLA deadline (timestamp)
  - Risk summary (1-2 sentences)
- **Success Criteria:**
  - Priority assigned with clear rationale
  - Rationale references all major factors
  - SLA deadline calculated correctly
- **Error Handling:**
  - **Missing Factors:** Use conservative defaults (assume higher risk)
  - **Conflicting Signals:** Document conflict, use most conservative priority
  - **Edge Cases:** Flag for manual review if automated logic uncertain
- **Performance Optimization:**
  - Pre-calculate priority matrix for common factor combinations
  - Automated priority calculation (no manual intervention for clear cases)
- **Common Issues:**
  - CVSS 6.9 vs 7.0 threshold edge case → Apply algorithm strictly, document in rationale
  - KEV=Yes but CVSS=Medium → KEV overrides lower CVSS (escalate priority)

---

**Stage 7: Structured Documentation**

- **Duration:** 1 minute (automated)
- **Inputs:**
  - All enrichment data from Stages 1-6
- **Actions:**
  1. Load template: `templates/security-enrichment-tmpl.yaml`
  2. Populate all 12 template sections:
     1. Executive Summary (2-3 sentences: CVE, CVSS, priority, SLA)
     2. Vulnerability Details (CVE, title, type, versions)
     3. Severity Metrics (CVSS, EPSS, KEV)
     4. Affected Systems & Versions
     5. Remediation Guidance
     6. MITRE ATT&CK Mapping
     7. Business Impact Assessment
     8. Threat Intelligence
     9. Verification & Testing
     10. References & Sources
     11. Related CVEs
     12. Analyst Notes
  3. Validate template completeness (all sections non-empty)
  4. Calculate quality score based on:
     - Completeness (all sections present)
     - Source citations (authoritative sources linked)
     - Actionability (clear remediation steps)
  5. Generate markdown document
- **Outputs:**
  - Enrichment markdown document (12 sections)
  - Quality score (0-100)
  - Validation status (pass/fail)
- **Success Criteria:**
  - All 12 sections populated
  - Quality score ≥ 75%
  - Executive summary present
- **Error Handling:**
  - **Missing Section:** Populate with placeholder "TBD - requires additional research" and flag
  - **Validation Failure:** List missing sections, prompt for completion
  - **Quality Score < 75%:** List gaps, suggest improvements
- **Performance Optimization:**
  - Template processing is fully automated (no user interaction)
  - Parallel section generation if possible
- **Common Issues:**
  - Related CVEs section empty → Use "None identified" placeholder
  - Verification section generic → Auto-populate with basic "Re-scan after patch" guidance

---

**Stage 8: JIRA Update & Validation**

- **Duration:** 1-2 minutes
- **Inputs:**
  - Enrichment markdown document
  - Priority level
  - Structured data (CVSS, EPSS, KEV, etc.)
- **Actions:**
  1. Post enrichment as JIRA comment using `mcp__atlassian__addCommentToJiraIssue`
     - Format: Markdown (JIRA renders markdown)
     - Content: Full 12-section enrichment
  2. Update JIRA custom fields using `mcp__atlassian__updateJiraIssue`:
     - CVE ID, Affected Systems, ACR, System Exposure
     - CVSS Score, EPSS Score, KEV Status, Exploit Status
  3. Save enrichment to local file: `enrichments/{ticket-id}-enrichment.md`
  4. Append metrics to CSV: `metrics/enrichment-metrics.csv`
     - ticket_id, cve_id, analyst, timestamps, duration, quality_score, priority, etc.
  5. Validate JIRA update success (check API response)
  6. Clean up workflow state file: `.workflow-state/{ticket-id}.json`
- **Outputs:**
  - JIRA comment posted successfully
  - JIRA custom fields updated (8 fields)
  - Local enrichment file saved
  - Metrics CSV entry appended
  - Workflow state cleaned up
- **Success Criteria:**
  - JIRA comment posted (HTTP 200/201)
  - All 8 custom fields updated without errors
  - Local file saved successfully
  - Metrics logged
- **Error Handling:**
  - **JIRA Comment Post Failure:** Save locally, provide manual copy instructions
  - **Custom Field Update Failure:** Identify specific field error (validation, permissions), retry individual fields
  - **Permission Denied:** Verify API token permissions, escalate to JIRA admin
  - **Field Validation Error:** Check field type and constraints, adjust data format
  - **Network Timeout:** Retry with exponential backoff (3 attempts)
- **Performance Optimization:**
  - Batch field updates in single API call if possible
  - Parallel JIRA operations (comment + field updates) if MCP supports
  - Local file write async (don't block on file I/O)
- **Common Issues:**
  - CVSS field expects number but receives string → Type conversion before update
  - Custom field ID incorrect in `expansion-packs/bmad-1898-engineering/config.yaml` → Verify field IDs, update config
  - Comment too large (>32KB) → Truncate with link to full local file

---

### Integration Points

**Atlassian MCP (JIRA Operations):**

- **Tools Used:**
  - `mcp__atlassian__getJiraIssue` (Stage 1: Read ticket)
  - `mcp__atlassian__addCommentToJiraIssue` (Stage 8: Post enrichment)
  - `mcp__atlassian__updateJiraIssue` (Stage 8: Update custom fields)
  - `mcp__atlassian__searchJiraIssues` (Optional: Batch enrichment)
- **Configuration:** config.yaml (cloud_id, project_key, custom_fields)
- **Authentication:** API token or OAuth 2.0
- **Error Codes:**
  - 401: Authentication failed → Check API token
  - 403: Permission denied → Check user permissions
  - 404: Ticket not found → Verify ticket ID
  - 400: Validation error → Check field constraints

**Perplexity MCP (CVE Research):**

- **Tools Used:**
  - `mcp__perplexity__search` (Quick research, 1-2 min)
  - `mcp__perplexity__reason` (Analytical research, 3-5 min)
  - `mcp__perplexity__deep_research` (Comprehensive research, 5-10 min)
- **Tool Selection Logic:**
  - CVSS 9.0-10.0 → deep_research
  - CVSS 7.0-8.9 → reason
  - CVSS < 7.0 → search
- **Rate Limiting:** Respect Perplexity API limits, implement backoff
- **Fallback:** Manual research if Perplexity unavailable

**Local File System:**

- **Enrichment Artifacts:** `enrichments/{ticket-id}-enrichment.md`
- **Workflow State:** `.workflow-state/{ticket-id}.json`
- **Metrics:** `metrics/enrichment-metrics.csv`
- **Permissions:** Ensure write access to all directories

**expansion-packs/bmad-1898-engineering/config.yaml:**

- **JIRA Configuration:** cloud_id, project_key, custom_fields
- **Priority Mapping:** P1-P5 to JIRA priority values
- **Defaults:** Default ACR, default Exposure
- **Validation:** YAML syntax, required fields present

### Workflow State Management

**State File Location:** `.workflow-state/{ticket-id}.json`

**State Structure:**

```json
{
  "ticket_id": "AOD-1234",
  "cve_id": "CVE-2024-1234",
  "current_stage": 3,
  "started_at": "2025-11-08T14:30:00Z",
  "stages": {
    "stage1": {
      "status": "completed",
      "completed_at": "2025-11-08T14:31:23Z",
      "outputs": {
        "cve_id": "CVE-2024-1234",
        "affected_systems": ["prod-web-01"],
        "acr": "High",
        "exposure": "Internet"
      }
    },
    "stage2": {
      "status": "completed",
      "completed_at": "2025-11-08T14:35:35Z",
      "outputs": {
        "cvss": 9.8,
        "epss": 87.34,
        "kev": "Yes",
        "patched_version": "2.5.33+"
      }
    },
    "stage3": {
      "status": "in_progress",
      "started_at": "2025-11-08T14:35:36Z"
    }
  }
}
```

**Resume Capability:**

- If workflow interrupted (error, timeout, user abort), state preserved
- Resume command: `*enrich-ticket AOD-1234 --resume`
- Workflow reads state file, continues from last completed stage
- Completed stage outputs reused (no redundant research)

**State Cleanup:**

- State file deleted after successful Stage 8 completion
- Orphaned state files (>24 hours old) auto-cleaned

**Benefits:**

- Prevents data loss on interruption
- Enables step-by-step debugging
- Allows pausing long enrichments
- Audit trail of workflow execution

## Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/documentation/`

**Test Cases:**

1. **TC-DOC-040: Workflow Stage Documentation Accuracy** (AC: 1, 2)
   - Objective: Verify all 8 stages match implementation
   - Test: Compare documentation to workflow YAML and task implementation
   - Expected: 100% alignment
   - Acceptance Criteria Validated: AC 1 (all 8 stages documented), AC 2 (inputs/outputs/actions/success/error/timing complete)

2. **TC-DOC-041: Integration Point Verification** (AC: 3)
   - Objective: Verify all MCP tools and config references are correct
   - Test: Execute workflow, verify all tools called as documented
   - Expected: All tool calls match documentation
   - Acceptance Criteria Validated: AC 3 (integration points documented)

3. **TC-DOC-042: Performance Optimization Impact** (AC: 4)
   - Objective: Measure impact of documented optimization techniques
   - Test: Compare enrichment time with/without optimizations
   - Expected: Optimizations reduce time by ≥20%
   - Acceptance Criteria Validated: AC 4 (performance optimization techniques)

4. **TC-DOC-043: Troubleshooting Effectiveness** (AC: 5)
   - Objective: Verify stage-specific troubleshooting resolves issues
   - Test: Introduce errors at each stage, resolve using documentation
   - Expected: All issues resolved without external help
   - Acceptance Criteria Validated: AC 5 (stage-specific troubleshooting guide)

5. **TC-DOC-044: State Management Validation** (AC: 6)
   - Objective: Verify resume capability works as documented
   - Test: Interrupt workflow at each stage, resume, verify completion
   - Expected: All stages resume correctly from interruption point
   - Acceptance Criteria Validated: AC 6 (workflow state management and resume capability)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-11-08 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### File List

- **Created:**
  - `docs/user-guide/enrichment-workflow-deep-dive.md` - Comprehensive technical documentation for 8-stage enrichment workflow

### Completion Notes

- Created complete enrichment workflow deep dive documentation covering all 8 stages
- Each stage includes: duration, purpose, inputs, outputs, actions, success criteria, error handling, performance optimization, and common issues
- Documented all integration points: Atlassian MCP, Perplexity MCP, file system, config.yaml
- Created comprehensive performance optimization guide with stage-specific and cross-stage strategies
- Created stage-specific troubleshooting guide with issue/resolution tables for all 8 stages
- Documented workflow state management with JSON structure, resume capability, state cleanup, and audit trail benefits
- Added quick reference appendix with workflow summary, MCP tools, priority algorithm, SLA deadlines, and file locations
- Included related documentation links and document metadata
- All acceptance criteria satisfied:
  - AC 1: All 8 workflow stages documented with detailed technical specifications ✅
  - AC 2: Each stage includes inputs, outputs, actions, success criteria, error handling, timing ✅
  - AC 3: Integration points fully documented (Atlassian MCP, Perplexity MCP, file system) ✅
  - AC 4: Performance optimization techniques for each stage ✅
  - AC 5: Stage-specific troubleshooting guide ✅
  - AC 6: Workflow state management and resume capability explained ✅

### Change Log

- 2025-11-08: Created docs/user-guide/enrichment-workflow-deep-dive.md with complete 8-stage workflow documentation
- 2025-11-08: All tasks completed, story marked Ready for Review

## QA Results

### Review Date: 2025-11-08

### Reviewed By: Quinn (Test Architect)

### Documentation Quality Assessment

**Overall Assessment: Excellent (90/100)**

This documentation deliverable is comprehensive, technically accurate, and highly actionable. All 6 acceptance criteria are fully satisfied with exemplary attention to detail. The 8-stage workflow is documented with exceptional clarity, providing both high-level architectural understanding and granular technical specifications.

**Strengths:**

- **Complete coverage**: Every workflow stage includes all required elements (inputs, outputs, actions, success criteria, error handling, timing, optimization, troubleshooting)
- **Technical accuracy**: All MCP tool names, file paths, and configuration references are correct and validated
- **Practical focus**: Documentation is user-centric with concrete examples, specific commands, and actionable guidance
- **Excellent structure**: Consistent formatting, logical organization, effective use of tables and code blocks
- **Comprehensive troubleshooting**: Each stage includes issue/resolution tables with debug steps
- **Integration clarity**: All integration points (Atlassian MCP, Perplexity MCP, file system, config) thoroughly documented

### Requirements Traceability

**AC 1: Documentation covers all 8 workflow stages with detailed technical specifications** ✅

- Stage 1: Triage & Context Extraction (lines 55-111) - Complete
- Stage 2: AI-Assisted CVE Research (lines 114-221) - Complete
- Stage 3: Business Context Assessment (lines 223-312) - Complete
- Stage 4: Remediation Planning (lines 315-402) - Complete
- Stage 5: MITRE ATT&CK Mapping (lines 405-500) - Complete
- Stage 6: Multi-Factor Priority Assessment (lines 503-605) - Complete
- Stage 7: Structured Documentation (lines 608-692) - Complete
- Stage 8: JIRA Update & Validation (lines 695-794) - Complete
- All stages present with comprehensive technical specifications

**AC 2: Each stage includes inputs, outputs, actions, success criteria, error handling, and timing** ✅

- Every stage contains:
  - Duration estimate with timing ranges
  - Inputs table with source and requirements
  - Numbered action steps with specific details
  - Outputs list with formats and examples
  - Success criteria checklist
  - Error handling table with issue/resolution pairs
  - Performance optimization techniques
  - Common issues section with resolutions
- Consistent structure applied across all 8 stages

**AC 3: Integration points documented (Atlassian MCP, Perplexity MCP, local file system)** ✅

- Atlassian MCP (lines 799-839): Tools, configuration, authentication, error codes, rate limiting
- Perplexity MCP (lines 842-876): Tool selection logic, query construction, rate limits, fallback strategies
- Local File System (lines 880-910): Directory structure, permissions, formats, cleanup policies
- Config.yaml (lines 913-954): Configuration sections, validation, troubleshooting
- All integration points include concrete examples and troubleshooting guidance

**AC 4: Performance optimization techniques for each stage** ✅

- Comprehensive performance optimization guide (lines 957-1051)
- Stage-specific optimizations for all 8 stages with concrete techniques
- Cross-stage optimizations: Batch enrichment, intelligent caching, priority-based depth, parallel processing
- Performance targets table with duration goals by priority level
- Metrics tracking guidance for performance monitoring

**AC 5: Stage-specific troubleshooting guide** ✅

- Dedicated troubleshooting section for each stage (lines 1054-1186)
- Stage 1: 4 issues with debug steps
- Stage 2: 5 issues with debug steps
- Stage 3: 4 issues with debug steps
- Stage 4: 4 issues with debug steps
- Stage 5: 4 issues with debug steps
- Stage 6: 4 issues with debug steps
- Stage 7: 4 issues with debug steps
- Stage 8: 5 issues with debug steps
- Each includes issue/symptoms/resolution table plus debug steps

**AC 6: Workflow state management and resume capability explained** ✅

- Complete section on state management (lines 1189-1361)
- State file structure with detailed JSON example
- Resume capability: triggers, process, benefits
- State management actions: creation, updates, cleanup
- Resume example scenarios with concrete cases
- State file integrity validation
- Audit trail capabilities documented

### Compliance Check

- **Coding Standards:** N/A (documentation story) ✓
- **Project Structure:** ✓ File created in correct location (`docs/user-guide/enrichment-workflow-deep-dive.md`)
- **Testing Strategy:** N/A (documentation story) ✓
- **All ACs Met:** ✓ All 6 acceptance criteria fully satisfied
- **Style Guide Adherence:** ✓ Excellent compliance with documentation style guide (Dev Notes lines 139-189)
  - Professional, user-centric tone ✓
  - Active voice throughout ✓
  - Consistent formatting (backticks, tables, lists) ✓
  - Proper stage section structure ✓
  - Concrete examples and specific details ✓
  - Valid cross-references ✓

### Technical Validation

**Verified Elements:**

- ✅ All MCP tool names match expected format (`mcp__atlassian__getJiraIssue`, `mcp__perplexity__search`, etc.)
- ✅ File paths relative to expansion pack root are correct
- ✅ Custom field references align with `config.yaml`
- ✅ Priority algorithm matches framework specification
- ✅ Timing estimates consistent with workflow specifications
- ✅ Cross-referenced files validated:
  - `data/priority-framework.md` ✓ exists
  - `docs/user-guide/security-analyst-agent.md` ✓ exists
  - `docs/INSTALLATION.md` ✓ exists
  - Story file references use correct doc paths ✓

### NFR Validation

**Security:** N/A (documentation story)

**Performance:** N/A (documentation story)

**Reliability:** PASS

- Documentation is complete, accurate, and internally consistent
- All workflow stages properly sequenced and cross-referenced
- Error handling comprehensively documented for all failure scenarios

**Maintainability:** PASS

- Excellent organization with clear section hierarchy
- Consistent formatting enables easy updates
- Comprehensive cross-referencing facilitates navigation
- Well-structured for future enhancements

### Recommendations

**Future Enhancements (Non-blocking):**

- Consider adding example JIRA comment markdown in Stage 8 section to show exact formatting
- Consider adding worked example of quality score calculation in Stage 7 (currently formula-only)
- Consider adding visual diagrams (Mermaid) for workflow state transitions
- Consider adding troubleshooting decision tree for common multi-stage issues

**Quality Improvements (Optional):**

- All current content is excellent; no required changes identified
- Minor: Could expand asset_mappings config example with additional systems
- Minor: Could add example of custom priority override with justification

### Gate Status

**Gate:** PASS → `/Users/jmagady/Dev/BMAD-METHOD/expansion-packs/bmad-1898-engineering/docs/qa/gates/5.4-security-alert-enrichment-workflow-deep-dive.yml`

**Quality Score:** 90/100

- Completeness: 100% - All acceptance criteria fully met
- Technical Accuracy: 95% - All references validated, excellent precision
- Clarity: 95% - Exceptionally clear explanations and structure
- Usability: 90% - Highly actionable, minor enhancement opportunities
- Maintainability: 90% - Well-organized, easy to update

**Decision Rationale:**
All 6 acceptance criteria comprehensively satisfied. Documentation demonstrates exceptional quality with complete workflow coverage, technical accuracy, practical focus, and excellent organization. The deliverable provides both architectural overview and granular implementation details, making it valuable for both understanding and operational use. Minor enhancement recommendations are truly optional improvements, not blockers.

### Recommended Status

✓ **Ready for Done**

This story is complete and ready to be marked as Done. The documentation deliverable fully satisfies all acceptance criteria and provides comprehensive, accurate, and actionable guidance for understanding and troubleshooting the Security Alert Enrichment Workflow.
