# Story 1.7: Multi-Factor Priority Assessment

## Status
Draft

## Story
**As a** Security Analyst agent,
**I want** to calculate vulnerability priority using CVSS + EPSS + KEV + Business Context,
**so that** remediation efforts focus on genuine exploitable threats.

## Acceptance Criteria
1. Agent considers all priority factors: CVSS severity, EPSS exploitation probability, KEV active exploitation status, System criticality (ACR rating), System exposure (Internet/Internal/Isolated), Exploit availability
2. Agent applies priority framework (P1-P5)
3. Agent provides rationale for priority level
4. Agent identifies SLA remediation timeline

## Tasks / Subtasks
- [ ] Create priority assessment task (AC: 1, 2, 3, 4)
  - [ ] Create `tasks/assess-vulnerability-priority.md`
  - [ ] Implement multi-factor priority calculation algorithm
  - [ ] Define priority framework (P1-P5) with criteria
  - [ ] Generate rationale explaining priority decision
  - [ ] Map priority to SLA timeline
- [ ] Implement CVSS severity factor (AC: 1)
  - [ ] Critical: 9.0-10.0 → High priority weight
  - [ ] High: 7.0-8.9 → Moderate priority weight
  - [ ] Medium: 4.0-6.9 → Low priority weight
  - [ ] Low: 0.1-3.9 → Minimal priority weight
- [ ] Implement EPSS exploitation probability factor (AC: 1)
  - [ ] Very High: >0.75 → High priority weight
  - [ ] High: 0.50-0.75 → Moderate priority weight
  - [ ] Moderate: 0.25-0.49 → Low priority weight
  - [ ] Low: <0.25 → Minimal priority weight
- [ ] Implement KEV status factor (AC: 1)
  - [ ] Listed on CISA KEV → Automatic P1 or P2 (highest priority)
  - [ ] Not Listed → Proceed with other factors
- [ ] Implement Asset Criticality Rating (ACR) factor (AC: 1)
  - [ ] Critical: Mission-critical systems → High priority weight
  - [ ] High: Important business systems → Moderate priority weight
  - [ ] Medium: Standard systems → Low priority weight
  - [ ] Low: Development/test systems → Minimal priority weight
- [ ] Implement System Exposure factor (AC: 1)
  - [ ] Internet-Facing: Public exposure → High priority weight
  - [ ] Internal Network: Limited exposure → Moderate priority weight
  - [ ] Isolated: Air-gapped/DMZ → Low priority weight
- [ ] Implement Exploit Availability factor (AC: 1)
  - [ ] Active Exploitation: In the wild → Highest priority weight
  - [ ] Public Exploit: PoC available → High priority weight
  - [ ] Theoretical: No known exploit → Low priority weight
- [ ] Define Priority Framework (P1-P5) (AC: 2)
  - [ ] P1 - Critical: Immediate action (patch within 24h)
  - [ ] P2 - High: Urgent action (patch within 7 days)
  - [ ] P3 - Medium: Important (patch within 30 days)
  - [ ] P4 - Low: Routine (patch within 90 days)
  - [ ] P5 - Info: Awareness only (no SLA)
- [ ] Generate Priority Rationale (AC: 3)
  - [ ] List all factors considered
  - [ ] Explain weight of each factor
  - [ ] Describe why priority level chosen
  - [ ] Note any overriding factors (e.g., KEV listing)
- [ ] Map Priority to SLA Timeline (AC: 4)
  - [ ] P1 → 24 hours
  - [ ] P2 → 7 days
  - [ ] P3 → 30 days
  - [ ] P4 → 90 days
  - [ ] P5 → No SLA
  - [ ] Calculate exact deadline from enrichment date

## Dev Notes

### Multi-Factor Priority Algorithm

```python
def calculate_priority(vulnerability, system, config):
    """
    Calculate vulnerability priority using multi-factor risk assessment

    Returns: (priority_level, priority_score, rationale)
    """

    factors = {
        'cvss': 0,
        'epss': 0,
        'kev': 0,
        'acr': 0,
        'exposure': 0,
        'exploit': 0
    }

    # Factor 1: CVSS Severity (0-4 points)
    if vulnerability.cvss_score >= 9.0:
        factors['cvss'] = 4
    elif vulnerability.cvss_score >= 7.0:
        factors['cvss'] = 3
    elif vulnerability.cvss_score >= 4.0:
        factors['cvss'] = 2
    else:
        factors['cvss'] = 1

    # Factor 2: EPSS Exploitation Probability (0-4 points)
    if vulnerability.epss_score >= 0.75:
        factors['epss'] = 4
    elif vulnerability.epss_score >= 0.50:
        factors['epss'] = 3
    elif vulnerability.epss_score >= 0.25:
        factors['epss'] = 2
    else:
        factors['epss'] = 1

    # Factor 3: CISA KEV Status (0-5 points, OVERRIDE)
    if vulnerability.kev_status == "Listed":
        factors['kev'] = 5  # Automatic high priority

    # Factor 4: Asset Criticality Rating (0-4 points)
    acr_map = {"Critical": 4, "High": 3, "Medium": 2, "Low": 1}
    factors['acr'] = acr_map.get(system.acr_rating, 2)

    # Factor 5: System Exposure (0-3 points)
    exposure_map = {"Internet": 3, "Internal": 2, "Isolated": 1}
    factors['exposure'] = exposure_map.get(system.exposure, 2)

    # Factor 6: Exploit Availability (0-4 points)
    exploit_map = {
        "Active Exploitation": 4,
        "Public Exploit": 3,
        "PoC": 2,
        "Theoretical": 1
    }
    factors['exploit'] = exploit_map.get(vulnerability.exploit_status, 1)

    # Calculate total score (max 24 points)
    total_score = sum(factors.values())

    # Map score to priority level
    if total_score >= 20 or factors['kev'] == 5:
        priority = "P1"  # Critical
        sla_hours = 24
    elif total_score >= 15:
        priority = "P2"  # High
        sla_hours = 168  # 7 days
    elif total_score >= 10:
        priority = "P3"  # Medium
        sla_hours = 720  # 30 days
    elif total_score >= 5:
        priority = "P4"  # Low
        sla_hours = 2160  # 90 days
    else:
        priority = "P5"  # Info
        sla_hours = None

    # Generate rationale
    rationale = generate_rationale(factors, total_score, priority)

    return (priority, total_score, rationale, sla_hours)
```

### Priority Framework Definitions

**P1 - Critical (24 hour SLA):**
- **Criteria:** CVSS ≥9.0 + EPSS ≥0.75 + KEV Listed, OR Active Exploitation + Internet-Facing + Critical ACR
- **Examples:** RCE in internet-facing production system with active exploitation
- **Action:** Immediate emergency patching, war room if needed

**P2 - High (7 day SLA):**
- **Criteria:** CVSS ≥7.0 + EPSS ≥0.50 + (KEV Listed OR Public Exploit), OR High ACR + Internet-Facing
- **Examples:** High severity with public PoC affecting important systems
- **Action:** Urgent patching within next sprint

**P3 - Medium (30 day SLA):**
- **Criteria:** CVSS 4.0-6.9 + Moderate EPSS + Internal Exposure, OR Medium ACR + No Active Exploitation
- **Examples:** Moderate severity affecting internal systems with no known exploits
- **Action:** Planned patching in regular maintenance window

**P4 - Low (90 day SLA):**
- **Criteria:** CVSS <4.0 OR Low ACR + No Exploit + Isolated System
- **Examples:** Low severity on development systems with theoretical risk
- **Action:** Routine patching during scheduled maintenance

**P5 - Informational (No SLA):**
- **Criteria:** CVSS <2.0 + No Exploit + Test Environment
- **Examples:** Theoretical vulnerabilities with minimal business impact
- **Action:** Awareness only, optional patching

### Rationale Generation Template

```markdown
## Priority Assessment

**Priority Level:** {{priority}} - {{priority_label}}
**Overall Risk Score:** {{total_score}}/24 points

**Factor Analysis:**

1. **CVSS Severity:** {{cvss_score}} ({{cvss_severity}}) → {{cvss_points}} points
   - Vulnerability has {{cvss_interpretation}}

2. **EPSS Exploitation Probability:** {{epss_score}} ({{epss_percentile}}th percentile) → {{epss_points}} points
   - {{epss_interpretation}}

3. **CISA KEV Status:** {{kev_status}} → {{kev_points}} points
   - {{kev_interpretation}}

4. **Asset Criticality Rating:** {{acr_rating}} → {{acr_points}} points
   - System is {{acr_interpretation}}

5. **System Exposure:** {{exposure}} → {{exposure_points}} points
   - System is {{exposure_interpretation}}

6. **Exploit Availability:** {{exploit_status}} → {{exploit_points}} points
   - {{exploit_interpretation}}

**Priority Rationale:**
{{rationale_explanation}}

**SLA Remediation Deadline:** {{sla_deadline}}
{{sla_warning}}
```

### Priority Modifiers (Override Rules)

**Automatic P1 (regardless of other factors):**
- KEV Listed + Internet-Facing + Critical ACR
- Active Exploitation + CVSS ≥9.0 + High ACR

**Priority Elevation (+1 level):**
- Compliance requirement (PCI-DSS, HIPAA)
- Previous breach involving similar vulnerability
- Executive mandate

**Priority Reduction (-1 level):**
- Effective compensating controls in place
- System scheduled for decommission (within 30 days)
- Vendor end-of-life (no patch available)

### SLA Deadline Calculation

```python
from datetime import datetime, timedelta

def calculate_sla_deadline(enrichment_timestamp, sla_hours):
    """Calculate exact SLA deadline based on enrichment time"""

    if sla_hours is None:
        return "No SLA"

    deadline = enrichment_timestamp + timedelta(hours=sla_hours)

    # Format: "2025-11-07 10:30:00 UTC (24 hours from enrichment)"
    return deadline.strftime("%Y-%m-%d %H:%M:%S UTC")
```

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/tasks/`

**Test Standards:**
- Unit tests: Test priority calculation algorithm
- Test all factor combinations
- Verify override rules apply correctly
- Test rationale generation
- Validate SLA deadline calculation

**Test Cases:**
1. **P1 Critical:** CVSS 9.8, EPSS 0.85, KEV Listed, Critical ACR, Internet-Facing
2. **P2 High:** CVSS 8.0, EPSS 0.60, Public Exploit, High ACR, Internal
3. **P3 Medium:** CVSS 6.5, EPSS 0.30, No Exploit, Medium ACR, Internal
4. **P4 Low:** CVSS 3.5, EPSS 0.10, Theoretical, Low ACR, Isolated
5. **P5 Info:** CVSS 1.5, EPSS 0.05, No Exploit, Test Environment
6. **Override:** CVSS 6.0 but KEV Listed → P1
7. **Modifiers:** P2 elevated to P1 due to compliance requirement

**Testing Requirements:**
- Test with real CVE data
- Verify priority matches manual assessment
- Test edge cases (missing data, invalid values)
- Validate SLA deadlines accurate
- Test rationale clarity and completeness

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated after QA review_
