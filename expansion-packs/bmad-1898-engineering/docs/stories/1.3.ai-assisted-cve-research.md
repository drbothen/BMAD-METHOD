# Story 1.3: AI-Assisted CVE Research

## Status
Draft

## Story
**As a** Security Analyst agent,
**I want** to research CVEs using Perplexity MCP,
**so that** I can gather comprehensive vulnerability intelligence in minutes.

## Acceptance Criteria
1. Agent constructs research queries including CVSS, EPSS, KEV, exploits, patches, ATT&CK
2. Agent selects appropriate Perplexity tool (search/reason/deep_research) based on severity
3. Agent receives structured research findings
4. Agent cites authoritative sources (NVD, CISA, vendor advisories)

## Tasks / Subtasks
- [ ] Create CVE research task workflow (AC: 1, 2, 3, 4)
  - [ ] Create `tasks/research-cve.md` procedure
  - [ ] Design research query templates for different severities
  - [ ] Implement Perplexity tool selection logic
  - [ ] Parse and structure Perplexity responses
- [ ] Implement query construction (AC: 1)
  - [ ] Build comprehensive query including all required intel
  - [ ] Request CVSS score and vector string
  - [ ] Request EPSS exploitation probability score
  - [ ] Request CISA KEV catalog status
  - [ ] Request exploit availability and proof-of-concept status
  - [ ] Request patch availability and versions
  - [ ] Request MITRE ATT&CK tactics and techniques
  - [ ] Request authoritative source citations
- [ ] Implement severity-based tool selection (AC: 2)
  - [ ] Critical (CVSS 9.0-10.0): Use `mcp__perplexity__deep_research`
  - [ ] High (CVSS 7.0-8.9): Use `mcp__perplexity__reason`
  - [ ] Medium (CVSS 4.0-6.9): Use `mcp__perplexity__search`
  - [ ] Low (CVSS 0.1-3.9): Use `mcp__perplexity__search`
  - [ ] Unknown severity: Default to `mcp__perplexity__reason`
- [ ] Parse and validate research results (AC: 3, 4)
  - [ ] Extract CVSS score and vector
  - [ ] Extract EPSS score
  - [ ] Extract KEV status (Listed/Not Listed)
  - [ ] Extract affected versions
  - [ ] Extract patch information
  - [ ] Extract exploit status
  - [ ] Extract MITRE ATT&CK mappings
  - [ ] Validate all sources are authoritative
  - [ ] Detect hallucinations and flag uncertain information

## Dev Notes

### Research Query Template (Critical Vulnerabilities)
```
Research CVE-{cve_id} comprehensive vulnerability intelligence:

REQUIRED INFORMATION:
1. CVSS Base Score and Vector String (from NVD)
2. EPSS Exploitation Probability Score (from FIRST.org EPSS)
3. CISA KEV Catalog Status (Listed or Not Listed)
4. Affected Product Versions (precise version ranges)
5. Patched Versions (if available)
6. Exploit Availability (PoC, exploit code, active exploitation)
7. MITRE ATT&CK Tactics and Techniques (with T-numbers)
8. Vendor Security Advisory Links

AUTHORITATIVE SOURCES REQUIRED:
- NIST NVD (nvd.nist.gov)
- CISA KEV Catalog (cisa.gov/known-exploited-vulnerabilities-catalog)
- FIRST EPSS (first.org/epss)
- MITRE ATT&CK (attack.mitre.org)
- Vendor Security Advisories (official vendor sites)

Provide citations for all factual claims.
```

### Perplexity Tool Selection Logic
```
if cvss_score >= 9.0:
    tool = mcp__perplexity__deep_research
    reason = "Critical severity requires comprehensive analysis"
elif cvss_score >= 7.0:
    tool = mcp__perplexity__reason
    reason = "High severity requires moderate depth analysis"
elif cvss_score >= 4.0:
    tool = mcp__perplexity__search
    reason = "Medium severity requires basic research"
else:
    tool = mcp__perplexity__search
    reason = "Low severity requires quick lookup"
```

### Expected Research Output Structure
```yaml
cve_id: CVE-2024-1234
cvss:
  score: 9.8
  vector: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
  severity: Critical
epss:
  score: 0.85
  percentile: 97.5
kev:
  status: Listed
  date_added: 2024-11-01
  due_date: 2024-11-22
affected_versions:
  - "Apache Struts 2.0.0 - 2.5.32"
patched_versions:
  - "Apache Struts 2.5.33+"
exploit_status:
  poc_available: true
  exploit_code_public: true
  active_exploitation: true
attack_mapping:
  tactics:
    - Initial Access
    - Execution
  techniques:
    - T1190 - Exploit Public-Facing Application
    - T1059 - Command and Scripting Interpreter
sources:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-1234
    type: NVD
  - url: https://www.cisa.gov/known-exploited-vulnerabilities-catalog
    type: CISA KEV
  - url: https://www.first.org/epss/
    type: FIRST EPSS
```

### Authoritative Source Validation
**Trusted Sources (Accept):**
- nvd.nist.gov (NIST NVD)
- cisa.gov (CISA)
- first.org (FIRST EPSS)
- attack.mitre.org (MITRE ATT&CK)
- security.microsoft.com (Microsoft)
- access.redhat.com/security (Red Hat)
- ubuntu.com/security (Ubuntu)
- security.apache.org (Apache)

**Untrusted Sources (Flag):**
- Blog posts (unless from security researchers)
- News sites (secondary sources)
- Social media
- Unverified forums

### Error Handling
**Perplexity Timeout:**
- Retry with simpler query
- Fall back to less comprehensive tool
- Offer manual research option

**Missing Information:**
- Flag gaps: "⚠️ EPSS score not available for this CVE"
- Continue with available information
- Note limitations in enrichment

**Conflicting Information:**
- Flag discrepancies: "⚠️ CVSS score differs between sources"
- Prioritize NVD as authoritative
- Document all sources and discrepancies

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/tasks/`

**Test Standards:**
- Mock Perplexity MCP responses for unit tests
- Test with real CVEs for integration tests
- Validate query construction correctness
- Verify tool selection logic
- Test response parsing accuracy
- Validate source authority checking

**Test CVEs:**
- CVE-2024-52301 (Critical, recent)
- CVE-2023-44487 (High, HTTP/2 Rapid Reset)
- CVE-2024-12345 (Medium, hypothetical)
- CVE-2020-1234 (Low, old)

**Testing Requirements:**
- Verify correct tool selected for each severity
- Confirm all required fields extracted
- Validate source URLs are authoritative
- Test error handling for missing data
- Verify hallucination detection

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated after QA review_
