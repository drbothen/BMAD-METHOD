# Story 1.5: JIRA Enrichment Comment

## Status
Draft

## Story
**As a** Security Analyst agent,
**I want** to add structured enrichment as JIRA comment,
**so that** stakeholders can review findings in familiar JIRA interface.

## Acceptance Criteria
1. Agent adds comment using `mcp__atlassian__addCommentToJiraIssue`
2. Comment formatted in markdown with structured sections
3. Emojis used for visual scanning (âœ…/âŒ/âš ï¸)
4. Source citations as links
5. Timestamp and generator attribution included

## Tasks / Subtasks
- [ ] Implement JIRA comment posting task (AC: 1)
  - [ ] Create `tasks/post-enrichment-comment.md`
  - [ ] Use `mcp__atlassian__addCommentToJiraIssue` MCP tool
  - [ ] Convert enrichment document to JIRA comment format
  - [ ] Handle MCP errors (connection, auth, permission)
- [ ] Format enrichment for JIRA display (AC: 2, 3)
  - [ ] Convert markdown sections to JIRA-compatible format
  - [ ] Add visual hierarchy with headers and separators
  - [ ] Use emojis for quick scanning (see Dev Notes)
  - [ ] Ensure tables render correctly in JIRA
  - [ ] Add collapsible sections for long content
- [ ] Add authoritative source citations (AC: 4)
  - [ ] Convert all URLs to clickable links
  - [ ] Label each source with authority type (NVD, CISA, etc.)
  - [ ] Group sources by category (Vulnerability Details, Patches, Exploits)
  - [ ] Ensure links open in new tab/window
- [ ] Add enrichment metadata (AC: 5)
  - [ ] Timestamp: ISO 8601 format with timezone
  - [ ] Generator attribution: "ðŸ¤– Generated by BMAD-1898 Security Analyst Agent"
  - [ ] Agent version: Include expansion pack version
  - [ ] Perplexity tool used: (search/reason/deep_research)
  - [ ] Research duration: Time taken for enrichment

## Dev Notes

### JIRA Comment Posting
```
mcp__atlassian__addCommentToJiraIssue
  - issueKey: "AOD-1234"
  - cloudId: "934c63a0-0b96-4d46-b906-0f8c1c85c5d7"
  - comment: "{{enrichment_markdown}}"
```

### Emoji Usage Strategy
**Priority Indicators:**
- ðŸ”´ P1 - Critical (immediate action)
- ðŸŸ  P2 - High (urgent)
- ðŸŸ¡ P3 - Medium (important)
- ðŸ”µ P4 - Low (routine)
- âšª P5 - Info (awareness only)

**Status Indicators:**
- âœ… Patched version available
- âŒ No patch available
- âš ï¸ Workaround required
- ðŸš¨ Active exploitation detected
- ðŸŽ¯ Listed on CISA KEV
- ðŸ”“ Public exploit available
- ðŸ›¡ï¸ Compensating controls available

**Severity Indicators:**
- ðŸ”¥ Critical (CVSS 9.0-10.0)
- âš¡ High (CVSS 7.0-8.9)
- ðŸ“Š Medium (CVSS 4.0-6.9)
- ðŸ“‰ Low (CVSS 0.1-3.9)

### JIRA-Compatible Markdown Format
```markdown
---
## ðŸ”´ Security Enrichment: CVE-2024-1234
*Generated: 2025-11-06T14:30:00Z | Agent: BMAD-1898 v1.0 | Research Tool: deep_research*

---

### ðŸ“‹ Executive Summary
CVE-2024-1234 is a **Critical** severity Remote Code Execution affecting Apache Struts 2.0.0-2.5.32. CVSS: 9.8, EPSS: 0.85 (97th percentile), ðŸŽ¯ **CISA KEV Listed**. Priority: ðŸ”´ **P1** (Patch within 24 hours).

---

### ðŸ”¥ Severity Metrics
| Metric | Value | Context |
|--------|-------|---------|
| **CVSS** | 9.8 (Critical) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| **EPSS** | 0.85 (97th %ile) | High exploitation probability |
| **CISA KEV** | ðŸŽ¯ Listed (2024-11-01) | Active exploitation confirmed |
| **Exploit** | ðŸ”“ Public PoC | Exploit code publicly available |

---

### ðŸŽ¯ MITRE ATT&CK Mapping
**Tactics:** Initial Access, Execution
**Techniques:**
- **T1190** - Exploit Public-Facing Application
- **T1059** - Command and Scripting Interpreter

---

### ðŸ› ï¸ Remediation Guidance
âœ… **Patch Available:** Upgrade to Apache Struts 2.5.33+
âš ï¸ **Workaround:** Apply input validation rules at WAF
ðŸ›¡ï¸ **Compensating Controls:** Network segmentation, IDS signatures

---

### ðŸ“š Authoritative Sources
**Vulnerability Details:**
- [NIST NVD](https://nvd.nist.gov/vuln/detail/CVE-2024-1234)
- [CISA KEV](https://www.cisa.gov/known-exploited-vulnerabilities-catalog)

**Patches & Advisories:**
- [Apache Security Advisory](https://security.apache.org/CVE-2024-1234)

**Exploit Intelligence:**
- [FIRST EPSS](https://www.first.org/epss/)

---

ðŸ¤– *Generated by BMAD-1898 Security Analyst Agent v1.0*
*Research Duration: 8 minutes | Perplexity Tool: deep_research*
```

### JIRA Markdown Compatibility Notes
JIRA uses Atlassian Document Format (ADF), not standard markdown. Key differences:
- Headers: Use `h1.`, `h2.`, `h3.` instead of `#`, `##`, `###`
- Bold: Use `*bold*` instead of `**bold**`
- Links: Use `[text|url]` instead of `[text](url)`
- Tables: Use JIRA table syntax `||Header||` and `|Cell|`

**However:** The MCP tool may handle conversion. Test with actual JIRA Cloud instance.

### Error Handling
**Permission Denied:**
- Display: "âŒ Cannot add comment to AOD-1234. Check JIRA permissions."
- Action: Guide user to verify Atlassian MCP has comment permissions

**Comment Too Large:**
- JIRA comment limit: ~32KB
- Mitigation: Truncate sections, add "Full report available in attached file"
- Fallback: Save enrichment to local file, add summary comment only

**Network Error:**
- Display: "âŒ Cannot post comment. Check network connection."
- Action: Save enrichment locally, retry later

### Testing

**Test Location:** `expansion-packs/bmad-1898-engineering/tests/tasks/`

**Test Standards:**
- Unit tests: Mock MCP responses
- Integration tests: Post to real JIRA Cloud test instance
- Validate markdown formatting renders correctly
- Test emoji rendering in JIRA
- Verify links are clickable
- Test with long enrichments (>10KB)

**Test Cases:**
1. Standard enrichment (all sections)
2. Minimal enrichment (required fields only)
3. Long enrichment (test truncation)
4. Special characters in content
5. Multiple URLs and links

**Testing Requirements:**
- Create test JIRA ticket `AOD-TEST-COMMENT`
- Post test comment with all formatting
- Verify rendering in JIRA web interface
- Test on mobile JIRA app
- Validate all links work
- Confirm emojis display correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated during development_

### Debug Log References
_To be populated during development_

### Completion Notes List
_To be populated during development_

### File List
_To be populated during development_

## QA Results
_To be populated after QA review_
