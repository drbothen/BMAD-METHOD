# Post Enrichment Comment Task

## Purpose

Post a structured security enrichment document to a JIRA ticket as a formatted comment using the Atlassian MCP server. This task converts enrichment markdown into JIRA-compatible format with emojis, structured sections, and authoritative source citations.

## Prerequisites

- Atlassian MCP server configured and connected
- JIRA configuration in `config.yaml` with cloud_id
- Valid JIRA ticket ID to update
- Enrichment markdown document from Story 1.4 (created using `security-enrichment-tmpl.yaml`)

## Configuration Requirements

This task requires JIRA configuration in `expansion-packs/bmad-1898-engineering/config.yaml`:

```yaml
jira:
  cloud_id: 'YOUR_CLOUD_ID_HERE'
  project_key: 'YOUR_PROJECT_KEY'
```

## Task Steps

### Step 1: Load and Validate Configuration

1. Read the config file at `expansion-packs/bmad-1898-engineering/config.yaml`
2. Verify the `jira` section exists
3. Validate required fields are present:
   - `jira.cloud_id` - JIRA Cloud instance ID
   - `jira.project_key` - Project key (e.g., "AOD")

**If validation fails:**

- Missing config file: "‚ùå Config file not found at expansion-packs/bmad-1898-engineering/config.yaml"
- Missing required field: "‚ùå Missing required field: jira.cloud_id" (or specific field name)
- HALT and request user to configure

### Step 2: Validate Input Parameters

**Required inputs:**

- `ticket_id`: JIRA ticket ID (format: `{PROJECT_KEY}-{NUMBER}`)
- `enrichment_file_path`: Path to enrichment markdown document
- `cve_id`: CVE identifier for enrichment title
- `research_tool`: Perplexity tool used (search/reason/deep_research)
- `research_duration`: Time taken for enrichment (in minutes)

**Validation:**

1. Verify ticket_id matches format `[A-Z]+-\d+`
2. Verify enrichment file exists and is readable
3. Verify enrichment file is not empty
4. Verify enrichment file size is < 1MB (JIRA comment size safety threshold)

**If validation fails:**

- Invalid ticket ID: "‚ùå Invalid ticket ID format. Expected format: PROJECT-123"
- File not found: "‚ùå Enrichment file not found: {enrichment_file_path}"
- File empty: "‚ùå Enrichment file is empty. Cannot post empty comment."
- File too large: "‚ö†Ô∏è Enrichment file is {size}MB. JIRA may reject large comments. Proceeding with caution..."

### Step 3: Load Enrichment Document

1. Read the enrichment markdown file from `enrichment_file_path`
2. Parse the markdown sections to identify:
   - Executive Summary
   - Severity Metrics
   - Vulnerability Details
   - MITRE ATT&CK Mapping
   - Remediation Guidance
   - References
   - Enrichment Metadata

**If file read fails:**

- "‚ùå Cannot read enrichment file: {error_message}"
- HALT and request user to verify file path

### Step 4: Format Enrichment for JIRA Display

**Apply JIRA-compatible markdown formatting:**

1. **Add header section with visual hierarchy:**

   ```markdown
   ---
   ## üî¥ Security Enrichment: {cve_id}
   *Generated: {timestamp} | Agent: BMAD-1898 v{version} | Research Tool: {research_tool}*

   ---
   ```

   **Timestamp Format:** Use ISO 8601 with timezone: `YYYY-MM-DDTHH:mm:ssZ` (e.g., `2025-11-08T14:30:00Z`)

   **Version Source:** Read version from `expansion-packs/bmad-1898-engineering/config.yaml ‚Üí version` field

2. **Add emoji indicators to sections:**
   - Executive Summary: `üìã`
   - Severity Metrics: `üî•` (Critical), `‚ö°` (High), `üìä` (Medium), `üìâ` (Low)
   - Exploit Intelligence: `üö®`, `üîì`, `üéØ`
   - MITRE ATT&CK: `üéØ`
   - Remediation: `üõ†Ô∏è`
   - Compensating Controls: `üõ°Ô∏è`
   - Priority Assessment: Priority emojis (üî¥ P1, üü† P2, üü° P3, üîµ P4, ‚ö™ P5)
   - References: `üìö`

3. **Add status indicators:**
   - ‚úÖ Patched version available
   - ‚ùå No patch available
   - ‚ö†Ô∏è Workaround required
   - üö® Active exploitation detected
   - üéØ Listed on CISA KEV
   - üîì Public exploit available
   - üõ°Ô∏è Compensating controls available

4. **Format source citations:**
   - Convert all URLs to clickable markdown links
   - Group sources by category:
     - **Vulnerability Details:** NVD, CISA, CVE.org
     - **Patches & Advisories:** Vendor advisories, security bulletins
     - **Exploit Intelligence:** EPSS, ExploitDB, Metasploit
     - **Threat Intelligence:** MITRE ATT&CK, security blogs

5. **Add visual separators:**
   - Use `---` horizontal rules between major sections
   - Maintain markdown table formatting for metrics
   - Ensure tables have proper column alignment

6. **Add enrichment footer:**

   ```markdown
   ---

   ü§ñ _Generated by BMAD-1898 Security Analyst Agent v{version}_
   _Research Duration: {research_duration} minutes | Perplexity Tool: {research_tool}_
   ```

**Priority Emoji Mapping:**

Based on CVSS severity in Executive Summary, prepend section header with emoji:

- üî• Critical (CVSS 9.0-10.0)
- ‚ö° High (CVSS 7.0-8.9)
- üìä Medium (CVSS 4.0-6.9)
- üìâ Low (CVSS 0.1-3.9)

**Character Length Check:**

- Count final formatted comment character length
- If > 100,000 characters: Display warning "‚ö†Ô∏è Comment is {length} characters. May need truncation if JIRA rejects."

### Step 5: Post Comment to JIRA

Use the MCP tool to post the formatted comment:

```
mcp__atlassian__addCommentToJiraIssue
  issueKey: "{ticket_id}"
  cloudId: "{from_config.jira.cloud_id}"
  comment: "{formatted_enrichment_markdown}"
```

**Success Response:**

- "‚úÖ Posted enrichment comment to {ticket_id}"
- Display comment preview (first 200 characters)
- Provide JIRA link: "View in JIRA: https://{jira_domain}/browse/{ticket_id}"

**JIRA Domain Note:** The `{jira_domain}` is your JIRA Cloud instance URL (e.g., `yourcompany.atlassian.net`). This should be derived from your JIRA configuration or you can check if the MCP response includes a direct link to the comment/issue which can be used instead.

### Step 6: Error Handling and Recovery

**Permission Denied (403):**

- Display: "‚ùå Cannot add comment to {ticket_id}. Check JIRA permissions."
- Action: "Verify the Atlassian MCP server has 'Add Comments' permission for this project."
- HALT and request user to verify permissions

**Comment Too Large (400 - Request Entity Too Large):**

- Display: "‚ùå Comment rejected by JIRA (too large: {size} characters)"
- Action: "Implementing truncation strategy..."
- Truncation Strategy:
  1. Remove Enrichment Metadata section (least critical)
  2. Truncate References section to top 5 sources
  3. Truncate MITRE ATT&CK section (keep only tactics)
  4. If still too large, save full enrichment to local file and post summary comment only
- Retry with truncated content
- If truncated version posts successfully: "‚úÖ Posted truncated enrichment comment. Full enrichment saved to: {local_file_path}"

**Network Error (Connection refused, timeout):**

- Display: "‚ùå Cannot post comment. Check network connection."
- Action: "Saving enrichment locally for retry..."
- Save enrichment to: `.ai/enrichment-{cve_id}-{timestamp}.md`
- Display: "üíæ Enrichment saved to {local_file_path}. Retry posting when connection is restored."
- HALT

**Rate Limit Exceeded (429):**

- Display: "‚ö†Ô∏è JIRA API rate limit exceeded. Retrying with exponential backoff..."
- Retry Strategy:
  1. Attempt 1: Wait 60 seconds, retry
  2. Attempt 2: Wait 120 seconds, retry
  3. Attempt 3: Wait 240 seconds, retry
  4. After 3 failures: Save enrichment locally
- Display retry status: "‚è≥ Retry attempt {n}/3 - waiting {seconds}s..."
- If all retries fail: "‚ùå Rate limit persists after 3 attempts. Enrichment saved to {local_file_path}"
- HALT

**Invalid Ticket ID (404):**

- Display: "‚ùå Ticket {ticket_id} not found. Verify ticket ID and try again."
- HALT

**Authentication Failure (401):**

- Display: "‚ùå JIRA authentication failed. Check Atlassian MCP configuration."
- Action: "Verify MCP server credentials are valid and not expired."
- HALT

**Other Errors:**

- Display: "‚ùå Error posting comment: {error_type} - {error_message}"
- Action: "Saving enrichment locally for manual posting..."
- Save enrichment to: `.ai/enrichment-{cve_id}-{timestamp}.md`
- Display: "üíæ Enrichment saved to {local_file_path}. Please post manually or retry."
- HALT

### Step 7: Verify Comment Posted (Optional Validation)

**If user requests validation:**

1. Read ticket again using `mcp__atlassian__getJiraIssue`
2. Check comments array for newly posted comment
3. Verify comment content matches posted enrichment
4. Display: "‚úÖ Verified: Comment successfully posted to {ticket_id}"

**If verification fails:**

- Display: "‚ö†Ô∏è Cannot verify comment posting. Check JIRA manually: https://{jira_domain}/browse/{ticket_id}"

## Output

**On success:**

- JIRA comment posted to ticket
- Confirmation message with ticket link
- Comment preview

**On failure:**

- Error message with specific failure reason
- Local file path for saved enrichment
- Retry instructions or manual posting guidance

## Example Usage

**Input:**

```yaml
ticket_id: AOD-1234
enrichment_file_path: .ai/enrichment-CVE-2024-1234.md
cve_id: CVE-2024-1234
research_tool: deep_research
research_duration: 8
```

**Output:**

```
‚úÖ Posted enrichment comment to AOD-1234

Preview:
---
## üî¥ Security Enrichment: CVE-2024-1234
*Generated: 2025-11-08T14:30:00Z | Agent: BMAD-1898 v1.0 | Research Tool: deep_research*
...

View in JIRA: https://your-domain.atlassian.net/browse/AOD-1234
```

## Notes

- **Markdown Compatibility:** JIRA uses Atlassian Document Format (ADF). The MCP tool `mcp__atlassian__addCommentToJiraIssue` handles markdown-to-ADF conversion automatically. If formatting issues occur during testing, the task may need to implement manual ADF conversion.

- **Emoji Rendering:** Emoji display in JIRA comments depends on JIRA Cloud version and browser support. If emojis don't render correctly during testing, implement fallback to text indicators (e.g., `[P1]`, `[CRITICAL]`, `[PATCHED]`).

- **Comment Size Limits:** JIRA API comment size limits vary by instance configuration. The 100,000 character threshold is a conservative safety limit. Actual limits may be higher or lower.

- **Retry Logic:** Exponential backoff for rate limiting prevents overwhelming the JIRA API while giving sufficient time for rate limits to reset.

- **Local File Saving:** When errors prevent immediate posting, enrichments are saved to `.ai/enrichment-{cve_id}-{timestamp}.md` for manual posting or retry. This ensures no research is lost due to API failures.
