# <!-- Powered by BMAD™ Core -->

# create-neo4j-relationship

Create [:CONCEPTUALLY_RELATED] relationship in Neo4j with bi-temporal metadata (if enabled).

## Purpose

Create a Neo4j graph relationship between two note nodes with bi-temporal tracking (valid_time and transaction_time). Implements graceful degradation if Neo4j is disabled or unavailable.

## Prerequisites

- Neo4j Graphiti MCP configured (optional)
- Config file at expansion-packs/bmad-obsidian-2nd-brain/config.yaml
- relationship-record-tmpl.yaml for Cypher query template
- Note nodes already exist in Neo4j (or will be created on-demand)

## Inputs

- **source_note_path** (string, required): Path to source note
- **target_note_path** (string, required): Path to target note
- **link_id** (string, required): Unique UUID for this link
- **link_type** (string, required): One of 7 relationship types
- **strength** (float, required): Link strength 0.0-1.0
- **discovered_at** (string, required): ISO 8601 timestamp
- **context** (string, required): Context sentence explaining relationship

## Outputs

```yaml
neo4j_relationship_result:
  success: true|false
  neo4j_enabled: true|false
  relationship_id: 'rel-abc123'|null
  skipped: false
  error: null
```

## Procedure

### Step 1: Check Neo4j Configuration

```javascript
// Read config file
try {
  config = read_yaml('expansion-packs/bmad-obsidian-2nd-brain/config.yaml')
  neo4j_enabled = config.neo4j?.enabled || false
} catch (error) {
  // Config not found or invalid → default to disabled
  neo4j_enabled = false
  log_warning('Config file not found, Neo4j disabled by default')
}

// If disabled, skip gracefully
if (!neo4j_enabled) {
  return {
    success: true,  // Not a failure - intentionally skipped
    neo4j_enabled: false,
    skipped: true,
    message: 'Neo4j disabled in config, skipping relationship creation'
  }
}
```

### Step 2: Prepare Cypher Query

```javascript
// Load relationship-record-tmpl.yaml
cypher_template = load_template('relationship-record-tmpl.yaml')

// Prepare parameters (prevents Cypher injection)
params = {
  source_path: source_note_path,
  target_path: target_note_path,
  link_id: link_id,
  link_type: link_type,
  strength: strength,
  discovered_at: discovered_at,
  context: context,
  valid_time_start: discovered_at  // Same as discovered_at typically
}

// Parameterized Cypher query
cypher_query = `
MATCH (source:Note {path: $source_path})
MATCH (target:Note {path: $target_path})
CREATE (source)-[r:CONCEPTUALLY_RELATED {
  link_id: $link_id,
  link_type: $link_type,
  strength: $strength,
  discovered_at: datetime($discovered_at),
  context: $context,
  valid_time_start: datetime($valid_time_start),
  transaction_time: datetime()
}]->(target)
RETURN r
`
```

### Step 3: Execute Cypher Query

```javascript
try {
  // Call Graphiti MCP
  result = graphiti_mcp.execute_cypher(cypher_query, params)

  return {
    success: true,
    neo4j_enabled: true,
    relationship_id: result.r.id,
    properties: {
      link_id: link_id,
      link_type: link_type,
      strength: strength,
      discovered_at: discovered_at,
      valid_time_start: discovered_at,
      transaction_time: result.r.transaction_time
    },
    skipped: false,
    error: null
  }

} catch (error) {
  // Handle specific errors
  if (error.code == 'CONNECTION_FAILED') {
    // Neo4j unavailable → graceful degradation
    log_warning('Neo4j connection failed, continuing with Obsidian-only mode')
    return {
      success: true,  // Not a hard failure
      neo4j_enabled: true,
      skipped: true,
      error: 'Neo4j connection failed, temporal graph not updated',
      fallback: 'Obsidian-only mode'
    }
  } else if (error.code == 'NODE_NOT_FOUND') {
    // Note nodes don't exist → try to create them first
    try {
      create_note_nodes_if_missing(source_note_path, target_note_path)
      // Retry relationship creation
      result = graphiti_mcp.execute_cypher(cypher_query, params)
      return {success: true, relationship_id: result.r.id, ...}
    } catch (retry_error) {
      return {
        success: false,
        error: `Failed to create relationship: ${retry_error.message}`
      }
    }
  } else {
    // Other errors
    return {
      success: false,
      neo4j_enabled: true,
      error: `Neo4j query failed: ${error.message}`
    }
  }
}
```

### Step 4: Bi-Temporal Metadata

**Valid Time vs Transaction Time:**

- **valid_time_start**: When the relationship became true in the domain (when link was discovered)
- **transaction_time**: When the relationship was recorded in the database (auto-generated by Neo4j)

This enables temporal queries:
- "What relationships existed on 2025-11-01?" → Query valid_time
- "What did we know as of 2025-11-01?" → Query transaction_time

## Examples

### Example 1: Successful Creation (Neo4j Enabled)

**Input:**
```yaml
source_note_path: 'atomic/argument-01-spaced-repetition.md'
target_note_path: 'atomic/phenomenon-01-forgetting-curve.md'
link_id: 'c3f5a921-4b2e-4d1a-9e8f-7c3d2b1a0f4e'
link_type: 'supports'
strength: 0.82
discovered_at: '2025-11-05T14:30:00Z'
context: 'The forgetting curve provides empirical evidence'
```

**Output:**
```yaml
success: true
neo4j_enabled: true
relationship_id: 'rel-abc123'
properties:
  link_id: 'c3f5a921-4b2e-4d1a-9e8f-7c3d2b1a0f4e'
  link_type: 'supports'
  strength: 0.82
  discovered_at: '2025-11-05T14:30:00Z'
  valid_time_start: '2025-11-05T14:30:00Z'
  transaction_time: '2025-11-05T14:30:15Z'
skipped: false
error: null
```

### Example 2: Neo4j Disabled (Graceful Skip)

**Input:** (same as above, but config.neo4j.enabled = false)

**Output:**
```yaml
success: true
neo4j_enabled: false
relationship_id: null
skipped: true
message: 'Neo4j disabled in config, skipping relationship creation'
```

### Example 3: Connection Failed (Graceful Degradation)

**Input:** (Neo4j enabled but connection fails)

**Output:**
```yaml
success: true
neo4j_enabled: true
relationship_id: null
skipped: true
error: 'Neo4j connection failed, temporal graph not updated'
fallback: 'Obsidian-only mode'
```

## Error Handling

- **Config not found:** Default to disabled, skip gracefully
- **Neo4j unavailable:** Log warning, continue in Obsidian-only mode
- **Node not found:** Create note nodes, retry relationship creation
- **Query error:** Return error, don't fail hard

## Integration Points

**Called by:** *create-links, *create-link, *accept-suggestion
**Depends on:** config.yaml, relationship-record-tmpl.yaml
**Calls:** Graphiti MCP execute_cypher()
